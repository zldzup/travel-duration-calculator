<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>图↔Base64</title>
<style>
body{font:13px/1.4 ui-monospace,monospace;margin:0;padding:15px;background:#fff;color:#222}
h3{margin:0 0 6px;font-size:14px;font-weight:600}
textarea{width:100%;height:60px;font:inherit;border:1px solid #bbb;border-radius:3px;resize:vertical;padding:4px;box-sizing:border-box}
img{max-width:100%;max-height:120px;border:1px dashed #999;border-radius:3px;margin-top:4px;display:block}
button{padding:4px 8px;font:inherit;border:1px solid #bbb;border-radius:3px;background:#f6f6f6;cursor:pointer}
button:hover{background:#e6e6e6}
.copy{background:#d1e7fd;border-color:#9dc7fb}
.copy:hover{background:#c0dbf9}
.info{color:#555;font-size:12px;margin-top:3px}
.card{margin-bottom:12px}
#hist{max-height:180px;overflow:auto;border:1px solid #ddd;border-radius:3px;padding:4px;background:#fafafa}
.h-item{display:flex;align-items:center;padding:3px 2px;border-radius:2px;cursor:pointer}
.h-item:hover{background:#e0e0e0}
.h-item img{width:40px;height:40px;object-fit:cover;border-radius:2px;margin-right:6px;flex-shrink:0}
.h-item div{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
</style>
</head>
<body>

<div class="card">
  <h3>图→Base64</h3>
  <input type="file" id="f" accept="image/*">
  <div id="info1" class="info"></div>
  <img id="pic1">
</div>

<div class="card">
  <h3>Base64→图</h3>
  <textarea id="b64" placeholder="粘贴Base64（可含前缀）"></textarea>
  <button id="go">解析</button>
  <div id="info2" class="info"></div>
  <img id="pic2">
</div>

<div class="card">
  <h3>结果</h3>
  <textarea id="out" readonly></textarea>
  <button id="cpy" class="copy">复制</button>
</div>

<div class="card">
  <h3>历史 <button id="clrHist" style="float:right;font-size:11px">清空</button></h3>
  <div id="hist"></div>
</div>

<script>
const $=q=>document.getElementById(q);
const fmt=b=>b<1024?b+'B':b<1048576?(b/1024).toFixed(1)+'KB':(b/1048576).toFixed(1)+'MB';

const H_KEY='imgb64hist';
let hist=JSON.parse(localStorage.getItem(H_KEY)||'[]');

function saveHist(){localStorage.setItem(H_KEY,JSON.stringify(hist)); renderHist();}

function renderHist(){
  const box=$('hist');
  box.innerHTML='';
  hist.forEach((it,idx)=>{
    const div=document.createElement('div');
    div.className='h-item';
    div.innerHTML=`
      <img src="${it.thumb}">
      <div>${it.time} ${it.w}×${it.h} ${it.size}</div>`;
    div.onclick=()=>{
      $('out').value=it.b64;
      $('b64').value=it.b64;
      const img=new Image();
      img.onload=()=>{
        $('pic2').src=img.src;
        $('info2').textContent=`${img.naturalWidth}×${img.naturalHeight}`;
      };
      img.src=it.b64;
    };
    box.appendChild(div);
  });
}

function addHist(b64,w,h,size){
  const thumb=makeThumb(b64,80);   // 80px 宽的小图即可
  hist.unshift({b64,thumb,w,h,size,time:new Date().toLocaleString('zh-CN')});
  if(hist.length>30) hist.pop();
  saveHist();
}

/* 生成缩略图（同步返回 dataURL） */
function makeThumb(src,newW){
  const img=new Image();
  img.src=src;
  if(!img.complete||img.naturalWidth===0) return src; // 降级用原图
  const scale=newW/img.naturalWidth;
  const canvas=document.createElement('canvas');
  canvas.width=newW;
  canvas.height=img.naturalHeight*scale;
  canvas.getContext('2d').drawImage(img,0,0,canvas.width,canvas.height);
  return canvas.toDataURL('image/jpeg',0.7); // 缩略图用 70% 质量
}

$('f').onchange=e=>{
  const file=e.target.files[0];
  if(!file||!file.type.startsWith('image/'))return;
  const img=new Image(),url=URL.createObjectURL(file);
  img.onload=()=>{
    const r=new FileReader();
    r.onload=()=>{
      const b64=r.result;
      $('pic1').src=b64;
      $('out').value=b64;
      $('info1').textContent=`${img.naturalWidth}×${img.naturalHeight} ${fmt(file.size)}`;
      addHist(b64,img.naturalWidth,img.naturalHeight,fmt(file.size));
      URL.revokeObjectURL(url);
    };
    r.readAsDataURL(file);
  };
  img.src=url;
};

$('go').onclick=()=>{
  const v=$('b64').value.trim();
  if(!v)return;
  const src=/^data:image/.test(v)?v:'data:image/png;base64,'+v;
  const img=new Image();
  img.onload=()=>{
    $('pic2').src=src;
    $('out').value=src;
    const bytes=new Blob([src]).size;
    $('info2').textContent=`${img.naturalWidth}×${img.naturalHeight} 约${fmt(bytes)}`;
    addHist(src,img.naturalWidth,img.naturalHeight,`约${fmt(bytes)}`);
  };
  img.onerror=()=>alert('Base64错误');
  img.src=src;
};

$('cpy').onclick=()=>{ $('out').select();document.execCommand('copy'); };
$('clrHist').onclick=()=>{ if(confirm('确定清空历史？')){hist=[];saveHist();} };

renderHist();
</script>
</body>
</html>
