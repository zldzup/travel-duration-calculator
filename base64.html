<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>图↔Base64 小工具</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="theme-color" content="#ffffff">
<!-- 离线用 PWA -->
<link rel="manifest" href="data:application/json,{
  "name":"图Base64工具",
  "short_name":"图Base64",
  "display":"standalone",
  "background_color":"#fff",
  "theme_color":"#fff",
  "scope":".",
  "start_url":"."
}">
<style>
body{font:13px/1.4 ui-monospace,monospace;margin:0;padding:15px;background:#fff;color:#222}
h3{margin:0 0 6px;font-size:14px;font-weight:600}
textarea{width:100%;height:60px;font:inherit;border:1px solid #bbb;border-radius:3px;resize:vertical;padding:4px;box-sizing:border-box}
img{max-width:100%;max-height:120px;border:1px dashed #999;border-radius:3px;margin-top:4px;display:block;cursor:zoom-in}
button{padding:4px 8px;font:inherit;border:1px solid #bbb;border-radius:3px;background:#f6f6f6;cursor:pointer;margin-right:6px}
button:hover{background:#e6e6e6}
.copy{background:#d1e7fd;border-color:#9dc7fb}
.copy:hover{background:#c0dbf9}
.info{color:#555;font-size:12px;margin-top:3px}
.card{margin-bottom:12px}
#hist{max-height:180px;overflow:auto;border:1px solid #ddd;border-radius:3px;padding:4px;background:#fafafa}
.h-item{display:flex;align-items:center;padding:3px 2px;border-radius:2px;cursor:pointer}
.h-item:hover{background:#e0e0e0}
.h-item img{width:40px;height:40px;object-fit:cover;border-radius:2px;margin-right:6px;flex-shrink:0}
.h-item div{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

/* 原图弹层 */
#overlay{position:fixed;inset:0;background:rgba(0,0,0,.75);display:flex;align-items:center;justify-content:center;cursor:zoom-out;z-index:999;overflow:auto}
#overlay img{max-width:none;max-height:none;border:none;box-shadow:0 0 20px #000;cursor:default;margin:auto}
#overlay .close{position:absolute;top:10px;right:10px;font-size:24px;color:#fff;background:rgba(0,0,0,.5);border-radius:50%;width:36px;height:36px;display:flex;align-items:center;justify-content:center;line-height:1}
</style>
</head>
<body>

<div class="card">
  <h3>图→Base64</h3>
  <input type="file" id="f" accept="image/*">
  <div id="info1" class="info"></div>
  <img id="pic1" style="display:none">
</div>

<div class="card">
  <h3>Base64→图</h3>
  <textarea id="b64" placeholder="粘贴Base64（可含前缀）"></textarea>
  <button id="go">解析</button>
  <div id="info2" class="info"></div>
  <img id="pic2" style="display:none">
</div>

<div class="card">
  <h3>结果</h3>
  <textarea id="out" readonly></textarea>
  <div style="margin-top:6px">
    <button id="cpy" class="copy">复制</button>
    <button id="md">复制 Markdown</button>
    <button id="exportTxt">导出txt</button>
  </div>
</div>

<div class="card">
  <h3>历史 <button id="clrHist" style="float:right;font-size:11px">清空</button></h3>
  <div id="hist"></div>
</div>

<!-- 原图弹层 -->
<div id="overlay" style="display:none">
  <span class="close" id="closeOverlay">×</span>
  <img id="fullImg" src="">
</div>

<script>
// 基础工具
const $=q=>document.getElementById(q);
const fmt=b=>b<1024?b+'B':b<1048576?(b/1024).toFixed(1)+'KB':(b/1048576).toFixed(1)+'MB';
const H_KEY='imgb64hist';
let hist=JSON.parse(localStorage.getItem(H_KEY)||'[]');

function saveHist(){localStorage.setItem(H_KEY,JSON.stringify(hist)); renderHist();}
function renderHist(){
  const box=$('hist');
  box.innerHTML='';
  hist.forEach(it=>{
    const div=document.createElement('div');
    div.className='h-item';
    div.innerHTML=`<img src="${it.thumb}"><div>${it.time} ${it.w}×${it.h} ${it.size}</div>`;
    div.onclick=()=>fillResult(it.b64,it.w,it.h);
    box.appendChild(div);
  });
}
function fillResult(b64,w,h){
  $('out').value=b64;
  $('b64').value=b64;
  const img=new Image();
  img.onload=()=>{$('pic2').src=img.src; $('pic2').style.display='block'; $('info2').textContent=`${w}×${h}`;};
  img.src=b64;
}
function addHist(b64,w,h,size){
  const thumb=makeThumb(b64,80);
  hist.unshift({b64,thumb,w,h,size,time:new Date().toLocaleString('zh-CN')});
  if(hist.length>30)hist.pop();
  saveHist();
}
function makeThumb(src,newW){
  const img=new Image(); img.src=src;
  if(!img.complete||img.naturalWidth===0)return src;
  const canvas=document.createElement('canvas');
  canvas.width=newW; canvas.height=img.naturalHeight*(newW/img.naturalWidth);
  canvas.getContext('2d').drawImage(img,0,0,canvas.width,canvas.height);
  return canvas.toDataURL('image/jpeg',0.7);
}

// 文件上传
$('f').onchange=e=>{
  const file=e.target.files[0];
  if(!file||!file.type.startsWith('image/'))return;
  const img=new Image(),url=URL.createObjectURL(file);
  img.onload=()=>{
    const r=new FileReader();
    r.onload=()=>{
      const b64=r.result;
      $('pic1').src=b64; $('pic1').style.display='block';
      $('out').value=b64;
      $('info1').textContent=`${img.naturalWidth}×${img.naturalHeight} ${fmt(file.size)}`;
      addHist(b64,img.naturalWidth,img.naturalHeight,fmt(file.size));
      URL.revokeObjectURL(url);
    };
    r.readAsDataURL(file);
  };
  img.src=url;
};

// Base64 解析
$('go').onclick=()=>{
  const v=$('b64').value.trim();
  if(!v)return;
  const src=/^data:image/.test(v)?v:'data:image/png;base64,'+v;
  const img=new Image();
  img.onload=()=>{
    $('pic2').src=src; $('pic2').style.display='block';
    $('out').value=src;
    const bytes=new Blob([src]).size;
    $('info2').textContent=`${img.naturalWidth}×${img.naturalHeight} 约${fmt(bytes)}`;
    addHist(src,img.naturalWidth,img.naturalHeight,`约${fmt(bytes)}`);
  };
  img.onerror=()=>alert('Base64错误');
  img.src=src;
};

// 复制 & 导出
$('cpy').onclick=()=>{$('out').select();document.execCommand('copy');};
$('clrHist').onclick=()=>{if(confirm('确定清空历史？')){hist=[];saveHist();}};
$('exportTxt').onclick=()=>{
  const txt=$('out').value;
  if(!txt){alert('结果为空');return;}
  const blob=new Blob([txt],{type:'text/plain'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url; a.download='base64.txt'; a.click();
  URL.revokeObjectURL(url);
};

// C. Markdown 复制
$('md').onclick=()=>{
  const src=$('out').value;
  if(!src){alert('结果为空');return;}
  const md=`![img](${src})`;
  navigator.clipboard.writeText(md).then(()=>{
    $('md').textContent='已复制Markdown';
    setTimeout(()=>$('md').textContent='复制 Markdown',1200);
  });
};

// 原图弹层
function viewOriginal(src){
  $('fullImg').src=src;
  $('overlay').style.display='flex';
}
function closeOverlay(){
  $('overlay').style.display='none';
  $('fullImg').src='';
}
$('overlay').onclick=e=>{if(e.target===$('overlay'))closeOverlay();};
$('closeOverlay').onclick=closeOverlay;
$('pic1').onclick=()=>viewOriginal($('pic1').src);
$('pic2').onclick=()=>viewOriginal($('pic2').src);

// A. 拖放上传
['dragenter','dragover','drop'].forEach(evt=>
  window.addEventListener(evt,e=>e.preventDefault(),false));
window.addEventListener('drop',e=>{
  const f=[...e.dataTransfer.files].find(x=>x.type.startsWith('image/'));
  if(f){
    const dt=new DataTransfer(); dt.items.add(f);
    $('f').files=dt.files;
    $('f').dispatchEvent(new Event('change'));
  }
});

// B. 剪贴板粘贴图片
window.addEventListener('paste',e=>{
  const items=[...(e.clipboardData||e.originalEvent.clipboardData).items];
  const imgItem=items.find(x=>x.type.startsWith('image/'));
  if(!imgItem)return;
  const file=imgItem.getAsFile();
  const dt=new DataTransfer(); dt.items.add(file);
  $('f').files=dt.files;
  $('f').dispatchEvent(new Event('change'));
});

// 离线 PWA：注册极简 ServiceWorker（缓存自身）
if('serviceWorker' in navigator){
  const sw=`
    self.addEventListener('install',e=>{
      e.waitUntil(caches.open('v1').then(c=>c.addAll(['./'])));
    });
    self.addEventListener('fetch',e=>{
      e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request)));
    });
  `.trim();
  const blob = new Blob([sw],{type:'application/javascript'});
  const url = URL.createObjectURL(blob);
  navigator.serviceWorker.register(url).then(()=>URL.revokeObjectURL(url));
}

renderHist();
</script>
</body>
</html>
