<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“Šç•™å­¦æ—¶é—´è¡¨</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 5px;
            background-color: #f8f9fa;
        }
        .container {
            max-width: 380px;
            margin: 0 auto;
            padding: 30px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: #fff;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        .form-group {
            margin-bottom: 12px;
        }
        label {
            display: block;
            font-size: 0.85em;
            margin-bottom: 3px;
            color: #333;
        }
        input[type="month"], select, input[type="text"] {
            width: 100%;
            padding: 8px;
            font-size: 0.85em;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 3px;
            background-color: #f9f9f9;
        }
        button {
            width: 100%;
            padding: 10px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 1em;
            margin-bottom: 10px;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        button:hover:not(:disabled) {
            background-color: #218838;
        }
        #user-data {
            display: none;
            margin-top: 20px;
        }
        #user-data h4 {
            color: #333;
        }
        #user-data ul {
            list-style-type: none;
            padding: 0;
        }
        #user-data li {
            background: #f9f9f9;
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 3px;
            border: 1px solid #ccc;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
        }
        .school-button {
            margin-top: 10px;
            background-color: #007bff;
            border: none;
            color: white;
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 3px;
        }
        .school-button:hover {
            background-color: #0056b3;
        }

        /* åå¸é€šçŸ¥çš„æ ·å¼ */
        #toast {
            visibility: hidden;
            min-width: 250px;
            margin-left: -125px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 2px;
            padding: 16px;
            position: fixed;
            z-index: 1;
            left: 50%;
            bottom: 30px;
            font-size: 17px;
            transition: visibility 0s, opacity 0.5s ease-in-out;
            opacity: 0;
        }
        #toast.show {
            visibility: visible;
            opacity: 1;
        }
    </style>
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-storage.js"></script>
</head>
<body>
    <div class="container">
        <h3>ç•™å­¦æ—¶é—´è¡¨å‚è€ƒ</h3>
        <div class="form-group">
            <label for="degree">å­¦å†</label>
            <select id="degree" name="degree" required>
                <option value="æœªå¡«å†™">è¯·é€‰æ‹©</option>
                <option value="æœ¬ç§‘">æœ¬ç§‘</option>
                <option value="ä¸“å‡æœ¬">ä¸“å‡æœ¬</option>
                <option value="ç¡•å£«">ç¡•å£«</option>
                <option value="åšå£«">åšå£«</option>
            </select>
        </div>
        <div class="form-group">
            <label for="school-name">å­¦æ ¡åç§°</label>
            <select id="school-name-select" name="school-name-select">
                <option value="">é€‰æ‹©å­¦æ ¡</option>
                <option value="ç­é¢‚å¾·çš‡å®¶å¤§å­¦">ç­é¢‚å¾·çš‡å®¶å¤§å­¦</option>
                <option value="æ›¼è°·åæ­¦é‡Œå¤§å­¦">æ›¼è°·åæ­¦é‡Œå¤§å­¦</option>
                <option value="æ›¼è°·çš‡å®¶ç†å·¥å¤§å­¦">æ›¼è°·çš‡å®¶ç†å·¥å¤§å­¦</option>
                <option value="ä¸œæ–¹çš‡å®¶ç†å·¥å¤§å­¦">ä¸œæ–¹çš‡å®¶ç†å·¥å¤§å­¦</option>
                <option value="ç„ç´ å—å¡”çš‡å®¶å¤§å­¦">ç„ç´ å—å¡”çš‡å®¶å¤§å­¦</option>
                <option value="åšä»å¤§å­¦">åšä»å¤§å­¦</option>
                <option value="æ ¼ä¹å¤§å­¦">æ ¼ä¹å¤§å­¦</option>
                <option value="æ˜“ä¸‰ä»“å¤§å­¦">æ˜“ä¸‰ä»“å¤§å­¦</option>
                <option value="å…°å®å¤§å­¦">å…°å®å¤§å­¦</option>
                <option value="æœ±æ‹‰éš†åŠŸå¤§å­¦">æœ±æ‹‰éš†åŠŸå¤§å­¦</option>
                <option value="ç›å¸Œéš†å¤§å­¦">ç›å¸Œéš†å¤§å­¦</option>
                <option value="æ¸…è¿ˆå¤§å­¦">æ¸…è¿ˆå¤§å­¦</option>
                <option value="å›½ç«‹å‘å±•ç®¡ç†å­¦é™¢">å›½ç«‹å‘å±•ç®¡ç†å­¦é™¢</option>
                <option value="custom">å…¶ä»–å­¦æ ¡</option>
            </select>
            <input type="text" id="school-name" name="school-name" style="margin-top: 10px; display: none;" placeholder="è¯·è¾“å…¥å­¦æ ¡åç§°">
        </div>
        <form id="study-duration-form">
            <div class="form-group">
                <label for="start-date">1. å…¥å­¦æ—¶é—´</label>
                <input type="month" id="start-date" name="start-date" required>
            </div>
            <div class="form-group">
                <label for="end-date">2. è¯¾ç¨‹ç»“æŸæ—¶é—´:æœ€åä¸€é—¨</label>
                <input type="month" id="end-date" name="end-date">
            </div>
            <div class="form-group">
                <label for="apply-graduation-date">3. ç”³è¯·æ¯•ä¸šæ—¶é—´</label>
                <input type="month" id="apply-graduation-date" name="apply-graduation-date">
            </div>
            <div class="form-group">
                <label for="board-date">4. è‘£äº‹ä¼šä¸Šä¼šæ—¶é—´</label>
                <input type="month" id="board-date" name="board-date">
            </div>
            <div class="form-group">
                <label for="graduation-certificate-date">5. æ¯•ä¸šè¯ä¹¦æ˜¾ç¤ºæ—¶é—´</label>
                <input type="month" id="graduation-certificate-date" name="graduation-certificate-date">
            </div>
            <div class="form-group">
                <label for="submit-certification-date">6. æäº¤ç•™æœç”³è¯·æ—¶é—´</label>
                <input type="month" id="submit-certification-date" name="submit-certification-date">
            </div>
            <div class="form-group">
                <label for="receive-certification-date">7. æ‹¿åˆ°ç•™æœè¯ä¹¦æ—¶é—´</label>
                <input type="month" id="receive-certification-date" name="receive-certification-date">
            </div>
            <div class="form-group">
                <label for="overseas-study-duration">8. å¢ƒå¤–å­¦ä¹ æ—¶é•¿ï¼ˆå¤©ï¼‰</label>
                <input type="text" id="overseas-study-duration" name="overseas-study-duration">
            </div>
            <button type="submit" id="submit-btn" disabled>æäº¤(è¯·å¡«å†™3é¡¹:å­¦å†ã€å­¦æ ¡ã€å…¥å­¦æ—¶é—´)</button>
        </form>
        <hr>
        <div id="user-data">
            <h4>å…¶ä»–ç”¨æˆ·ä¸Šä¼ çš„ä¿¡æ¯ï¼š</h4>
            <ul id="user-data-list"></ul>
        </div>
        <button id="view-other-data" disabled>æŸ¥çœ‹å…¶ä»–ç”¨æˆ·ä¸Šä¼ çš„ä¿¡æ¯</button>
        <p>å¢ƒå¤–å­¦ä¹ æ—¶é•¿è®¡ç®—å™¨ï¼ˆå°å·¥å…·ï¼‰ğŸ§®<a href="https://zldzup.github.io/travel-duration-calculator/calculator.html">ç‚¹å‡»æŸ¥çœ‹</a></p>
    </div>
    <div id="toast">æ•°æ®æäº¤æˆåŠŸï¼</div>

    <script>
        // Firebaseé…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyCGQ1ZAhfD7pky4In-rXcStZPSTxe-fyzE",
            authDomain: "travel-duration-calculat-b511e.firebaseapp.com",
            projectId: "travel-duration-calculat-b511e",
            storageBucket: "travel-duration-calculat-b511e.appspot.com",
            messagingSenderId: "745521797119",
            appId: "1:745521797119:web:4258b69db047193eda79ca"
        };
        // åˆå§‹åŒ–Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const form = document.getElementById('study-duration-form');
        const viewOtherDataButton = document.getElementById('view-other-data');
        const userDataContainer = document.getElementById('user-data');
        const userDataList = document.getElementById('user-data-list');
        const submitButton = document.getElementById('submit-btn');
        const schoolNameSelect = document.getElementById('school-name-select');
        const schoolNameInput = document.getElementById('school-name');

        // åå¸é€šçŸ¥æ˜¾ç¤ºå‡½æ•°
        function showToast(message) {
            const toast = document.getElementById("toast");
            toast.innerText = message;
            toast.className = "show";
            setTimeout(() => {
                toast.className = toast.className.replace("show", "");
            }, 3000);
        }

        // å¯ç”¨è‡ªå®šä¹‰å­¦æ ¡åç§°è¾“å…¥æ¡†
        schoolNameSelect.addEventListener('change', function() {
            if (this.value === 'custom') {
                schoolNameInput.style.display = 'block';
                schoolNameInput.required = true;
            } else {
                schoolNameInput.style.display = 'none';
                schoolNameInput.required = false;
                schoolNameInput.value = '';
            }
            toggleSubmitButton();
        });

        // å¯ç”¨æäº¤æŒ‰é’®ï¼ˆå½“å…¥å­¦æ—¶é—´å’Œå­¦æ ¡åç§°å·²å¡«å†™æ—¶ï¼‰
        document.getElementById('start-date').addEventListener('input', toggleSubmitButton);
        document.getElementById('school-name').addEventListener('input', toggleSubmitButton);
        document.getElementById('school-name-select').addEventListener('change', toggleSubmitButton);

        function toggleSubmitButton() {
            const startDate = document.getElementById('start-date').value;
            const schoolName = document.getElementById('school-name-select').value === 'custom'
                ? document.getElementById('school-name').value
                : document.getElementById('school-name-select').value;
            submitButton.disabled = !(startDate && schoolName);
        }

        // ä¿å­˜æ•°æ®åˆ°Firestoreå’Œæœ¬åœ°å­˜å‚¨
        form.addEventListener('submit', function (event) {
            event.preventDefault();

            const startDate = document.getElementById('start-date').value;
            const schoolName = document.getElementById('school-name-select').value === 'custom'
                ? document.getElementById('school-name').value
                : document.getElementById('school-name-select').value;
            if (!startDate || !schoolName) {
                showToast('è¯·è‡³å°‘å¡«å†™å­¦å†å’Œå…¥å­¦æ—¶é—´å’Œå­¦æ ¡ä¿¡æ¯ï¼');
                return;
            }

            const formData = {
                degree: document.getElementById('degree').value,
                schoolName: schoolName,
                startDate: startDate,
                endDate: document.getElementById('end-date').value,
                applyGraduationDate: document.getElementById('apply-graduation-date').value,
                boardDate: document.getElementById('board-date').value,
                graduationCertificateDate: document.getElementById('graduation-certificate-date').value,
                submitCertificationDate: document.getElementById('submit-certification-date').value,
                receiveCertificationDate: document.getElementById('receive-certification-date').value,
                overseasStudyDuration: document.getElementById('overseas-study-duration').value
            };

            // ä¿å­˜åˆ°Firestore
            db.collection('studyDurations').add(formData)
                .then(() => {
                    showToast('æ•°æ®æäº¤æˆåŠŸï¼');
                    localStorage.setItem('studyDurationFormData', JSON.stringify(formData));
                    viewOtherDataButton.disabled = false;
                })
                .catch((error) => {
                    console.error('Error adding document: ', error);
                });
        });

        // ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ•°æ®
        window.addEventListener('load', function () {
            const savedData = localStorage.getItem('studyDurationFormData');
            if (savedData) {
                const formData = JSON.parse(savedData);
                document.getElementById('degree').value = formData.degree || "";
                document.getElementById('school-name-select').value = formData.schoolName || "";
                if (formData.schoolName && !['å­¦æ ¡A', 'å­¦æ ¡B', 'å­¦æ ¡C'].includes(formData.schoolName)) {
                    document.getElementById('school-name-select').value = 'custom';
                    document.getElementById('school-name').style.display = 'block';
                    document.getElementById('school-name').value = formData.schoolName;
                }
                document.getElementById('start-date').value = formData.startDate || "";
                document.getElementById('end-date').value = formData.endDate || "";
                document.getElementById('apply-graduation-date').value = formData.applyGraduationDate || "";
                document.getElementById('board-date').value = formData.boardDate || "";
                document.getElementById('graduation-certificate-date').value = formData.graduationCertificateDate || "";
                document.getElementById('submit-certification-date').value = formData.submitCertificationDate || "";
                document.getElementById('receive-certification-date').value = formData.receiveCertificationDate || "";
                document.getElementById('overseas-study-duration').value = formData.overseasStudyDuration || "";

                viewOtherDataButton.disabled = false;
            }
        });

        // æŸ¥çœ‹å…¶ä»–ç”¨æˆ·çš„æ•°æ®
        viewOtherDataButton.addEventListener('click', function () {
            viewOtherDataButton.style.display = 'none'; // éšè—æŒ‰é’®
            const cachedUserData = localStorage.getItem('cachedUserData');
            const cacheTimestamp = localStorage.getItem('cacheTimestamp');
            const now = new Date().getTime();

            if (cachedUserData && cacheTimestamp && (now - cacheTimestamp < 10 * 60 * 1000)) {
                // ä½¿ç”¨ç¼“å­˜æ•°æ®ï¼ˆå¦‚æœç¼“å­˜æ•°æ®åœ¨10åˆ†é’Ÿå†…æœ‰æ•ˆï¼‰
                displayUserData(JSON.parse(cachedUserData));
            } else {
                // ä»Firestoreè·å–æ•°æ®ï¼ˆå¦‚æœæ²¡æœ‰æœ‰æ•ˆçš„ç¼“å­˜æ•°æ®ï¼‰
                userDataList.innerHTML = ''; // å…ˆæ¸…ç©ºåˆ—è¡¨
                const currentUserData = JSON.parse(localStorage.getItem('studyDurationFormData'));

                db.collection('studyDurations').get()
                    .then((querySnapshot) => {
                        const userDataArray = [];
                        querySnapshot.forEach((doc) => {
                            const data = doc.data();
                            // æ’é™¤å½“å‰ç”¨æˆ·çš„æ•°æ®
                            if (JSON.stringify(data) !== JSON.stringify(currentUserData)) {
                                userDataArray.push(data);
                            }
                        });
                        localStorage.setItem('cachedUserData', JSON.stringify(userDataArray));
                        localStorage.setItem('cacheTimestamp', new Date().getTime());
                        displayUserData(userDataArray);
                    })
                    .catch((error) => {
                        console.error('Error getting documents: ', error);
                    });
            }
        });

        function displayUserData(userDataArray) {
            const schoolDataMap = {};
            userDataArray.forEach(data => {
                const schoolName = data.schoolName || 'æœªå¡«å†™';
                if (!schoolDataMap[schoolName]) {
                    schoolDataMap[schoolName] = [];
                }
                schoolDataMap[schoolName].push(data);
            });

            for (const school in schoolDataMap) {
                const schoolButton = document.createElement('button');
                schoolButton.className = 'school-button';
                schoolButton.innerText = school;
                schoolButton.addEventListener('click', () => displaySchoolData(schoolDataMap[school]));
                userDataList.appendChild(schoolButton);
            }

            userDataContainer.style.display = 'block';
        }

        function displaySchoolData(schoolDataArray) {
            userDataList.innerHTML = ''; // å…ˆæ¸…ç©ºåˆ—è¡¨
            schoolDataArray.forEach(data => {
                const listItem = document.createElement('li');
                listItem.innerHTML = `<strong>å­¦å†:</strong> ${data.degree}<br>
                                      <strong>å­¦æ ¡:</strong> ${data.schoolName || 'æœªå¡«å†™'}<br>
                                      <strong>å…¥å­¦æ—¶é—´:</strong> ${data.startDate}<br>
                                      <strong>è¯¾ç¨‹ç»“æŸæ—¶é—´:</strong> ${data.endDate || 'æœªå¡«å†™'}<br>
                                      <strong>ç”³è¯·æ¯•ä¸šæ—¶é—´:</strong> ${data.applyGraduationDate || 'æœªå¡«å†™'}<br>
                                      <strong>è‘£äº‹ä¼šä¸Šä¼šæ—¶é—´:</strong> ${data.boardDate || 'æœªå¡«å†™'}<br>
                                      <strong>æ¯•ä¸šè¯ä¹¦æ˜¾ç¤ºæ—¶é—´:</strong> ${data.graduationCertificateDate || 'æœªå¡«å†™'}<br>
                                      <strong>æäº¤ç•™æœç”³è¯·æ—¶é—´:</strong> ${data.submitCertificationDate || 'æœªå¡«å†™'}<br>
                                      <strong>æ‹¿åˆ°ç•™æœè¯ä¹¦æ—¶é—´:</strong> ${data.receiveCertificationDate || 'æœªå¡«å†™'}<br>
                                      <strong>å¢ƒå¤–å­¦ä¹ æ—¶é•¿:</strong> ${data.overseasStudyDuration || 'æœªå¡«å†™'}å¤©`;
                userDataList.appendChild(listItem);
            });
        }
    </script>
</body>
</html>
