<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VCC æˆæƒäº¤æ˜“æŸ¥è¯¢</title>
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
  background: #f8f9fa;
  color: #212529;
  line-height: 1.5;
}

.app {
  display: flex;
  flex-direction: column;
  height: 100vh;
  max-width: 1800px;
  margin: 0 auto;
}

/* é¡¶éƒ¨æ  */
.header {
  background: white;
  border-bottom: 1px solid #e9ecef;
  padding: 12px 20px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-shrink: 0;
}

.header-left {
  display: flex;
  align-items: center;
  gap: 12px;
}

.logo {
  font-size: 18px;
  font-weight: 600;
  color: #212529;
}

.badge {
  background: #28a745;
  color: white;
  padding: 2px 8px;
  border-radius: 3px;
  font-size: 11px;
  font-weight: 500;
}

.header-right {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 12px;
}

.header-right select {
  padding: 4px 8px;
  border: 1px solid #dee2e6;
  border-radius: 4px;
  font-size: 10px;
  background: white;
  min-width: 500px;
  max-width: 700px;
  font-family: 'Consolas', 'Monaco', monospace;
}

.btn {
  padding: 6px 12px;
  border: 1px solid #dee2e6;
  border-radius: 4px;
  background: white;
  cursor: pointer;
  font-size: 12px;
  transition: all 0.15s;
}

.btn:hover {
  background: #f8f9fa;
  border-color: #adb5bd;
}

.btn-primary {
  background: #007bff;
  color: white;
  border-color: #007bff;
}

.btn-primary:hover {
  background: #0056b3;
  border-color: #0056b3;
}

/* ä¸»å†…å®¹åŒº */
.main {
  display: flex;
  flex: 1;
  overflow: hidden;
  gap: 12px;
  padding: 12px;
}

/* å·¦ä¾§è¾“å…¥é¢æ¿ */
.sidebar {
  width: 350px;
  background: white;
  border-radius: 6px;
  border: 1px solid #e9ecef;
  display: flex;
  flex-direction: column;
  flex-shrink: 0;
}

.sidebar-header {
  padding: 12px 16px;
  border-bottom: 1px solid #e9ecef;
  font-weight: 600;
  font-size: 13px;
  color: #495057;
}

.sidebar-body {
  flex: 1;
  padding: 12px;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

textarea {
  min-height: 50px;
  max-height: 100px;
  padding: 8px;
  border: 1px solid #dee2e6;
  border-radius: 4px;
  font-size: 11px;
  font-family: 'Consolas', 'Monaco', monospace;
  resize: vertical;
  background: #f8f9fa;
}

textarea:focus {
  outline: none;
  border-color: #007bff;
  background: white;
}

/* ç»Ÿè®¡å¡ç‰‡ */
.stats {
  display: none;
  background: #f8f9fa;
  padding: 12px;
  border-radius: 4px;
  border: 1px solid #e9ecef;
}

.stats.show {
  display: block;
}

.stats-title {
  font-size: 12px;
  font-weight: 600;
  color: #495057;
  margin-bottom: 8px;
}

.stats-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 8px;
  margin-bottom: 12px;
}

.stat-item {
  text-align: center;
  padding: 8px;
  background: white;
  border-radius: 4px;
  border: 1px solid #e9ecef;
}

.stat-value {
  font-size: 20px;
  font-weight: 700;
  line-height: 1;
  margin-bottom: 4px;
}

.stat-label {
  font-size: 11px;
  color: #6c757d;
}

.stat-success { color: #28a745; }
.stat-danger { color: #dc3545; }
.stat-info { color: #17a2b8; }

/* å¤±è´¥åŸå›  */
.fail-reasons {
  margin-top: 12px;
  max-height: 400px;
  overflow-y: auto;
}

.fail-item {
  display: flex;
  flex-direction: column;
  padding: 10px;
  margin-bottom: 8px;
  font-size: 11px;
  border: 1px solid #e9ecef;
  border-radius: 4px;
  background: white;
  transition: all 0.15s;
}

.fail-item:hover {
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  border-color: #adb5bd;
}

.fail-item-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.fail-code {
  font-weight: 600;
  color: #212529;
  font-size: 12px;
}

.fail-name {
  color: #dc3545;
  font-weight: 600;
  margin-top: 4px;
  font-size: 11px;
}

.fail-count {
  background: #dc3545;
  color: white;
  padding: 2px 8px;
  border-radius: 12px;
  font-weight: 600;
  font-size: 11px;
}

.fail-desc {
  color: #6c757d;
  font-size: 10px;
  line-height: 1.4;
  margin-top: 4px;
}

.fail-desc-en {
  color: #6c757d;
}

.fail-desc-cn {
  color: #495057;
  margin-top: 2px;
}

/* å³ä¾§è¡¨æ ¼åŒºåŸŸ */
.content {
  flex: 1;
  background: white;
  border-radius: 6px;
  border: 1px solid #e9ecef;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.content-header {
  padding: 12px 16px;
  border-bottom: 1px solid #e9ecef;
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-shrink: 0;
}

.content-title {
  font-weight: 600;
  font-size: 13px;
  color: #495057;
}

.legend {
  display: flex;
  gap: 16px;
  font-size: 11px;
  color: #6c757d;
}

.legend-item {
  display: flex;
  align-items: center;
  gap: 4px;
}

.legend-dot {
  width: 8px;
  height: 8px;
  border-radius: 2px;
}

.legend-success { background: #d4edda; }
.legend-fail { background: #f8d7da; }

/* è¡¨æ ¼å®¹å™¨ */
.table-wrapper {
  flex: 1;
  overflow: auto;
}

table {
  width: 100%;
  border-collapse: collapse;
  font-size: 11px;
  min-width: 1400px;
}

thead {
  position: sticky;
  top: 0;
  z-index: 10;
  background: white;
}

th {
  padding: 8px 10px;
  text-align: center;
  font-weight: 400;
  font-size: 10px;
  color: #495057;
  border-bottom: 2px solid #e9ecef;
  white-space: nowrap;
  cursor: pointer;
  user-select: none;
  vertical-align: middle;
}

th:hover {
  background: #f8f9fa;
}

th.sorted-asc::after {
  content: " â–²";
  color: #007bff;
}

th.sorted-desc::after {
  content: " â–¼";
  color: #007bff;
}

td {
  padding: 8px 10px;
  border-bottom: 1px solid #f1f3f5;
  text-align: center;
  white-space: nowrap;
}

tr:hover td {
  background: #f8f9fa;
}

tr.success td {
  background: #d4edda;
}

tr.fail td {
  background: #f8d7da;
}

tr.success:hover td {
  background: #c3e6cb;
}

tr.fail:hover td {
  background: #f5c6cb;
}

/* æ•°å€¼åˆ—å³å¯¹é½ */
td:nth-child(5),
td:nth-child(11),
td:nth-child(12) {
  text-align: right;
  font-family: 'Consolas', monospace;
}

/* å¤±è´¥åŸå› åˆ— */
td:nth-child(9) {
  color: #dc3545;
  font-weight: 600;
}

/* é—®å·å›¾æ ‡ */
.help-icon {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 14px;
  height: 14px;
  background: #6c757d;
  color: white;
  border-radius: 50%;
  font-size: 10px;
  font-weight: bold;
  margin-left: 4px;
  cursor: help;
  vertical-align: middle;
}

.help-icon:hover {
  background: #495057;
}

/* æç¤ºå¼¹çª— */
.tooltip-overlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(0,0,0,0.4);
  z-index: 1000;
  backdrop-filter: blur(2px);
}

.tooltip-overlay.show {
  display: block;
}

.tooltip-modal {
  display: none;
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: white;
  border-radius: 8px;
  padding: 20px 24px;
  max-width: 800px;
  width: 90%;
  max-height: 80vh;
  overflow-y: auto;
  z-index: 1001;
  box-shadow: 0 10px 40px rgba(0,0,0,0.2);
}

.tooltip-modal.show {
  display: block;
}

.tooltip-close {
  position: absolute;
  top: 12px;
  right: 16px;
  font-size: 24px;
  color: #adb5bd;
  cursor: pointer;
  line-height: 1;
  transition: color 0.15s;
}

.tooltip-close:hover {
  color: #495057;
}

.tooltip-header {
  font-weight: 600;
  font-size: 15px;
  color: #212529;
  margin-bottom: 12px;
  padding-right: 24px;
}

.tooltip-content {
  color: #495057;
  font-size: 13px;
  line-height: 1.8;
  white-space: pre-line;
}

.code-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 12px;
  font-size: 12px;
}

.code-table th,
.code-table td {
  border: 1px solid #e9ecef;
  padding: 8px 12px;
  text-align: left;
}

.code-table th {
  background: #f8f9fa;
  font-weight: 600;
  color: #495057;
}

.code-table tr:hover td {
  background: #f8f9fa;
}

.code-name {
  font-weight: 600;
  color: #212529;
}

.code-en {
  color: #6c757d;
  font-size: 11px;
}

.code-cn {
  color: #495057;
  margin-top: 4px;
}

.tooltip-section {
  margin-bottom: 16px;
}

.tooltip-section:last-child {
  margin-bottom: 0;
}

.tooltip-label {
  font-weight: 600;
  color: #212529;
  margin-bottom: 8px;
  font-size: 14px;
  border-bottom: 2px solid #e9ecef;
  padding-bottom: 4px;
}

/* ç©ºçŠ¶æ€ */
.empty-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100%;
  color: #adb5bd;
  font-size: 13px;
}

.empty-icon {
  font-size: 48px;
  margin-bottom: 12px;
  opacity: 0.5;
}

/* æ»šåŠ¨æ¡æ ·å¼ */
::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}

::-webkit-scrollbar-track {
  background: #f1f3f5;
}

::-webkit-scrollbar-thumb {
  background: #ced4da;
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: #adb5bd;
}

</style>

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
  import { getFirestore, collection, addDoc, getDocs, query, orderBy, limit } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
  
  const firebaseConfig = {
    apiKey: "AIzaSyBSoB3xjhlxyS3d9GL_b1PTxGg07BkXmT8",
    authDomain: "vcc-response.firebaseapp.com",
    projectId: "vcc-response",
    storageBucket: "vcc-response.firebasestorage.app",
    messagingSenderId: "909113770294",
    appId: "1:909113770294:web:6eb4398d176ef60c797397",
    measurementId: "G-CJR4961Z1F"
  };
  
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  
  window.firebaseDB = db;
  window.firestoreCollection = collection;
  window.firestoreAddDoc = addDoc;
  window.firestoreGetDocs = getDocs;
  window.firestoreQuery = query;
  window.firestoreOrderBy = orderBy;
  window.firestoreLimit = limit;
</script>
</head>
<body>

<!-- æç¤ºå¼¹çª— -->
<div class="tooltip-overlay" id="tooltipOverlay" onclick="closeTooltip()"></div>
<div class="tooltip-modal" id="tooltipModal">
  <span class="tooltip-close" onclick="closeTooltip()">&times;</span>
  <div class="tooltip-header" id="tooltipHeader"></div>
  <div class="tooltip-content" id="tooltipContent"></div>
</div>

<div class="app">
  <!-- é¡¶éƒ¨æ  -->
  <div class="header">
    <div class="header-left">
      <div class="logo">VCC  æˆæƒäº¤æ˜“æŸ¥è¯¢</div>
      <span class="badge">vå†…éƒ¨æµ‹è¯•ä½¿ç”¨ï¼ˆ2026.1.10ï¼‰</span>
    </div>
    <div class="header-right">
      <button class="btn" onclick="showResponseCodes()">ğŸ“– å“åº”ä»£ç è¯´æ˜</button>
      <span style="margin-left: 12px;">å†å²:</span>
      <select id="historySelect" onchange="loadHistory()">
        <option value="">é€‰æ‹©è®°å½•</option>
      </select>
      <button class="btn" onclick="clearHistory()">æ¸…ç©º</button>
    </div>
  </div>

  <!-- ä¸»å†…å®¹ -->
  <div class="main">
    <!-- å·¦ä¾§é¢æ¿ -->
    <div class="sidebar">
      <div class="sidebar-header">JSON æ•°æ®</div>
      <div class="sidebar-body">
        <textarea id="jsonInput" placeholder="è¯·ç²˜è´´æˆæƒæŠ¥å‘Š JSON æ•°æ®..."></textarea>
        <button class="btn btn-primary" onclick="generateTable()">è§£ææ•°æ®</button>
        
        <!-- ç»Ÿè®¡ä¿¡æ¯ -->
        <div class="stats" id="statsPanel">
          <div class="stats-title">äº¤æ˜“ç»Ÿè®¡</div>
          <div class="stats-grid">
            <div class="stat-item">
              <div class="stat-value stat-info" id="statTotal">0</div>
              <div class="stat-label">æ€»è®¡</div>
            </div>
            <div class="stat-item">
              <div class="stat-value stat-success" id="statSuccess">0</div>
              <div class="stat-label">æˆåŠŸ</div>
            </div>
            <div class="stat-item">
              <div class="stat-value stat-danger" id="statFail">0</div>
              <div class="stat-label">å¤±è´¥</div>
            </div>
          </div>
          <div class="fail-reasons" id="failReasons"></div>
        </div>
      </div>
    </div>

    <!-- å³ä¾§è¡¨æ ¼ -->
    <div class="content">
      <div class="content-header">
        <div class="content-title">äº¤æ˜“æ˜ç»†</div>
        <div class="legend">
          <div class="legend-item">
            <span class="legend-dot legend-success"></span>
            <span>æˆåŠŸ</span>
          </div>
          <div class="legend-item">
            <span class="legend-dot legend-fail"></span>
            <span>å¤±è´¥</span>
          </div>
        </div>
      </div>
      <div class="table-wrapper" id="tableWrapper">
        <div class="empty-state">
          <div class="empty-icon">ğŸ“Š</div>
          <div>è¯·åœ¨å·¦ä¾§ç²˜è´´ JSON æ•°æ®å¹¶ç‚¹å‡»"è§£ææ•°æ®"</div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* ================= å…¨å±€å˜é‡ ================= */
let currentSortField = null;
let currentSortOrder = 'asc';
let allFields = [];
let rawList = [];

/* ================= å­—æ®µæ˜ å°„ ================= */
const fieldLabels = {
  index: "index / åºå·",
  txn_date_time: "txn_date_time / äº¤æ˜“æ—¶é—´ğŸ•°",
  virtual_card_number: "virtual_card_number / è™šæ‹Ÿå¡å·",
  real_card_alias: "real_card_alias / çœŸå®å¡åˆ«å",
  merchant_name: "merchant_name / å•†æˆ·åç§°ğŸ¨",
  merchant_amount: "merchant_amount / å•†æˆ·é‡‘é¢ğŸ’°",
  merchant_currency_code: "merchant_currency_code / å•†æˆ·å¸ç§ğŸ’°",
  txn_type: "txn_type / äº¤æ˜“ç±»å‹",
  issuer_response: "issuer_response / ã€Œå‘å¡è¡Œå“åº”ã€",
  in_control_response: "in_control_response / ã€ŒIn Control å“åº”ã€",
  approval_code: "approval_code / æˆæƒç ğŸ’³",
  billing_amount: "billing_amount / è´¦å•é‡‘é¢ğŸ’°",
  billing_currency_code: "billing_currency_code / è´¦å•å¸ç§ğŸ’°",
  purchase_request_id: "purchase_request_id / äº¤æ˜“ID",
  mcc: "mcc / å•†æˆ·åˆ†ç±»ç ",
  merchant_country: "merchant_country / å•†æˆ·å›½å®¶",
  merchant_id: "merchant_id / å•†æˆ·ID",
  settled: "settled / ç»“ç®—çŠ¶æ€",
  company_name: "company_name / å…¬å¸åç§°",
  txn_environment: "txn_environment / äº¤æ˜“ç¯å¢ƒ",
  billing_currency_code_description: "billing_currency_code_description / è´¦å•å¸ç§æè¿°",
  txn_sub_type: "txn_sub_type / äº¤æ˜“å­ç±»å‹",
  mcc_description: "mcc_description / å•†æˆ·åˆ†ç±»æè¿°",
  merchant_terminal_id: "merchant_terminal_id / ç»ˆç«¯ID",
  company_number: "company_number / å…¬å¸ç¼–å·",
  acquirer_reference_data: "acquirer_reference_data / æ”¶å•æ–¹å‚è€ƒä¿¡æ¯",
  traceId: "traceId / è¿½è¸ªID",
  clearing_type: "clearing_type / æ¸…ç®—ç±»å‹",
  settlement_amount: "settlement_amount / ç»“ç®—é‡‘é¢ğŸ’°",
  settlement_currency_code: "settlement_currency_code / ç»“ç®—å¸ç§ğŸ’°",
  settlement_currency_description: "settlement_currency_description / ç»“ç®—å¸ç§æè¿°",
  merchant_street_address: "merchant_street_address / å•†æˆ·è¡—é“åœ°å€",
  merchant_city: "merchant_city / å•†æˆ·åŸå¸‚",
  merchant_state: "merchant_state / å•†æˆ·å·/çœ",
  merchant_postal_code: "merchant_postal_code / å•†æˆ·é‚®ç¼–",
  card_acceptor_id: "card_acceptor_id / å—å¡æ–¹ID",
  retrieval_reference_number: "retrieval_reference_number / æ£€ç´¢å‚è€ƒå·",
  system_trace_audit_number: "system_trace_audit_number / ç³»ç»Ÿè·Ÿè¸ªå®¡è®¡å·",
  transaction_identifier: "transaction_identifier / äº¤æ˜“æ ‡è¯†ç¬¦",
  authorization_identification_response: "authorization_identification_response / æˆæƒè¯†åˆ«å“åº”",
  pos_entry_mode: "pos_entry_mode / POSè¾“å…¥æ¨¡å¼",
  card_sequence_number: "card_sequence_number / å¡ç‰‡åºåˆ—å·",
  network_international_id: "network_international_id / ç½‘ç»œå›½é™…ID",
  point_of_service_data_code: "point_of_service_data_code / æœåŠ¡ç‚¹æ•°æ®ä»£ç ",
  authorization_code: "authorization_code / æˆæƒä»£ç ",
  response_code: "response_code / å“åº”ä»£ç ",
  card_acceptor_terminal_id: "card_acceptor_terminal_id / å—å¡ç»ˆç«¯ID",
  merchant_category_code: "merchant_category_code / å•†æˆ·ç±»åˆ«ä»£ç ",
  amount_transaction: "amount_transaction / äº¤æ˜“é‡‘é¢",
  amount_settlement: "amount_settlement / ç»“ç®—é‡‘é¢",
  amount_cardholder_billing: "amount_cardholder_billing / æŒå¡äººè´¦å•é‡‘é¢",
  conversion_rate_settlement: "conversion_rate_settlement / ç»“ç®—æ±‡ç‡",
  conversion_rate_cardholder_billing: "conversion_rate_cardholder_billing / æŒå¡äººè´¦å•æ±‡ç‡",
  message_reason_code: "message_reason_code / æ¶ˆæ¯åŸå› ä»£ç ",
  message_type: "message_type / æ¶ˆæ¯ç±»å‹",
  function_code: "function_code / åŠŸèƒ½ä»£ç ",
  acquirer_ica: "acquirer_ica / æ”¶å•æœºICA",
  processor_ica: "processor_ica / å¤„ç†æœºICA",
  incontrol_issuer_id: "incontrol_issuer_id / InControlå‘å¡æœºID",
  merchant_country_code: "merchant_country_code / å•†æˆ·å›½å®¶ä»£ç ",
  merchant_country_code_description: "merchant_country_code_description / å•†æˆ·å›½å®¶ä»£ç æè¿°",
  merchant_currency_code_description: "merchant_currency_code_description / å•†æˆ·å¸ç§æè¿°",
  settlement_date: "settlement_date / ç»“ç®—æ—¥æœŸ",
  terminal_id: "terminal_id / ç»ˆç«¯ID",
  txn_exchange_rate: "txn_exchange_rate / äº¤æ˜“æ±‡ç‡",
  vcn_expiry: "vcn_expiry / è™šæ‹Ÿå¡åˆ°æœŸæ—¥",
  real_card_number: "real_card_number / çœŸå®å¡å·",
  requestor_name: "requestor_name / è¯·æ±‚è€…åç§°"
};

const fieldTooltips = {
  "billing_amount": "æŒå¡äººè´¦å•å¸ç§çš„äº¤æ˜“é‡‘é¢ï¼Œç”¨äºæœ€ç»ˆç»“ç®—",
  "merchant_amount": "å•†æˆ·æœ¬åœ°å¸ç§çš„äº¤æ˜“é‡‘é¢ï¼Œå¯èƒ½ä¸è´¦å•é‡‘é¢ä¸åŒ",
  "billing_currency_code": "æŒå¡äººçš„ç»“ç®—å¸ç§ï¼ˆå¦‚ USDï¼‰",
  "merchant_currency_code": "å•†æˆ·çš„æœ¬åœ°å¸ç§ï¼ˆå¦‚ HUFã€EURï¼‰",
  "issuer_response": "å‘å¡è¡Œè¿”å›çš„å“åº”ä»£ç ",
  "in_control_response": "In Control ç³»ç»Ÿçš„å“åº”ä»£ç ",
  "approval_code": "äº¤æ˜“æˆæƒæˆåŠŸåçš„æˆæƒç ",
  "purchase_request_id": "é‡‡è´­è¯·æ±‚çš„å”¯ä¸€æ ‡è¯†ç¬¦"
};

const IN_CONTROL_RESPONSES = {
    'Approval': 'æ‰¹å‡† | Transaction within the VCN limits. | äº¤æ˜“åœ¨ VCN é™é¢å†…ã€‚',
    'CPN does not exist': 'CPN ä¸å­˜åœ¨ | Invalid VCN, not registered in In Control. | æ— æ•ˆçš„ VCNï¼Œæœªåœ¨ In Control ä¸­æ³¨å†Œã€‚',
    'Status bad': 'çŠ¶æ€ä¸è‰¯ | VCN not in an active state. Cannot use for authorizations. | VCN æœªå¤„äºæ´»åŠ¨çŠ¶æ€ã€‚æ— æ³•ç”¨äºæˆæƒã€‚',
    'Expiry match fail': 'è¿‡æœŸåŒ¹é…å¤±è´¥ | Expiry provided for the authorization does not match the VCN Expiry. | æˆæƒæä¾›çš„åˆ°æœŸæ—¥ä¸ VCN åˆ°æœŸæ—¥ä¸åŒ¹é…ã€‚',
    'AVV match fail': 'AVV åŒ¹é…å¤±è´¥ | CVC2 provided for the authorization does not match the VCN CVC2. | æˆæƒä¸­æä¾›çš„ CVC2 ä¸ VCN CVC2 ä¸åŒ¹é…ã€‚',
    'Valid period fail': 'æœ‰æ•ˆæœŸé™å¤±è´¥ | Transaction falls outside the VCN\'s defined validity period. | äº¤æ˜“ä¸åœ¨ VCN å®šä¹‰çš„æœ‰æ•ˆæœŸå†…ã€‚',
    'Trans limit fail': 'äº¤æ˜“é™é¢å¤±è´¥ | Transaction amount greater than the VCN\'s transaction limit. | äº¤æ˜“é‡‘é¢è¶…è¿‡ VCN çš„äº¤æ˜“é™é¢ã€‚',
    'Cumul limit fail': 'ç´¯è®¡é™é¢å¤±è´¥ | Current authorization causes the VCN to breach its cumulative spend limit. | å½“å‰æˆæƒå¯¼è‡´ VCN è¶…å‡ºå…¶ç´¯è®¡æ¶ˆè´¹é™é¢ã€‚',
    'Num usages fail': 'ä½¿ç”¨æ¬¡æ•°å¤±è´¥ | Current authorization causes the VCN to breach its usage. | å½“å‰æˆæƒå¯¼è‡´ VCN è¶…å‡ºå…¶ä½¿ç”¨é™é¢ã€‚',
    'Merch Id limit fail': 'å•†æˆ· ID é™åˆ¶å¤±è´¥ | Merchant Id for authorization does not match the Merchant Id linked to the VCN. | æˆæƒçš„å•†æˆ· ID ä¸å…³è”åˆ° VCN çš„å•†æˆ· ID ä¸åŒ¹é…ã€‚',
    'MCC limit fail': 'MCC é™é¢å¤±è´¥ | Merchant Category Code for the authorization does not match the MCC linked to this VCN. | æˆæƒçš„å•†æˆ·ç±»åˆ«ä»£ç ä¸å…³è”åˆ°è¯¥ VCN çš„ MCC ä¸åŒ¹é…ã€‚',
    'Iss/Netwk decline': 'å‘å¡æœºæ„/ç½‘ç»œæ‹’ç» | Authorization declined by the issuer or card network. Outside of In Control. | å‘å¡æœºæ„æˆ–å¡ç½‘ç»œæ‹’ç»æˆæƒã€‚è¶…å‡º In Control èŒƒå›´ã€‚',
    'Merch Amount Fail': 'å•†æˆ·é‡‘é¢å¤±è´¥ | Transaction amount breaches the expected merchant currency. | äº¤æ˜“é‡‘é¢è¶…å‡ºé¢„æœŸå•†æˆ·è´§å¸ã€‚',
    'Amount Range Control Fail': 'é‡‘é¢èŒƒå›´æ§åˆ¶å¤±è´¥ | Transaction amount falls outside the minimum and maximum amount range set. | äº¤æ˜“é‡‘é¢è¶…å‡ºè®¾å®šçš„æœ€ä½å’Œæœ€é«˜é‡‘é¢èŒƒå›´ã€‚',
    'æœªè¿”å›åŸå› ': 'æœªè¿”å› In Control å¤±è´¥åŸå›  | No in_control_response returned. | æœªè¿”å› in_control_responseã€‚'
};

/* ================= ä¸»å…¥å£ ================= */
function generateTable() {
  let input = document.getElementById('jsonInput').value.trim();
  if(!input) { 
    alert("è¯·å…ˆè¾“å…¥ JSON æ•°æ®"); 
    return; 
  }

  try {
    let json = JSON.parse(input);
    let list = json.data?.list || json.list || json;

    if(!Array.isArray(list)) { 
      alert("JSON æ ¼å¼ä¸æ­£ç¡®ï¼Œæœªæ‰¾åˆ°æœ‰æ•ˆçš„äº¤æ˜“åˆ—è¡¨"); 
      return; 
    }
    
    rawList = list;
    saveHistory(rawList, input);
    
    // ä¿å­˜åˆ°äº‘ç«¯
    saveToCloud(rawList).catch(err => console.error('ä¿å­˜åˆ°äº‘ç«¯å¤±è´¥:', err));
    
    extractFields(rawList);
    currentSortField = null;
    currentSortOrder = 'asc';
    renderTable(rawList);
    renderStats(rawList);
  } catch(e) {
    alert("JSON è§£æå¤±è´¥: " + e.message);
  }
}

/* ================= ç»Ÿè®¡æ¸²æŸ“ ================= */
function renderStats(list) {
  const total = list.length;
  const isApproved = (r) => r.issuer_response && r.issuer_response.toLowerCase().includes("approved");
  
  const successList = list.filter(isApproved);
  const failList = list.filter(r => !isApproved(r));

  document.getElementById('statTotal').textContent = total;
  document.getElementById('statSuccess').textContent = successList.length;
  document.getElementById('statFail').textContent = failList.length;

  // å¤±è´¥åŸå› ç»Ÿè®¡
  const failMap = {};
  failList.forEach(r => {
    const reason = r.in_control_response || 'æœªè¿”å›åŸå› ';
    failMap[reason] = (failMap[reason] || 0) + 1;
  });

  const failArr = Object.entries(failMap).sort((a, b) => b[1] - a[1]);
  
  let failHtml = '';
  failArr.slice(0, 10).forEach(([reason, count]) => {
    const fullExplanation = IN_CONTROL_RESPONSES[reason] || reason;
    const parts = fullExplanation.split(' | ');
    const chineseName = parts[0] || reason;
    const englishDesc = parts.length > 1 ? parts[1] : '';
    const chineseDesc = parts.length > 2 ? parts[2] : '';
    
    failHtml += `
      <div class="fail-item">
        <div class="fail-item-header">
          <div class="fail-code">${reason}</div>
          <div class="fail-count">${count}</div>
        </div>
        <div class="fail-name">${chineseName}</div>
        ${englishDesc ? `<div class="fail-desc fail-desc-en">${englishDesc}</div>` : ''}
        ${chineseDesc ? `<div class="fail-desc fail-desc-cn">${chineseDesc}</div>` : ''}
      </div>
    `;
  });

  document.getElementById('failReasons').innerHTML = failHtml;
  document.getElementById('statsPanel').classList.add('show');
  
  // å‘é€é€šçŸ¥ï¼ˆBark å’Œ é£ä¹¦ï¼‰
  sendNotifications(list, total, successList.length, failList.length, failArr);
}

/* ================= å­—æ®µæå– ================= */
function extractFields(list) {
  const mainFields = ["index","txn_date_time","virtual_card_number","merchant_name","merchant_amount","merchant_currency_code","txn_type","issuer_response","in_control_response","approval_code","billing_amount","billing_currency_code"];
  let fieldSet = new Set();
  
  list.forEach(item => Object.keys(item).forEach(k => fieldSet.add(k)));
  
  allFields = mainFields.filter(f => f === "index" || fieldSet.has(f));
  fieldSet.forEach(f => { if(!allFields.includes(f)) allFields.push(f); });
  
  allFields = allFields.map(f => {
    let label = fieldLabels[f];
    // å¦‚æœæ²¡æœ‰å®šä¹‰ï¼Œè‡ªåŠ¨ç”Ÿæˆä¸­è‹±æ–‡æ ¼å¼
    if (!label) {
      label = `${f} / ${f}`;
    }
    return {
      key: f,
      label: label,
      tooltip: fieldTooltips[f] || ""
    };
  });
}

/* ================= è¡¨æ ¼æ¸²æŸ“ ================= */
function renderTable(list) {
  const wrapper = document.getElementById('tableWrapper');
  
  if (list.length === 0) {
    wrapper.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">ğŸ“Š</div>
        <div>æš‚æ— æ•°æ®</div>
      </div>
    `;
    return;
  }

  const baseList = list.slice().reverse();
  let sortedList = list.slice().reverse();

  // æ’åº
  if(currentSortField) {
    sortedList.sort((a,b) => {
      let valA = a[currentSortField] ?? '';
      let valB = b[currentSortField] ?? '';

      const numA = parseFloat(valA);
      const numB = parseFloat(valB);

      if (!isNaN(numA) && !isNaN(numB)) {
        return currentSortOrder === 'asc' ? numA - numB : numB - numA;
      }
      
      if(typeof valA === 'string') valA = valA.toLowerCase();
      if(typeof valB === 'string') valB = valB.toLowerCase();
      
      if(valA < valB) return currentSortOrder === 'asc' ? -1 : 1;
      if(valA > valB) return currentSortOrder === 'asc' ? 1 : -1;
      return 0;
    });
  }

  // æ¸²æŸ“è¡¨å¤´
  let theadHtml = '<tr>';
  allFields.forEach(f => {
    const sortClass = f.key === currentSortField ? `sorted-${currentSortOrder}` : '';
    const onClick = f.key !== 'index' ? `onclick="sortTable('${f.key}')"` : '';
    const helpIcon = f.tooltip 
      ? `<span class="help-icon" onclick="event.stopPropagation(); showTooltip('${f.key}', '${f.label}', '${f.tooltip.replace(/'/g, "\\'")}')">?</span>` 
      : '';

    // åˆ†ç¦»ä¸­è‹±æ–‡ï¼Œæ¢è¡Œæ˜¾ç¤º
    const parts = f.label.split(' / ');
    const englishPart = parts[0] || '';
    const chinesePart = parts[1] || '';
    const labelHtml = `<div style="line-height: 1.2;">
      <div style="font-size: 9px; color: #6c757d;">${englishPart}</div>
      <div style="font-size: 11px; font-weight: 600; margin-top: 2px;">${chinesePart}</div>
    </div>`;

    theadHtml += `<th class="${sortClass}" ${onClick}>${labelHtml}${helpIcon}</th>`;
  });
  theadHtml += '</tr>';

  // æ¸²æŸ“è¡¨ä½“
  let tbodyHtml = '';
  sortedList.forEach((item) => {
    const isApproved = item["issuer_response"] && item["issuer_response"].toLowerCase().includes("approved");
    const rowClass = isApproved ? "success" : (item["issuer_response"] ? "fail" : "");
    
    const originalTimeIndex = baseList.indexOf(item);
    const displayIndex = originalTimeIndex !== -1 ? originalTimeIndex + 1 : '-';

    let rowHtml = `<tr class="${rowClass}">`;
    
    allFields.forEach(f => {
      let content = f.key === 'index' ? displayIndex : (item[f.key] ?? "");
      rowHtml += `<td>${content}</td>`;
    });
    rowHtml += '</tr>';
    tbodyHtml += rowHtml;
  });

  wrapper.innerHTML = `
    <table>
      <thead>${theadHtml}</thead>
      <tbody>${tbodyHtml}</tbody>
    </table>
  `;
}

function sortTable(field) {
  if (field === 'index') return;

  if(currentSortField === field) {
    currentSortOrder = currentSortOrder === 'asc' ? 'desc' : 'asc';
  } else {
    currentSortField = field;
    currentSortOrder = 'asc';
  }

  renderTable(rawList);
}

/* ================= å†å²è®°å½• ================= */
function updateHistorySelect() {
  const history = JSON.parse(localStorage.getItem('vccHistory') || '[]');
  const select = document.getElementById('historySelect');
  
  select.innerHTML = '<option value="">é€‰æ‹©è®°å½•</option>';
  
  const isApproved = (r) => r.in_control_response === 'Approval';

  history.slice().reverse().forEach((item, originalIdx) => {
    const idx = history.length - 1 - originalIdx;
    const opt = document.createElement('option');
    opt.value = idx;

    const total = item.data.length;
    const success = item.data.filter(isApproved).length;
    const fail = total - success;
    
    // æå–ä¸»è¦å¡å·ï¼ˆå‡ºç°æ¬¡æ•°æœ€å¤šçš„ï¼‰
    const cardMap = {};
    item.data.forEach(record => {
      const card = record.virtual_card_number || record.real_card_alias || 'æœªçŸ¥';
      cardMap[card] = (cardMap[card] || 0) + 1;
    });
    const mainCard = Object.entries(cardMap).sort((a, b) => b[1] - a[1])[0]?.[0] || 'æœªçŸ¥';
    
    // å¡å·è„±æ•ï¼šä¿ç•™å‰4å4ä½
    const maskedCard = mainCard.length > 8 
      ? `${mainCard.slice(0, 4)}****${mainCard.slice(-4)}`
      : mainCard;

    // æ ¼å¼ï¼šæ—¶é—´ | å¡å· | æˆåŠŸ x å¤±è´¥ x
    opt.text = `${item.timestamp} | ${maskedCard} | âœ“${success} âœ—${fail}`;
    select.appendChild(opt);
  });
}

function saveHistory(list, originalJson) {
  let history = JSON.parse(localStorage.getItem('vccHistory') || '[]');
  
  const now = new Date();
  const timestamp = `${now.getMonth() + 1}/${now.getDate()} ${now.getHours()}:${String(now.getMinutes()).padStart(2, '0')}`;
  
  const vcc = list[0]?.virtual_card_number || "æœªçŸ¥";
  history.push({ timestamp, vcc, data: list, originalJson });
  
  if (history.length > 20) {
    history = history.slice(history.length - 20);
  }
  
  localStorage.setItem('vccHistory', JSON.stringify(history));
  updateHistorySelect();
}

async function loadHistory() {
  const select = document.getElementById('historySelect');
  const value = select.value;
  if(value === "") return;
  
  // æ£€æŸ¥æ˜¯å¦æ˜¯äº‘ç«¯è®°å½•
  if(value.startsWith('cloud_')) {
    const docId = value.replace('cloud_', '');
    await loadCloudRecord(docId);
    return;
  }
  
  // åŠ è½½æœ¬åœ°è®°å½•
  const history = JSON.parse(localStorage.getItem('vccHistory') || '[]');
  const index = parseInt(value);
  
  if(history[index]) {
    document.getElementById('jsonInput').value = history[index].originalJson || '';
    rawList = history[index].data;
    extractFields(rawList);
    currentSortField = null;
    currentSortOrder = 'asc';
    renderTable(rawList);
    renderStats(rawList);
  }
}

function clearHistory() {
  if(confirm('ç¡®è®¤æ¸…ç©ºå†å²è®°å½•ï¼Ÿ')) {
    localStorage.removeItem('vccHistory');
    updateHistorySelect();
    document.getElementById('tableWrapper').innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">ğŸ“Š</div>
        <div>è¯·åœ¨å·¦ä¾§ç²˜è´´ JSON æ•°æ®å¹¶ç‚¹å‡»"è§£ææ•°æ®"</div>
      </div>
    `;
    document.getElementById('statsPanel').classList.remove('show');
  }
}

/* ================= æç¤ºå¼¹çª— ================= */
function showTooltip(fieldKey, fieldLabel, tooltipText) {
  document.getElementById('tooltipHeader').textContent = fieldLabel;
  document.getElementById('tooltipContent').textContent = tooltipText;
  document.getElementById('tooltipModal').classList.add('show');
  document.getElementById('tooltipOverlay').classList.add('show');
}

function showFailDetail(reason) {
  const fullExplanation = IN_CONTROL_RESPONSES[reason] || reason;
  const parts = fullExplanation.split(' | ');
  
  const chineseName = parts[0] || '';
  const englishDesc = parts.length > 1 ? parts[1] : '';
  const chineseDesc = parts.length > 2 ? parts[2] : '';
  
  let content = '';
  if (chineseName) {
    content += `<div class="tooltip-section">
      <div class="tooltip-label">å¤±è´¥åŸå› ï¼š</div>
      <div>${chineseName}</div>
    </div>`;
  }
  if (englishDesc) {
    content += `<div class="tooltip-section">
      <div class="tooltip-label">English Description:</div>
      <div>${englishDesc}</div>
    </div>`;
  }
  if (chineseDesc) {
    content += `<div class="tooltip-section">
      <div class="tooltip-label">ä¸­æ–‡è¯´æ˜ï¼š</div>
      <div>${chineseDesc}</div>
    </div>`;
  }
  
  document.getElementById('tooltipHeader').textContent = `${reason}`;
  document.getElementById('tooltipContent').innerHTML = content;
  document.getElementById('tooltipModal').classList.add('show');
  document.getElementById('tooltipOverlay').classList.add('show');
}

function showResponseCodes() {
  let content = '';
  
  // In Control å“åº”ä»£ç 
  content += `<div class="tooltip-section">
    <div class="tooltip-label">In Control å“åº”ä»£ç </div>
    <table class="code-table">
      <thead>
        <tr>
          <th style="width: 200px;">ä»£ç </th>
          <th>è¯´æ˜</th>
        </tr>
      </thead>
      <tbody>`;
  
  Object.entries(IN_CONTROL_RESPONSES).forEach(([code, explanation]) => {
    const parts = explanation.split(' | ');
    const chineseName = parts[0] || '';
    const englishDesc = parts.length > 1 ? parts[1] : '';
    const chineseDesc = parts.length > 2 ? parts[2] : '';
    
    content += `
      <tr>
        <td><div class="code-name">${code}</div></td>
        <td>
          <div class="code-name">${chineseName}</div>
          ${englishDesc ? `<div class="code-en">${englishDesc}</div>` : ''}
          ${chineseDesc ? `<div class="code-cn">${chineseDesc}</div>` : ''}
        </td>
      </tr>`;
  });
  
  content += `
      </tbody>
    </table>
  </div>`;
  
  // å‘å¡è¡Œå“åº”ä»£ç 
  content += `<div class="tooltip-section">
    <div class="tooltip-label">å‘å¡è¡Œå“åº”ä»£ç  (Issuer Response)</div>
    <table class="code-table">
      <thead>
        <tr>
          <th style="width: 200px;">ä»£ç </th>
          <th>è¯´æ˜</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><div class="code-name">Approved</div></td>
          <td>
            <div class="code-name">æ‰¹å‡†</div>
            <div class="code-en">Transaction approved by the issuer.</div>
            <div class="code-cn">äº¤æ˜“å·²è¢«å‘å¡æœºæ„æ‰¹å‡†ã€‚</div>
          </td>
        </tr>
        <tr>
          <td><div class="code-name">Do not honor</div></td>
          <td>
            <div class="code-name">ä¸äºˆæ‰¿å…‘</div>
            <div class="code-en">Generic decline by the issuer. No specific reason provided.</div>
            <div class="code-cn">å‘å¡æœºæ„é€šç”¨æ‹’ç»ã€‚æœªæä¾›å…·ä½“åŸå› ã€‚</div>
          </td>
        </tr>
        <tr>
          <td><div class="code-name">Insufficient funds</div></td>
          <td>
            <div class="code-name">ä½™é¢ä¸è¶³</div>
            <div class="code-en">Account does not have sufficient funds to complete the transaction.</div>
            <div class="code-cn">è´¦æˆ·ä½™é¢ä¸è¶³ä»¥å®Œæˆäº¤æ˜“ã€‚</div>
          </td>
        </tr>
        <tr>
          <td><div class="code-name">Invalid card number</div></td>
          <td>
            <div class="code-name">æ— æ•ˆå¡å·</div>
            <div class="code-en">Card number is invalid or not recognized.</div>
            <div class="code-cn">å¡å·æ— æ•ˆæˆ–æœªè¢«è¯†åˆ«ã€‚</div>
          </td>
        </tr>
        <tr>
          <td><div class="code-name">Expired card</div></td>
          <td>
            <div class="code-name">å¡ç‰‡è¿‡æœŸ</div>
            <div class="code-en">Card has expired and cannot be used.</div>
            <div class="code-cn">å¡ç‰‡å·²è¿‡æœŸï¼Œæ— æ³•ä½¿ç”¨ã€‚</div>
          </td>
        </tr>
        <tr>
          <td><div class="code-name">Invalid transaction</div></td>
          <td>
            <div class="code-name">æ— æ•ˆäº¤æ˜“</div>
            <div class="code-en">Transaction type not allowed for this card.</div>
            <div class="code-cn">è¯¥å¡ä¸å…è®¸æ­¤ç±»å‹äº¤æ˜“ã€‚</div>
          </td>
        </tr>
        <tr>
          <td><div class="code-name">Lost card</div></td>
          <td>
            <div class="code-name">å¡ç‰‡æŒ‚å¤±</div>
            <div class="code-en">Card has been reported as lost.</div>
            <div class="code-cn">å¡ç‰‡å·²è¢«æŠ¥å‘Šä¸ºæŒ‚å¤±ã€‚</div>
          </td>
        </tr>
        <tr>
          <td><div class="code-name">Stolen card</div></td>
          <td>
            <div class="code-name">å¡ç‰‡è¢«ç›—</div>
            <div class="code-en">Card has been reported as stolen.</div>
            <div class="code-cn">å¡ç‰‡å·²è¢«æŠ¥å‘Šä¸ºè¢«ç›—ã€‚</div>
          </td>
        </tr>
        <tr>
          <td><div class="code-name">Exceeds withdrawal limit</div></td>
          <td>
            <div class="code-name">è¶…å‡ºå–æ¬¾é™é¢</div>
            <div class="code-en">Transaction amount exceeds the card's withdrawal limit.</div>
            <div class="code-cn">äº¤æ˜“é‡‘é¢è¶…å‡ºå¡ç‰‡çš„å–æ¬¾é™é¢ã€‚</div>
          </td>
        </tr>
        <tr>
          <td><div class="code-name">Restricted card</div></td>
          <td>
            <div class="code-name">å¡ç‰‡å—é™</div>
            <div class="code-en">Card has been restricted by the issuer.</div>
            <div class="code-cn">å¡ç‰‡å·²è¢«å‘å¡æœºæ„é™åˆ¶ã€‚</div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>`;
  
  document.getElementById('tooltipHeader').textContent = 'å“åº”ä»£ç è¯´æ˜';
  document.getElementById('tooltipContent').innerHTML = content;
  document.getElementById('tooltipModal').classList.add('show');
  document.getElementById('tooltipOverlay').classList.add('show');
}

function closeTooltip() {
  document.getElementById('tooltipModal').classList.remove('show');
  document.getElementById('tooltipOverlay').classList.remove('show');
}

document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') closeTooltip();
});

/* ================= äº‘ç«¯æ•°æ®åº“åŠŸèƒ½ ================= */
async function saveToCloud(list) {
  if (!window.firebaseDB) {
    console.log('Firebase æœªåˆå§‹åŒ–');
    return;
  }
  
  try {
    // è·å–ç”¨æˆ·åœ°ç†ä½ç½®å’Œ IP
    let userInfo = {
      country: 'æœªçŸ¥',
      city: 'æœªçŸ¥',
      ip: 'æœªçŸ¥'
    };
    
    try {
      const geoResponse = await fetch('https://ipapi.co/json/');
      if (geoResponse.ok) {
        const geoData = await geoResponse.json();
        userInfo = {
          country: geoData.country_name || 'æœªçŸ¥',
          city: geoData.city || 'æœªçŸ¥',
          ip: geoData.ip || 'æœªçŸ¥'
        };
      }
    } catch (geoError) {
      console.error('è·å–åœ°ç†ä½ç½®å¤±è´¥:', geoError);
    }
    
    // æå–ç»Ÿè®¡ä¿¡æ¯
    const total = list.length;
    const isApproved = (r) => r.issuer_response && r.issuer_response.toLowerCase().includes("approved");
    const successCount = list.filter(isApproved).length;
    const failCount = total - successCount;
    
    // æå–ä¸»è¦å¡å·
    const cardMap = {};
    list.forEach(r => {
      const card = r.virtual_card_number || r.real_card_alias || 'æœªçŸ¥';
      cardMap[card] = (cardMap[card] || 0) + 1;
    });
    const mainCard = Object.keys(cardMap).sort((a, b) => cardMap[b] - cardMap[a])[0] || 'æœªçŸ¥';
    
    // è„±æ•å¡å·
    const maskCard = (card) => {
      if (!card || card === 'æœªçŸ¥' || card.length < 8) return card;
      return card.substring(0, 4) + '****' + card.substring(card.length - 4);
    };
    
    // ä¿å­˜åˆ° Firestoreï¼ˆåŒ…å«å®Œæ•´æ•°æ®ï¼‰
    const record = {
      timestamp: new Date().toISOString(),
      total: total,
      success: successCount,
      fail: failCount,
      card: maskCard(mainCard),
      transactionCount: total,
      transactions: list, // ä¿å­˜å®Œæ•´çš„äº¤æ˜“æ•°æ®
      userInfo: userInfo, // ç”¨æˆ·åœ°ç†ä½ç½®å’Œ IP
      createdAt: new Date()
    };
    
    const docRef = await window.firestoreAddDoc(
      window.firestoreCollection(window.firebaseDB, 'vcc_queries'),
      record
    );
    
    console.log('ä¿å­˜åˆ°äº‘ç«¯æˆåŠŸ:', docRef.id);
    
    // åˆ·æ–°äº‘ç«¯è®°å½•åˆ—è¡¨
    loadCloudRecords();
  } catch (error) {
    console.error('ä¿å­˜åˆ°äº‘ç«¯å¤±è´¥:', error);
  }
}

async function loadCloudRecord(docId) {
  if (!window.firebaseDB) {
    alert('äº‘ç«¯æ•°æ®åº“æœªåˆå§‹åŒ–');
    return;
  }
  
  try {
    // æ˜¾ç¤ºåŠ è½½æç¤º
    const tableWrapper = document.getElementById('tableWrapper');
    tableWrapper.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">â³</div>
        <div>æ­£åœ¨åŠ è½½äº‘ç«¯è®°å½•...</div>
      </div>
    `;
    
    // ä» Firestore åŠ è½½æ–‡æ¡£
    const { getDoc, doc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
    const docRef = doc(window.firebaseDB, 'vcc_queries', docId);
    const docSnap = await getDoc(docRef);
    
    if (docSnap.exists()) {
      const data = docSnap.data();
      
      if (data.transactions && Array.isArray(data.transactions)) {
        // åŠ è½½å®Œæ•´çš„äº¤æ˜“æ•°æ®
        rawList = data.transactions;
        
        // æ˜¾ç¤ºåœ¨ JSON è¾“å…¥æ¡†
        document.getElementById('jsonInput').value = JSON.stringify({ data: { list: rawList } }, null, 2);
        
        // æ¸²æŸ“è¡¨æ ¼å’Œç»Ÿè®¡
        extractFields(rawList);
        currentSortField = null;
        currentSortOrder = 'asc';
        renderTable(rawList);
        renderStats(rawList);
        
        console.log('ä»äº‘ç«¯åŠ è½½æˆåŠŸ:', docId);
      } else {
        alert('è¯¥è®°å½•ä¸åŒ…å«å®Œæ•´çš„äº¤æ˜“æ•°æ®');
        tableWrapper.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">âš ï¸</div>
            <div>è¯¥è®°å½•ä¸åŒ…å«å®Œæ•´çš„äº¤æ˜“æ•°æ®</div>
          </div>
        `;
      }
    } else {
      alert('æœªæ‰¾åˆ°è¯¥è®°å½•');
      tableWrapper.innerHTML = `
        <div class="empty-state">
          <div class="empty-icon">âŒ</div>
          <div>æœªæ‰¾åˆ°è¯¥è®°å½•</div>
        </div>
      `;
    }
  } catch (error) {
    console.error('åŠ è½½äº‘ç«¯è®°å½•å¤±è´¥:', error);
    alert('åŠ è½½äº‘ç«¯è®°å½•å¤±è´¥: ' + error.message);
  }
}

async function loadCloudRecords() {
  if (!window.firebaseDB) return;
  
  try {
    const q = window.firestoreQuery(
      window.firestoreCollection(window.firebaseDB, 'vcc_queries'),
      window.firestoreOrderBy('createdAt', 'desc'),
      window.firestoreLimit(50)
    );
    
    const querySnapshot = await window.firestoreGetDocs(q);
    const records = [];
    
    querySnapshot.forEach((doc) => {
      const data = doc.data();
      records.push({
        id: doc.id,
        ...data,
        timestamp: data.timestamp || data.createdAt?.toDate?.()?.toISOString() || ''
      });
    });
    
    updateCloudHistorySelect(records);
  } catch (error) {
    console.error('åŠ è½½äº‘ç«¯è®°å½•å¤±è´¥:', error);
  }
}

function updateCloudHistorySelect(records) {
  const select = document.getElementById('historySelect');
  if (!select) return;
  
  // æ·»åŠ äº‘ç«¯è®°å½•åˆ†ç»„
  const cloudGroup = document.createElement('optgroup');
  cloudGroup.label = 'â˜ï¸ äº‘ç«¯è®°å½• (TOP 50)';
  
  records.forEach((record, index) => {
    const option = document.createElement('option');
    const date = new Date(record.timestamp);
    const timeStr = `${date.getMonth() + 1}/${date.getDate()} ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
    
    // æ„å»ºç”¨æˆ·æ ‡ç­¾
    let userLabel = '';
    if (record.userInfo) {
      const country = record.userInfo.country || 'æœªçŸ¥';
      const city = record.userInfo.city || 'æœªçŸ¥';
      const ip = record.userInfo.ip || 'æœªçŸ¥';
      userLabel = ` [ğŸŒ ${country}-${city} | IP:${ip}]`;
    }
    
    option.value = `cloud_${record.id}`;
    option.textContent = `${timeStr} | ${record.card} | \u2713${record.success} \u2717${record.fail}${userLabel}`;
    cloudGroup.appendChild(option);
  });
  
  // æ’å…¥åˆ°é€‰æ‹©æ¡†çš„æœ€å‰é¢
  if (select.children.length > 0) {
    select.insertBefore(cloudGroup, select.children[0]);
  } else {
    select.appendChild(cloudGroup);
  }
}

/* ================= é€šçŸ¥æ¨é€åŠŸèƒ½ ================= */
async function sendNotifications(list, total, successCount, failCount, failArr) {
  // æå–ä¸»è¦å¡å·
  const cardMap = {};
  list.forEach(r => {
    const card = r.virtual_card_number || r.real_card_alias || 'æœªçŸ¥';
    cardMap[card] = (cardMap[card] || 0) + 1;
  });
  const mainCard = Object.keys(cardMap).sort((a, b) => cardMap[b] - cardMap[a])[0] || 'æœªçŸ¥';
  const maskCard = (card) => {
    if (!card || card === 'æœªçŸ¥' || card.length < 8) return card;
    return card.substring(0, 4) + '****' + card.substring(card.length - 4);
  };
  
  // Bark æ¨é€
  await sendBarkNotification(total, successCount, failCount, maskCard(mainCard));
  
  // é£ä¹¦æ¨é€
  await sendFeishuNotification(total, successCount, failCount, maskCard(mainCard), failArr);
}

// Bark æ¨é€
async function sendBarkNotification(total, successCount, failCount, card) {
  const BARK_KEY = '2mxT7sgNXpDBSw6uzbmoaV';
  const hasFail = failCount > 0;
  
  const title = hasFail ? 'âš ï¸ VCC äº¤æ˜“å¤±è´¥' : 'âœ… VCC äº¤æ˜“æˆåŠŸ';
  const body = `æ€»è®¡: ${total} | æˆåŠŸ: ${successCount} | å¤±è´¥: ${failCount}\nå¡å·: ${card}`;
  
  const url = `https://api.day.app/${BARK_KEY}/${encodeURIComponent(title)}/${encodeURIComponent(body)}?` +
    `sound=${hasFail ? 'alarm' : 'bell'}&` +
    `badge=${failCount}&` +
    `group=VCCäº¤æ˜“ç›‘æ§&` +
    `url=${encodeURIComponent(window.location.href)}`;
  
  try {
    await fetch(url);
    console.log('Bark æ¨é€æˆåŠŸ');
  } catch (error) {
    console.error('Bark æ¨é€å¤±è´¥:', error);
  }
}

// é£ä¹¦æ¨é€
async function sendFeishuNotification(total, successCount, failCount, card, failArr) {
  const WEBHOOK_URL = 'https://open.feishu.cn/open-apis/bot/v2/hook/f525db8f-b697-4976-82b4-b4088c08db7d';
  
  try {
    // æ„å»ºæ¶ˆæ¯å¡ç‰‡
    const hasFail = failCount > 0;
    const cardColor = hasFail ? 'red' : 'green';
    const title = hasFail ? 'âš ï¸ VCC äº¤æ˜“å¤±è´¥é€šçŸ¥' : 'âœ… VCC äº¤æ˜“æˆåŠŸé€šçŸ¥';
    
    // æ„å»ºå¤±è´¥åŸå› åˆ—è¡¨
    let failReasonText = '';
    if (failArr.length > 0) {
      failReasonText = '\n\n**ğŸš¨ å¤±è´¥åŸå›  Top 3:**\n';
      failArr.slice(0, 3).forEach(([reason, count], index) => {
        const fullExplanation = IN_CONTROL_RESPONSES[reason] || reason;
        const chineseName = fullExplanation.split(' | ')[0] || reason;
        failReasonText += `${index + 1}. ${chineseName} (${count}æ¬¡)\n`;
      });
    }
    
    const messageCard = {
      msg_type: 'interactive',
      card: {
        config: {
          wide_screen_mode: true
        },
        header: {
          title: {
            tag: 'plain_text',
            content: title
          },
          template: cardColor
        },
        elements: [
          {
            tag: 'div',
            text: {
              tag: 'lark_md',
              content: `**ğŸ“Š äº¤æ˜“ç»Ÿè®¡**\n` +
                `â€¢ æ€»è®¡: ${total} ç¬”\n` +
                `â€¢ æˆåŠŸ: ${successCount} ç¬” âœ…\n` +
                `â€¢ å¤±è´¥: ${failCount} ç¬” âŒ\n\n` +
                `**ğŸ’³ å¡å·ä¿¡æ¯**\n` +
                `â€¢ ${card}\n\n` +
                `**ğŸ• æŸ¥è¯¢æ—¶é—´**\n` +
                `â€¢ ${new Date().toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' })}` +
                failReasonText
            }
          },
          {
            tag: 'action',
            actions: [
              {
                tag: 'button',
                text: {
                  tag: 'plain_text',
                  content: 'ğŸ” æŸ¥çœ‹è¯¦æƒ…'
                },
                type: 'primary',
                url: window.location.href
              }
            ]
          }
        ]
      }
    };
    
    // 3. å‘é€æ¶ˆæ¯åˆ°é£ä¹¦ Webhook
    const response = await fetch(WEBHOOK_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(messageCard)
    });
    
    const result = await response.json();
    if (result.code === 0 || result.StatusCode === 0) {
      console.log('é£ä¹¦æ¨é€æˆåŠŸ');
    } else {
      console.error('é£ä¹¦æ¨é€å¤±è´¥:', result);
    }
    
  } catch (error) {
    console.error('é£ä¹¦æ¨é€å¤±è´¥:', error);
  }
}

/* ================= å¯åŠ¨ ================= */
updateHistorySelect();

// åŠ è½½äº‘ç«¯è®°å½•
setTimeout(() => {
  loadCloudRecords();
}, 1000);
</script>
</body>
</html>
