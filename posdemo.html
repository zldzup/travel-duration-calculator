<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é…’åº—POSåŸ¹è®­ç³»ç»Ÿ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; }
        
        body {
            background: #1a1d21;
            font-family: 'Microsoft YaHei', sans-serif;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 25px;
            padding: 15px;
            overflow: hidden;
        }

        /* å·¦ä¾§é¢æ¿ */
        .reference-panel {
            width: 340px;
            height: 90vh;
            display: flex;
            flex-direction: column;
            gap: 12px;
            overflow-y: auto;
        }

        .ref-card {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 15px;
            border: 1px solid rgba(255,255,255,0.1);
            flex-shrink: 0;
        }

        .ref-title {
            color: #f0c040;
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* ç­›é€‰å’Œé‡ç½®åŒºåŸŸ */
        .filter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            gap: 8px;
        }

        .filter-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            flex: 1;
        }

        .filter-btn {
            padding: 4px 10px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.05);
            color: #aaa;
            border-radius: 12px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .filter-btn:hover {
            border-color: #f0c040;
            color: #f0c040;
        }

        .filter-btn.active {
            background: rgba(240,192,64,0.2);
            border-color: #f0c040;
            color: #f0c040;
        }

        .reset-btn {
            padding: 4px 10px;
            border: 1px solid rgba(231, 76, 60, 0.4);
            background: rgba(231, 76, 60, 0.1);
            color: #e74c3c;
            border-radius: 12px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.2s;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .reset-btn:hover {
            background: rgba(231, 76, 60, 0.25);
            border-color: rgba(231, 76, 60, 0.6);
            color: #ff6b6b;
        }

        /* é“¶è¡Œå¡æ ·å¼ */
        .demo-card {
            height: 160px;
            border-radius: 12px;
            padding: 15px;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 12px;
            position: relative;
            border: 3px solid transparent;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .demo-card:hover { transform: translateY(-2px) scale(1.01); box-shadow: 0 8px 25px rgba(0,0,0,0.4); }
        .demo-card.active { border-color: #f0c040; box-shadow: 0 0 20px rgba(240,192,64,0.4); }

        .demo-card.visa { 
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            position: relative;
            overflow: hidden;
        }
        
        .demo-card.union { 
            background: linear-gradient(135deg, #c0c0c0 0%, #e8e8e8 100%); 
            color: #333;
            position: relative;
            overflow: hidden;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            position: relative;
            z-index: 1;
        }

        .card-type {
            font-size: 18px;
            font-style: italic;
            font-weight: bold;
            letter-spacing: 1px;
        }

        .card-tag {
            font-size: 10px;
            padding: 2px 6px;
            background: rgba(255,255,255,0.2);
            border-radius: 8px;
            font-weight: bold;
        }

        .card-chip {
            width: 35px;
            height: 28px;
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 50%, #d4af37 100%);
            border-radius: 6px;
            position: relative;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            margin: 3px 0;
        }
        
        .card-chip::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 24px;
            height: 16px;
            border: 1px solid rgba(0,0,0,0.3);
            border-radius: 3px;
        }

        .card-num {
            font-family: 'Courier New', monospace;
            font-size: 20px;
            letter-spacing: 2px;
            margin: 8px 0;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            position: relative;
            z-index: 1;
        }

        .card-info-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            position: relative;
            z-index: 1;
        }

        .card-holder-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .card-name {
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .card-expiry {
            font-size: 10px;
            opacity: 0.9;
        }

        .card-cvv-box {
            text-align: right;
        }

        .cvv-label {
            font-size: 9px;
            opacity: 0.8;
            margin-bottom: 1px;
            text-transform: uppercase;
        }

        .cvv-value {
            font-size: 14px;
            color: #ff6b6b;
            font-weight: bold;
            letter-spacing: 2px;
            font-family: 'Courier New', monospace;
            background: rgba(255,255,255,0.15);
            padding: 1px 6px;
            border-radius: 3px;
        }

        .card-hint {
            position: absolute;
            bottom: 12px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 11px;
            background: rgba(0,0,0,0.4);
            padding: 4px 12px;
            border-radius: 12px;
            font-weight: bold;
            white-space: nowrap;
        }

        /* å•æ®åˆ—è¡¨ - æˆæƒç å­—ä½“åŠ å¤§ */
        .receipt-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 350px;
            overflow-y: auto;
            padding-right: 3px;
        }

        .receipt-list::-webkit-scrollbar { width: 4px; }
        .receipt-list::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.2);
            border-radius: 2px;
        }

        .receipt-item {
            background: #fff;
            color: #000;
            padding: 12px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.5;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            position: relative;
            border-left: 3px solid #999;
            transition: all 0.2s;
            cursor: pointer;
        }

        .receipt-item:hover { transform: translateX(3px); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        .receipt-item.selectable { border-left-color: #27ae60; box-shadow: 0 0 6px rgba(39, 174, 96, 0.2); }
        .receipt-item.selectable:hover { box-shadow: 0 0 12px rgba(39, 174, 96, 0.4); }
        .receipt-item.active { border-left-color: #f0c040; background: #fffef0; box-shadow: 0 0 15px rgba(240, 192, 64, 0.4); }
        .receipt-item.voided, .receipt-item.refunded { opacity: 0.6; border-left-color: #ccc; background: #f9f9f9; }
        
        .receipt-item.partial { border-left-color: #ff9800; background: #fff8e1; }
        
        .receipt-item.voided::after {
            content: 'å·²å–æ¶ˆ'; position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%) rotate(-15deg);
            font-size: 20px; color: #e74c3c; border: 2px solid #e74c3c;
            padding: 4px 10px; font-weight: bold; opacity: 0.5;
            pointer-events: none;
        }
        
        .receipt-item.refunded::after {
            content: 'å·²é€€æ¬¾'; position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%) rotate(-15deg);
            font-size: 20px; color: #ff9800; border: 2px solid #ff9800;
            padding: 4px 10px; font-weight: bold; opacity: 0.5;
            pointer-events: none;
        }

        .receipt-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 6px; padding-bottom: 4px; border-bottom: 1px dashed #ddd;
        }

        .receipt-type { font-weight: bold; font-size: 13px; color: #d32f2f; }
        .receipt-date { font-size: 10px; color: #666; }
        .receipt-row { display: flex; justify-content: space-between; margin: 3px 0; font-size: 11px; }
        .receipt-label { color: #666; }
        .receipt-value { font-weight: bold; }

        /* æˆæƒç æ ·å¼ - å­—ä½“åŠ å¤§åŠ ç²— */
        .auth-code-box {
            background: #fffde7; 
            border: 2px solid #f44336;
            padding: 6px; 
            margin: 8px 0; 
            text-align: center;
            font-size: 16px; 
            font-weight: bold; 
            color: #d32f2f;
            border-radius: 4px;
            letter-spacing: 2px;
            font-family: 'Courier New', monospace;
        }
        
        .rrn-box { 
            background: #f5f5f5;
            border: 1px solid #999;
            padding: 4px; 
            margin: 6px 0; 
            text-align: center;
            font-size: 11px; 
            letter-spacing: 1px; 
            color: #333;
            border-radius: 4px;
        }

        /* å°ç¥¨å†å²å­˜æ¡£åŒº */
        .receipt-archive {
            flex: 1;
            min-height: 200px;
            display: flex;
            flex-direction: column;
        }

        .archive-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            overflow-y: auto;
            max-height: 300px;
            padding-right: 3px;
        }

        .archive-grid::-webkit-scrollbar { width: 4px; }
        .archive-grid::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.2);
            border-radius: 2px;
        }

        /* çƒ­æ•çº¸å°ç¥¨æ ·å¼ */
        .receipt-tile {
            background: #f5f5dc;
            color: #333;
            padding: 12px 8px;
            font-family: 'Courier New', monospace;
            font-size: 10px;
            line-height: 1.4;
            cursor: pointer;
            position: relative;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 2px;
            background-image: 
                linear-gradient(to right, rgba(0,0,0,0.05) 0%, transparent 5%, transparent 95%, rgba(0,0,0,0.05) 100%),
                repeating-linear-gradient(
                    transparent,
                    transparent 20px,
                    rgba(0,0,0,0.03) 20px,
                    rgba(0,0,0,0.03) 21px
                );
        }

        .receipt-tile::before,
        .receipt-tile::after {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            height: 4px;
            background: 
                linear-gradient(135deg, transparent 45%, #f5f5dc 45%, #f5f5dc 55%, transparent 55%),
                linear-gradient(-135deg, transparent 45%, #f5f5dc 45%, #f5f5dc 55%, transparent 55%);
            background-size: 8px 8px;
            background-position: 0 0, 4px 0;
        }

        .receipt-tile::before { top: -4px; transform: rotate(180deg); }
        .receipt-tile::after { bottom: -4px; }

        .receipt-tile:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 8px 20px rgba(0,0,0,0.4);
            z-index: 10;
        }

        .receipt-tile.voided {
            background: #e8e8e8;
            opacity: 0.7;
        }

        .receipt-tile.voided::after {
            content: 'VOID';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-30deg);
            font-size: 24px;
            color: #e74c3c;
            border: 3px solid #e74c3c;
            padding: 4px 12px;
            font-weight: bold;
            opacity: 0.6;
            pointer-events: none;
            font-family: 'Arial Black', sans-serif;
            letter-spacing: 2px;
        }

        .receipt-tile.refunded {
            background: #fff8e1;
            opacity: 0.8;
        }

        .receipt-tile.refunded::after {
            content: 'REFUND';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-30deg);
            font-size: 18px;
            color: #ff9800;
            border: 2px solid #ff9800;
            padding: 4px 8px;
            font-weight: bold;
            opacity: 0.6;
            pointer-events: none;
            font-family: 'Arial Black', sans-serif;
        }

        .receipt-tile.partial {
            background: #fff3e0;
            border: 1px solid #ff9800;
        }

        .tile-header {
            text-align: center;
            border-bottom: 1px dashed #999;
            padding-bottom: 4px;
            margin-bottom: 4px;
            font-weight: bold;
            font-size: 11px;
            color: #d32f2f;
        }

        .tile-row {
            display: flex;
            justify-content: space-between;
            margin: 2px 0;
            font-size: 9px;
        }

        .tile-amount {
            text-align: center;
            font-size: 14px;
            font-weight: bold;
            margin: 6px 0;
            border-top: 1px solid #ccc;
            border-bottom: 1px solid #ccc;
            padding: 4px 0;
        }

        .tile-date {
            text-align: center;
            font-size: 8px;
            color: #666;
            margin-top: 4px;
        }

        .tile-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #f0c040;
            color: #000;
            font-size: 9px;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            z-index: 20;
        }

        /* å°ç¥¨è¯¦æƒ…å¼¹çª— */
        .receipt-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            backdrop-filter: blur(5px);
        }

        .receipt-modal.show {
            display: flex;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .receipt-detail {
            background: #f5f5dc;
            width: 320px;
            max-height: 80vh;
            overflow-y: auto;
            padding: 30px 20px;
            font-family: 'Courier New', monospace;
            color: #333;
            position: relative;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            transform: scale(0.9);
            transition: transform 0.3s;
        }

        .receipt-modal.show .receipt-detail {
            transform: scale(1);
        }

        .receipt-detail::before,
        .receipt-detail::after {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            height: 12px;
            background: 
                linear-gradient(135deg, transparent 45%, #f5f5dc 45%, #f5f5dc 55%, transparent 55%),
                linear-gradient(-135deg, transparent 45%, #f5f5dc 45%, #f5f5dc 55%, transparent 55%);
            background-size: 20px 20px;
            background-position: 0 0, 10px 0;
        }

        .receipt-detail::before { 
            top: -12px; 
            transform: rotate(180deg);
            filter: drop-shadow(0 -2px 2px rgba(0,0,0,0.1));
        }
        .receipt-detail::after { 
            bottom: -12px;
            filter: drop-shadow(0 2px 2px rgba(0,0,0,0.1));
        }

        .detail-close {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.1);
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            color: #666;
            transition: all 0.2s;
            z-index: 10;
        }

        .detail-close:hover {
            background: rgba(0,0,0,0.2);
            color: #000;
            transform: rotate(90deg);
        }

        .detail-header {
            text-align: center;
            border-bottom: 2px dashed #999;
            padding-bottom: 15px;
            margin-bottom: 15px;
        }

        .detail-title {
            font-size: 20px;
            font-weight: bold;
            color: #d32f2f;
            margin-bottom: 5px;
            letter-spacing: 2px;
        }

        .detail-subtitle {
            font-size: 12px;
            color: #666;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            font-size: 13px;
            padding: 4px 0;
            border-bottom: 1px dotted #ccc;
        }

        .detail-label { color: #666; }
        .detail-value { font-weight: bold; }

        .detail-amount {
            text-align: center;
            font-size: 28px;
            font-weight: bold;
            margin: 20px 0;
            padding: 15px;
            border-top: 2px solid #333;
            border-bottom: 2px solid #333;
        }

        /* è¯¦æƒ…é¡µæˆæƒç æ ·å¼ - å­—ä½“åŠ å¤§ */
        .detail-code {
            background: #fffde7;
            border: 2px solid #f44336;
            padding: 15px;
            text-align: center;
            margin: 15px 0;
            font-size: 24px;
            font-weight: bold;
            color: #d32f2f;
            letter-spacing: 4px;
            font-family: 'Courier New', monospace;
            border-radius: 6px;
        }

        .detail-footer {
            text-align: center;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 2px dashed #999;
            font-size: 11px;
            color: #666;
        }

        .detail-stamp {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-30deg);
            font-size: 48px;
            border: 4px solid;
            padding: 10px 20px;
            font-weight: bold;
            opacity: 0.3;
            pointer-events: none;
            font-family: 'Arial Black', sans-serif;
            letter-spacing: 4px;
        }

        .detail-stamp.void { color: #e74c3c; border-color: #e74c3c; }
        .detail-stamp.refund { color: #ff9800; border-color: #ff9800; }
        .detail-stamp.partial { color: #ff9800; border-color: #ff9800; }

        /* éƒ¨åˆ†å–æ¶ˆä¿¡æ¯æ¡† */
        .partial-info {
            background: rgba(255, 152, 0, 0.1);
            border: 1px solid #ff9800;
            border-radius: 6px;
            padding: 10px;
            margin: 10px 0;
            font-size: 12px;
        }

        .partial-info .info-row {
            display: flex;
            justify-content: space-between;
            margin: 4px 0;
            color: #e65100;
        }

        /* POSè®¾å¤‡ */
        .pos-device {
            width: 380px;
            background: linear-gradient(180deg, #3a3f45 0%, #2a2d32 100%);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.6);
            flex-shrink: 0;
        }

        .pos-screen {
            background: #c4cfc4; width: 100%; height: 260px;
            border-radius: 8px; padding: 20px;
            font-family: 'Courier New', monospace; color: #1a1f1a;
            font-size: 16px;
            line-height: 1.4; margin-bottom: 15px;
            position: relative; overflow: hidden;
        }

        .screen-header {
            display: flex; justify-content: space-between;
            border-bottom: 2px solid rgba(0,0,0,0.2);
            padding-bottom: 8px; margin-bottom: 12px;
            font-weight: bold; font-size: 14px;
        }

        .screen-body {
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            height: calc(100% - 40px); text-align: center;
        }

        .amount-display { font-size: 36px; font-weight: bold; margin: 15px 0; color: #2e7d32; }

        .input-display {
            background: rgba(0,0,0,0.1); border: 3px solid #555;
            border-radius: 8px; padding: 15px 30px; font-size: 28px;
            letter-spacing: 8px; min-width: 180px; margin: 10px 0;
        }
        
        .input-display.active { border-color: #1a1f1a; animation: blink 1s infinite; }
        .input-display.error { border-color: #e74c3c; animation: shake 0.5s; }

        @keyframes blink { 50% { border-color: #999; } }
        @keyframes shake { 
            25% { transform: translateX(-10px); } 
            75% { transform: translateX(10px); } 
        }

        .pin-dots { display: flex; gap: 15px; justify-content: center; margin: 20px 0; }
        .pin-dot { width: 20px; height: 20px; border: 3px solid #555; border-radius: 50%; background: transparent; }
        .pin-dot.filled { background: #1a1f1a; border-color: #1a1f1a; }

        .card-slots { display: flex; justify-content: center; gap: 30px; margin-bottom: 15px; }
        .slot { text-align: center; cursor: pointer; padding: 10px; border-radius: 6px; transition: all 0.3s; }
        .slot:hover { background: rgba(255,255,255,0.1); }
        .slot.highlight { background: rgba(240,192,64,0.2); box-shadow: 0 0 20px rgba(240,192,64,0.4); }

        .slot-bar {
            width: 60px; height: 6px; background: linear-gradient(180deg, #111, #333);
            border-radius: 3px; margin: 0 auto 6px; box-shadow: inset 0 1px 3px rgba(0,0,0,0.8);
        }
        .slot-label { font-size: 11px; color: #888; }

        .keypad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 12px; }
        .key {
            height: 52px; background: linear-gradient(180deg, #4a5059 0%, #3a4049 100%);
            border: none; border-radius: 10px; color: #fff; font-size: 20px;
            font-weight: bold; cursor: pointer; box-shadow: 0 3px 0 #2a2d32;
            transition: all 0.1s;
        }
        .key:active { transform: translateY(3px); box-shadow: 0 0 0 #2a2d32; }
        .key.func { background: linear-gradient(180deg, #f0c040 0%, #d4a017 100%); color: #000; font-size: 12px; }
        .key.red { background: linear-gradient(180deg, #e74c3c 0%, #c0392b 100%); }
        .key.green { background: linear-gradient(180deg, #27ae60 0%, #1e8449 100%); }

        .func-keys { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; margin-bottom: 12px; }
        .fkey {
            height: 42px; background: #2a2d32; border: 1px solid #3a3f45;
            color: #888; border-radius: 8px; font-size: 11px;
            cursor: pointer; transition: all 0.2s; font-weight: bold;
        }
        .fkey:hover { background: #3a3f45; color: #fff; }
        .fkey.active { background: #f0c040; color: #000; }

        .printer { background: #25282d; border-radius: 8px; padding: 10px; text-align: center; }
        .paper-slot { height: 4px; background: #000; border-radius: 3px; margin-bottom: 6px; }

        .receipt-out {
            position: absolute; bottom: -250px; left: 50%; transform: translateX(-50%);
            width: 340px; background: #fff; color: #000; padding: 25px;
            font-family: 'Courier New', monospace; font-size: 14px; line-height: 1.5;
            box-shadow: 0 15px 40px rgba(0,0,0,0.4); border-radius: 0 0 6px 6px;
            opacity: 0; transition: all 0.5s; z-index: 100;
        }
        .receipt-out.show { bottom: 30px; opacity: 1; }

        /* å³ä¾§é¢æ¿ */
        .control-panel {
            width: 300px;
            height: 90vh;
            display: flex;
            flex-direction: column;
            gap: 12px;
            overflow-y: auto;
        }

        .control-card {
            background: rgba(255,255,255,0.05); border-radius: 12px;
            padding: 15px; border: 1px solid rgba(255,255,255,0.1);
            flex-shrink: 0;
        }

        .control-title { color: #888; font-size: 12px; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 1px; font-weight: bold; }

        .scene-btn {
            width: 100%; padding: 12px; margin-bottom: 8px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.05); color: #fff;
            border-radius: 10px; cursor: pointer; font-size: 13px;
            text-align: left; transition: all 0.3s;
            display: flex; align-items: center; justify-content: space-between;
        }
        .scene-btn:hover { border-color: #f0c040; background: rgba(240,192,64,0.1); }
        .scene-btn.active { background: rgba(240,192,64,0.2); border-color: #f0c040; color: #f0c040; }

        .status-tag { display: inline-block; padding: 3px 8px; background: rgba(255,255,255,0.1); border-radius: 6px; font-size: 10px; }

        .diff-box { background: rgba(240,192,64,0.1); border: 1px solid rgba(240,192,64,0.3); border-radius: 8px; padding: 12px; margin-top: 8px; font-size: 12px; line-height: 1.8; }
        .diff-box h4 { color: #f0c040; margin-bottom: 6px; font-size: 13px; }
        .diff-item { display: flex; align-items: flex-start; gap: 8px; margin: 6px 0; color: #ccc; font-size: 11px; }
        .diff-icon { color: #f0c040; font-weight: bold; }

        .flow-hint {
            background: rgba(39, 174, 96, 0.1); border: 1px solid rgba(39, 174, 96, 0.3);
            border-radius: 8px; padding: 10px; margin-top: 8px;
            font-size: 11px; color: #27ae60; line-height: 1.6;
        }

        /* éŸ³æ•ˆæŒ‡ç¤ºå™¨ */
        .sound-indicator {
            position: fixed; top: 20px; right: 20px; background: rgba(0,0,0,0.8);
            padding: 10px 20px; border-radius: 20px; color: #f0c040;
            font-size: 14px; display: flex; align-items: center; gap: 10px;
            opacity: 0; transition: opacity 0.3s; z-index: 1000;
        }
        .sound-indicator.show { opacity: 1; }

        .sound-wave { display: flex; gap: 3px; align-items: center; height: 20px; }
        .sound-bar { width: 3px; background: #f0c040; animation: soundWave 0.5s ease-in-out infinite; }
        .sound-bar:nth-child(1) { height: 8px; animation-delay: 0s; }
        .sound-bar:nth-child(2) { height: 15px; animation-delay: 0.1s; }
        .sound-bar:nth-child(3) { height: 10px; animation-delay: 0.2s; }
        .sound-bar:nth-child(4) { height: 18px; animation-delay: 0.3s; }

        @keyframes soundWave { 0%, 100% { transform: scaleY(0.5); } 50% { transform: scaleY(1); } }

        .error-text {
            color: #e74c3c;
            font-size: 12px;
            margin-top: 8px;
            opacity: 0;
            transition: opacity 0.3s;
            font-weight: bold;
        }
        .error-text.show { opacity: 1; }
        
        /* é‡‘é¢åˆ‡æ¢æç¤º */
        .amount-toggle {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            justify-content: center;
        }
        
        .toggle-btn {
            padding: 6px 12px;
            border: 1px solid rgba(0,0,0,0.2);
            background: rgba(255,255,255,0.5);
            border-radius: 15px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .toggle-btn.active {
            background: #e74c3c;
            color: white;
            border-color: #e74c3c;
        }
        
        .toggle-btn.partial {
            background: #ff9800;
            color: white;
            border-color: #ff9800;
        }
    </style>
</head>
<body>

<div class="sound-indicator" id="soundIndicator">
    <span>ğŸ”Š</span>
    <div class="sound-wave">
        <div class="sound-bar"></div><div class="sound-bar"></div>
        <div class="sound-bar"></div><div class="sound-bar"></div>
    </div>
    <span id="soundText">æ’­æ”¾éŸ³æ•ˆ...</span>
</div>

<!-- å°ç¥¨è¯¦æƒ…å¼¹çª— -->
<div class="receipt-modal" id="receiptModal" onclick="closeReceiptDetail(event)">
    <div class="receipt-detail" onclick="event.stopPropagation()">
        <button class="detail-close" onclick="closeReceiptDetail()">Ã—</button>
        <div id="receiptDetailContent"></div>
    </div>
</div>

<div class="reference-panel">
    <div class="ref-card">
        <div class="ref-title">ğŸ’³ æ¨¡æ‹Ÿé“¶è¡Œå¡ï¼ˆç‚¹å‡»æ“ä½œï¼‰</div>
        
        <div class="demo-card visa" id="visaCard" onclick="swipeCard()">
            <div class="card-header">
                <div class="card-type">VISA</div>
                <div class="card-tag">ç£æ¡å¡</div>
            </div>
            <div class="card-num">4111 2222 3333 4444</div>
            <div class="card-info-row">
                <div class="card-holder-info">
                    <div class="card-name">ZHANG SAN</div>
                    <div class="card-expiry">12/28</div>
                </div>
                <div class="card-cvv-box">
                    <div class="cvv-label">CVV2</div>
                    <div class="cvv-value">123</div>
                </div>
            </div>
            <div class="card-hint">ç‚¹å‡»åˆ·å¡ â†’</div>
        </div>

        <div class="demo-card union" id="unionCard" onclick="insertCard()">
            <div class="card-header">
                <div class="card-type">é“¶è”</div>
                <div class="card-tag">èŠ¯ç‰‡å¡</div>
            </div>
            <div class="card-chip"></div>
            <div class="card-num">6222 8888 8888 8888</div>
            <div class="card-info-row">
                <div class="card-holder-info">
                    <div class="card-name">LI SI</div>
                    <div class="card-expiry">05/27</div>
                </div>
                <div class="card-cvv-box">
                    <div class="cvv-label">CVN2</div>
                    <div class="cvv-value">456</div>
                </div>
            </div>
            <div class="card-hint">ç‚¹å‡»æ’å¡ â†‘</div>
        </div>
        
        <div style="font-size: 11px; color: #888; text-align: center; padding: 6px; background: rgba(255,255,255,0.03); border-radius: 4px;">
            ğŸ’¡ éªŒè¯å¯†ç å³å¡é¢CVV2/CVN2ï¼ˆ3ä½ï¼‰
        </div>
    </div>

    <div class="ref-card" style="flex: 1; display: flex; flex-direction: column;">
        <div class="ref-title" id="receiptTitle">ğŸ“‹ å†å²äº¤æ˜“è®°å½•</div>
        
        <div class="filter-header">
            <div class="filter-tabs">
                <button class="filter-btn active" onclick="filterReceipts('all')">å…¨éƒ¨</button>
                <button class="filter-btn" onclick="filterReceipts('auth')">é¢„æˆæƒ</button>
                <button class="filter-btn" onclick="filterReceipts('sale')">æ¶ˆè´¹</button>
                <button class="filter-btn" onclick="filterReceipts('complete')">å·²å®Œæˆ</button>
                <button class="filter-btn" onclick="filterReceipts('voided')">å·²å–æ¶ˆ</button>
                <button class="filter-btn" onclick="filterReceipts('refunded')">å·²é€€æ¬¾</button>
            </div>
            <button class="reset-btn" onclick="resetAllHistory()" title="æ¸…ç©ºæ‰€æœ‰äº¤æ˜“è®°å½•">
                ğŸ—‘ï¸ æ¸…ç©º
            </button>
        </div>
        
        <div class="receipt-list" id="receiptList" style="flex: 1;"></div>
        <div class="flow-hint" id="flowHint" style="display: none; margin-top: 8px;"></div>
    </div>

    <!-- å°ç¥¨å†å²å­˜æ¡£åŒº -->
    <div class="ref-card receipt-archive">
        <div class="ref-title">ğŸ§¾ å°ç¥¨å­˜æ¡£ <span style="font-size: 11px; color: #888; font-weight: normal;">(ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…)</span></div>
        <div class="archive-grid" id="receiptArchive"></div>
    </div>
</div>

<div class="pos-device">
    <div class="pos-screen" id="screen">
        <div class="screen-header">
            <span>ğŸ¨ é…’åº—æ”¶é“¶ç³»ç»Ÿ Pro</span>
            <span id="statusText">Ready</span>
        </div>
        <div class="screen-body" id="screenBody">
            <div style="font-size: 18px; font-weight: bold; margin-bottom: 12px;">æ¬¢è¿ä½¿ç”¨</div>
            <div style="color: #555; font-size: 14px;">è¯·é€‰æ‹©äº¤æ˜“ç±»å‹å¼€å§‹åŸ¹è®­</div>
        </div>
        <div class="receipt-out" id="receiptOut"></div>
    </div>

    <div class="card-slots">
        <div class="slot" id="icSlot" onclick="insertCard()">
            <div class="slot-bar" style="width: 50px; height: 6px;"></div>
            <div class="slot-label">ICæ’æ§½</div>
        </div>
        <div class="slot" id="magSlot" onclick="swipeCard()">
            <div class="slot-bar"></div>
            <div class="slot-label">ç£æ¡å¡æ§½</div>
        </div>
    </div>

    <div class="func-keys">
        <button class="fkey" onclick="selectFunc('auth')">é¢„æˆæƒ</button>
        <button class="fkey" onclick="selectFunc('complete')">å®Œæˆ</button>
        <button class="fkey" onclick="selectFunc('void')">å–æ¶ˆ</button>
        <button class="fkey" onclick="selectFunc('refund')">é€€æ¬¾</button>
        <button class="fkey" onclick="selectFunc('sale')">æ¶ˆè´¹</button>
    </div>

    <div class="keypad">
        <button class="key" onclick="pressKey('1')">1</button>
        <button class="key" onclick="pressKey('2')">2</button>
        <button class="key" onclick="pressKey('3')">3</button>
        <button class="key" onclick="pressKey('4')">4</button>
        <button class="key" onclick="pressKey('5')">5</button>
        <button class="key" onclick="pressKey('6')">6</button>
        <button class="key" onclick="pressKey('7')">7</button>
        <button class="key" onclick="pressKey('8')">8</button>
        <button class="key" onclick="pressKey('9')">9</button>
        <button class="key func" onclick="pressKey('CLEAR')">æ¸…é™¤</button>
        <button class="key" onclick="pressKey('0')">0</button>
        <button class="key func" onclick="pressKey('BACK')">é€€æ ¼</button>
        <button class="key red" onclick="pressKey('CANCEL')">å–æ¶ˆ</button>
        <button class="key" onclick="pressKey('00')">00</button>
        <button class="key green" onclick="pressKey('ENTER')">ç¡®è®¤</button>
    </div>

    <div class="printer">
        <div class="paper-slot"></div>
        <div style="font-size: 10px; color: #555;">ğŸ–¨ï¸ çƒ­æ•æ‰“å°æœºå°±ç»ª</div>
    </div>
</div>

<div class="control-panel">
    <div class="control-card">
        <div class="control-title">ğŸ¯ äº¤æ˜“åœºæ™¯</div>
        <button class="scene-btn active" onclick="setScene('auth')">
            <span>ğŸ¨ å…¥ä½é¢„æˆæƒ</span><span class="status-tag">å†»ç»“æŠ¼é‡‘</span>
        </button>
        <button class="scene-btn" onclick="setScene('complete')">
            <span>ğŸ’³ é¢„æˆæƒå®Œæˆ</span><span class="status-tag">ç»“ç®—æ‰£æ¬¾</span>
        </button>
        <button class="scene-btn" onclick="setScene('void')">
            <span>ğŸš« é¢„æˆæƒå–æ¶ˆ</span><span class="status-tag">å…¨é¢/éƒ¨åˆ†</span>
        </button>
        <button class="scene-btn" onclick="setScene('refund')">
            <span>â†©ï¸ é€€æ¬¾</span><span class="status-tag">éœ€åŸäº¤æ˜“</span>
        </button>
        <button class="scene-btn" onclick="setScene('sale')">
            <span>ğŸ›’ é¤é¥®æ¶ˆè´¹</span><span class="status-tag">ç›´æ¥æ‰£æ¬¾</span>
        </button>
    </div>

    <div class="control-card">
        <div class="control-title">ğŸ“š æ“ä½œæŒ‡å—</div>
        <div class="diff-box">
            <h4>ğŸš« é¢„æˆæƒå–æ¶ˆï¼ˆVoidï¼‰</h4>
            <div class="diff-item"><span class="diff-icon">â€¢</span><span><b>é»˜è®¤ï¼š</b>å…¨é¢å–æ¶ˆï¼ˆé‡Šæ”¾å…¨éƒ¨æŠ¼é‡‘ï¼‰</span></div>
            <div class="diff-item"><span class="diff-icon">â€¢</span><span><b>å¯é€‰ï¼š</b>ä¿®æ”¹é‡‘é¢ä¸ºéƒ¨åˆ†å–æ¶ˆ</span></div>
            <div class="diff-item"><span class="diff-icon">â€¢</span><span><b>å‰©ä½™ï¼š</b>éƒ¨åˆ†å–æ¶ˆåå‰©ä½™é‡‘é¢ç»§ç»­å†»ç»“</span></div>
            <div class="diff-item"><span class="diff-icon">â€¢</span><span><b>éªŒè¯ï¼š</b>éœ€åŸå¡+åŸæˆæƒç </span></div>
        </div>
        <div class="diff-box" style="margin-top: 12px;">
            <h4>ğŸ’³ é¢„æˆæƒå®Œæˆï¼ˆCompleteï¼‰</h4>
            <div class="diff-item"><span class="diff-icon">â€¢</span><span><b>ç»“ç®—ï¼š</b>è¾“å…¥å®é™…æ¶ˆè´¹é‡‘é¢</span></div>
            <div class="diff-item"><span class="diff-icon">â€¢</span><span><b>è§£å†»ï¼š</b>å·®é¢è‡ªåŠ¨è§£å†»è‡³å®¢æˆ·å¡å†…</span></div>
            <div class="diff-item"><span class="diff-icon">â€¢</span><span><b>å°ç¥¨ï¼š</b>ç”Ÿæˆç»“ç®—å‡­è¯å¹¶å­˜æ¡£</span></div>
        </div>
    </div>
</div>

<script>
// éŸ³å“ç³»ç»Ÿ
const AudioSys = {
    ctx: null,
    init() {
        if (!this.ctx) {
            this.ctx = new (window.AudioContext || window.webkitAudioContext)();
        }
    },
    playTone(freq, duration, type = 'sine') {
        this.init();
        try {
            const osc = this.ctx.createOscillator();
            const gain = this.ctx.createGain();
            osc.connect(gain);
            gain.connect(this.ctx.destination);
            osc.frequency.value = freq;
            osc.type = type;
            gain.gain.setValueAtTime(0.3, this.ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
            osc.start(this.ctx.currentTime);
            osc.stop(this.ctx.currentTime + duration);
        } catch(e) { console.log('Audio play failed', e); }
    },
    success() {
        this.playTone(880, 0.1);
        setTimeout(() => this.playTone(1100, 0.2), 100);
        this.showIndicator('âœ… äº¤æ˜“æˆåŠŸ', '#27ae60');
    },
    error() {
        this.playTone(200, 0.3, 'sawtooth');
        setTimeout(() => this.playTone(150, 0.3, 'sawtooth'), 150);
        this.showIndicator('âŒ æ“ä½œå¤±è´¥', '#e74c3c');
    },
    keypress() { this.playTone(800, 0.05); },
    paper() {
        this.playTone(400, 0.05);
        setTimeout(() => this.playTone(600, 0.05), 50);
        setTimeout(() => this.playTone(800, 0.05), 100);
    },
    alert() {
        this.playTone(600, 0.1);
        setTimeout(() => this.playTone(600, 0.1), 150);
        this.showIndicator('ğŸ”” è¯·æ³¨æ„', '#f0c040');
    },
    showIndicator(text, color) {
        const ind = document.getElementById('soundIndicator');
        const txt = document.getElementById('soundText');
        txt.textContent = text; txt.style.color = color;
        ind.classList.add('show');
        setTimeout(() => ind.classList.remove('show'), 1500);
    }
};

// å†å²äº¤æ˜“æ•°æ® - é»˜è®¤æ¸…ç©º
let historyData = [];

let currentFilter = 'all';

const state = {
    step: 'idle',
    mode: 'auth',
    input: '',
    amount: 0,
    preauthAmount: 0,
    authCode: '',
    rrn: '',
    selectedReceipt: null,
    errorSim: null,
    currentCard: null,
    currentCardCvv: null,
    voidType: 'full'
};

function log(msg, type = 'normal') {
    console.log(`[${type.toUpperCase()}] ${msg}`);
}

function resetAllHistory() {
    if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰äº¤æ˜“è®°å½•å—ï¼Ÿ\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼Œå°†åˆ é™¤æ‰€æœ‰é¢„æˆæƒã€æ¶ˆè´¹ã€é€€æ¬¾ç­‰å†å²æ•°æ®ã€‚')) {
        return;
    }
    
    if (!confirm('å†æ¬¡ç¡®è®¤ï¼šæ˜¯å¦æ¸…ç©ºå…¨éƒ¨å†å²äº¤æ˜“è®°å½•ï¼Ÿ')) {
        return;
    }
    
    historyData = [];
    
    state.selectedReceipt = null;
    state.step = 'idle';
    state.input = '';
    state.amount = 0;
    state.preauthAmount = 0;
    state.authCode = '';
    state.rrn = '';
    state.currentCard = null;
    state.currentCardCvv = null;
    
    document.querySelectorAll('.receipt-item').forEach(el => el.classList.remove('active'));
    document.getElementById('visaCard').classList.remove('active');
    document.getElementById('unionCard').classList.remove('active');
    document.getElementById('icSlot').classList.remove('highlight');
    document.getElementById('magSlot').classList.remove('highlight');
    
    initReceiptList();
    initReceiptArchive();
    
    AudioSys.alert();
    updateScreen(`
        <div style="color: #e74c3c; font-weight: bold; margin-bottom: 15px; font-size: 20px;">ğŸ—‘ï¸ è®°å½•å·²æ¸…ç©º</div>
        <div style="font-size: 14px; color: #555;">æ‰€æœ‰å†å²äº¤æ˜“è®°å½•å·²æ¸…é™¤<br>ç³»ç»Ÿå·²é‡ç½®ä¸ºåˆå§‹çŠ¶æ€</div>
    `);
    
    log('æ‰€æœ‰äº¤æ˜“è®°å½•å·²æ¸…ç©º', 'warning');
}

function filterReceipts(filterType) {
    currentFilter = filterType;
    
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    initReceiptList();
    AudioSys.keypress();
}

function initReceiptList() {
    const list = document.getElementById('receiptList');
    const title = document.getElementById('receiptTitle');
    
    let filteredData = historyData;
    switch(currentFilter) {
        case 'auth':
            filteredData = historyData.filter(r => r.type === 'auth' && !r.voided && !r.refunded);
            break;
        case 'sale':
            filteredData = historyData.filter(r => r.type === 'sale' && !r.refunded);
            break;
        case 'complete':
            filteredData = historyData.filter(r => r.type === 'complete' && !r.refunded);
            break;
        case 'voided':
            filteredData = historyData.filter(r => r.voided);
            break;
        case 'refunded':
            filteredData = historyData.filter(r => r.refunded);
            break;
        case 'all':
        default:
            filteredData = historyData;
    }
    
    const count = filteredData.length;
    const filterNames = {
        'all': 'å…¨éƒ¨',
        'auth': 'é¢„æˆæƒ',
        'sale': 'æ¶ˆè´¹',
        'complete': 'å·²å®Œæˆ',
        'voided': 'å·²å–æ¶ˆ',
        'refunded': 'å·²é€€æ¬¾'
    };
    title.innerHTML = `ğŸ“‹ ${filterNames[currentFilter]} (${count}ç¬”)`;
    
    if (count === 0) {
        list.innerHTML = `
            <div style="color: #888; text-align: center; padding: 30px 20px; font-size: 12px;">
                <div style="font-size: 32px; margin-bottom: 10px;">ğŸ“­</div>
                æš‚æ— ${filterNames[currentFilter]}è®°å½•<br>
                <span style="font-size: 11px; color: #666; margin-top: 8px; display: block;">å¯å¼€å§‹è¿›è¡Œæ–°äº¤æ˜“æˆ–åˆ‡æ¢ç­›é€‰æ¡ä»¶</span>
            </div>
        `;
        return;
    }
    
    list.innerHTML = filteredData.map(item => {
        let isSelectable = false;
        let selectHint = '';
        let statusClass = '';
        
        if (item.voided) {
            statusClass = 'voided';
            selectHint = item.type === 'partialVoid' ? 'éƒ¨åˆ†å–æ¶ˆ' : 'å·²å–æ¶ˆ';
        } else if (item.refunded) {
            statusClass = 'refunded';
            selectHint = 'å·²é€€æ¬¾';
        } else {
            switch(state.mode) {
                case 'void':
                    isSelectable = item.type === 'auth';
                    selectHint = isSelectable ? 'âœ“ å¯å–æ¶ˆ' : 'ä¸å¯å–æ¶ˆ';
                    break;
                case 'complete':
                    isSelectable = item.type === 'auth';
                    selectHint = isSelectable ? 'âœ“ å¯ç»“ç®—' : 'ä¸å¯ç»“ç®—';
                    break;
                case 'refund':
                    isSelectable = (item.type === 'sale' || item.type === 'complete');
                    selectHint = isSelectable ? 'âœ“ å¯é€€æ¬¾' : 'ä¸å¯é€€æ¬¾';
                    break;
                default:
                    selectHint = 'æŸ¥çœ‹';
            }
            if (isSelectable) statusClass = 'selectable';
        }
        
        if (state.selectedReceipt && state.selectedReceipt.id === item.id) {
            statusClass += ' active';
        }
        
        const isAuth = item.type === 'auth';
        const codeBox = isAuth ? 
            `<div class="auth-code-box">æˆæƒ:${item.auth}</div>` :
            `<div class="rrn-box">RRN:${item.rrn}</div>`;
        
        const extraInfo = item.remainingAmount ? 
            `<div style="font-size:10px; color:#ff9800; text-align:center; margin-top:2px;">å‰©ä½™å†»ç»“:Â¥${item.remainingAmount.toFixed(2)}</div>` : '';
        
        return `
        <div class="receipt-item ${statusClass}" 
             onclick="selectReceipt(${item.id})" id="receipt-${item.id}">
            <div class="receipt-header">
                <span class="receipt-type">${item.typeName}</span>
                <span class="receipt-date">${item.date}</span>
            </div>
            <div class="receipt-row"><span class="receipt-label">å¡:</span><span class="receipt-value">${item.card}</span></div>
            <div class="receipt-row"><span class="receipt-label">é‡‘é¢:</span><span class="receipt-value">Â¥${item.amount.toFixed(2)}</span></div>
            ${codeBox}
            ${extraInfo}
            <div style="color: ${isSelectable ? '#27ae60' : '#999'}; text-align: center; margin-top: 2px; font-size: 10px;">
                ${selectHint}
            </div>
        </div>`;
    }).join('');
}

function initReceiptArchive() {
    const archive = document.getElementById('receiptArchive');
    
    if (historyData.length === 0) {
        archive.innerHTML = `
            <div style="grid-column: 1 / -1; text-align: center; padding: 40px 20px; color: #888; font-size: 12px;">
                <div style="font-size: 40px; margin-bottom: 10px;">ğŸ§¾</div>
                æš‚æ— å°ç¥¨å­˜æ¡£<br>
                <span style="font-size: 11px; color: #666;">å®Œæˆäº¤æ˜“åå°†è‡ªåŠ¨ç”Ÿæˆå°ç¥¨</span>
            </div>
        `;
        return;
    }
    
    archive.innerHTML = historyData.map(item => {
        let className = 'receipt-tile';
        let badge = '';
        
        if (item.voided) {
            className += ' voided';
            const isPartial = item.type === 'partialVoid' || item.remainingAmount > 0;
            badge = `<span class="tile-badge" style="background: ${isPartial ? '#ff9800' : '#e74c3c'};">${isPartial ? 'éƒ¨åˆ†å–æ¶ˆ' : 'å·²å–æ¶ˆ'}</span>`;
        } else if (item.refunded) {
            className += ' refunded';
            badge = '<span class="tile-badge" style="background: #ff9800;">å·²é€€æ¬¾</span>';
        } else if (item.type === 'auth') {
            badge = '<span class="tile-badge" style="background: #27ae60;">é¢„æˆæƒ</span>';
        } else if (item.type === 'complete') {
            badge = '<span class="tile-badge" style="background: #2196f3;">å·²å®Œæˆ</span>';
        }
        
        const cardLast4 = item.card.split(' ').pop() || '****';
        
        return `
        <div class="${className}" onclick="showReceiptDetail(${item.id})">
            ${badge}
            <div class="tile-header">${item.typeName}</div>
            <div class="tile-row"><span>å¡å·:</span><span>****${cardLast4}</span></div>
            <div class="tile-row"><span>æ—¶é—´:</span><span>${item.date}</span></div>
            <div class="tile-amount">Â¥${item.amount.toFixed(2)}</div>
            ${item.remainingAmount ? `<div style="text-align:center; font-size:9px; color:#ff9800;">å‰©ä½™:Â¥${item.remainingAmount.toFixed(2)}</div>` : ''}
            ${item.auth ? `<div style="text-align: center; font-size: 9px; color: #d32f2f; font-weight: bold;">æˆæƒ:${item.auth}</div>` : ''}
        </div>
        `;
    }).join('');
}

function showReceiptDetail(id) {
    AudioSys.paper();
    const item = historyData.find(r => r.id === id);
    if (!item) return;
    
    const modal = document.getElementById('receiptModal');
    const content = document.getElementById('receiptDetailContent');
    
    let statusStamp = '';
    let statusText = '';
    let statusColor = '#27ae60';
    
    if (item.voided) {
        const isPartial = item.type === 'partialVoid' || item.remainingAmount > 0;
        if (isPartial) {
            statusStamp = '<div class="detail-stamp partial">PARTIAL</div>';
            statusText = 'ã€éƒ¨åˆ†å–æ¶ˆã€‘';
            statusColor = '#ff9800';
        } else {
            statusStamp = '<div class="detail-stamp void">VOID</div>';
            statusText = 'ã€å·²å–æ¶ˆã€‘';
            statusColor = '#e74c3c';
        }
    } else if (item.refunded) {
        statusStamp = '<div class="detail-stamp refund">REFUNDED</div>';
        statusText = 'ã€å·²é€€æ¬¾ã€‘';
        statusColor = '#ff9800';
    }
    
    const typeNames = {
        'auth': 'é¢„æˆæƒå‡­è¯',
        'sale': 'æ¶ˆè´¹å‡­è¯',
        'complete': 'é¢„æˆæƒå®Œæˆ',
        'void': 'é¢„æˆæƒå–æ¶ˆ',
        'partialVoid': 'éƒ¨åˆ†é¢„æˆæƒå–æ¶ˆ',
        'refund': 'é€€æ¬¾å‡­è¯'
    };
    
    let partialInfoHtml = '';
    if (item.type === 'partialVoid' || (item.voided && item.remainingAmount > 0)) {
        partialInfoHtml = `
        <div class="partial-info">
            <div class="info-row"><span>åŸé¢„æˆæƒé‡‘é¢</span><span>Â¥${(item.amount + (item.remainingAmount || 0)).toFixed(2)}</span></div>
            <div class="info-row"><span>æœ¬æ¬¡å–æ¶ˆé‡‘é¢</span><span style="color:#e74c3c;">-Â¥${item.amount.toFixed(2)}</span></div>
            <div class="info-row" style="border-top:1px solid #ff9800; padding-top:4px; margin-top:4px; font-weight:bold;">
                <span>å‰©ä½™å†»ç»“é‡‘é¢</span><span style="color:#27ae60;">Â¥${(item.remainingAmount || 0).toFixed(2)}</span>
            </div>
        </div>`;
    } else if (item.type === 'complete' && item.preauthAmount) {
        partialInfoHtml = `
        <div class="partial-info" style="border-color:#2196f3; background:rgba(33,150,243,0.1);">
            <div class="info-row"><span>åŸé¢„æˆæƒé‡‘é¢</span><span>Â¥${item.preauthAmount.toFixed(2)}</span></div>
            <div class="info-row"><span>å®é™…ç»“ç®—é‡‘é¢</span><span style="color:#2196f3;">Â¥${item.amount.toFixed(2)}</span></div>
            <div class="info-row" style="border-top:1px solid #2196f3; padding-top:4px; margin-top:4px; font-weight:bold;">
                <span>è§£å†»å·®é¢</span><span style="color:#27ae60;">Â¥${(item.preauthAmount - item.amount).toFixed(2)}</span>
            </div>
        </div>`;
    }
    
    content.innerHTML = `
        ${statusStamp}
        <div class="detail-header">
            <div class="detail-title">ğŸ¨ æ ¼å…°å¾·å¤§é…’åº—</div>
            <div class="detail-subtitle">Grand Hotel POS System</div>
            <div style="margin-top: 8px; font-size: 14px; color: ${statusColor}; font-weight: bold;">${typeNames[item.type] || item.typeName} ${statusText}</div>
        </div>
        
        <div class="detail-row">
            <span class="detail-label">äº¤æ˜“æ—¶é—´</span>
            <span class="detail-value">${item.date}</span>
        </div>
        <div class="detail-row">
            <span class="detail-label">æµæ°´å·</span>
            <span class="detail-value">${item.rrn}</span>
        </div>
        <div class="detail-row">
            <span class="detail-label">å¡å·</span>
            <span class="detail-value">${item.card}</span>
        </div>
        <div class="detail-row">
            <span class="detail-label">å¡ç±»å‹</span>
            <span class="detail-value">${item.card.startsWith('4') ? 'VISA ä¿¡ç”¨å¡' : 'é“¶è” å€Ÿè®°å¡'}</span>
        </div>
        
        ${partialInfoHtml}
        
        <div class="detail-amount">
            <div style="font-size: 12px; color: #666; margin-bottom: 4px;">${item.type === 'partialVoid' ? 'æœ¬æ¬¡å–æ¶ˆé‡‘é¢' : 'äº¤æ˜“é‡‘é¢'}</div>
            Â¥${item.amount.toFixed(2)}
        </div>
        
        ${item.auth ? `
        <div class="detail-code">
            <div style="font-size: 11px; margin-bottom: 4px; font-weight: normal; color: #666;">æˆæƒç  Authorization Code</div>
            ${item.auth}
        </div>
        ` : ''}
        
        <div class="detail-row">
            <span class="detail-label">å‚è€ƒå· RRN</span>
            <span class="detail-value" style="font-size: 11px; letter-spacing: 1px;">${item.rrn}</span>
        </div>
        
        ${item.note ? `<div style="margin:10px 0; padding:8px; background:rgba(0,0,0,0.05); border-radius:4px; font-size:11px; color:#666; text-align:center;">${item.note}</div>` : ''}
        
        <div class="detail-footer">
            <div style="font-size: 10px; color: #999; margin-bottom: 4px;">æ„Ÿè°¢æ‚¨çš„å…‰ä¸´</div>
            <div style="font-size: 9px; color: #bbb;">è¯·å¦¥å–„ä¿ç®¡æ­¤å‡­è¯</div>
            <div style="margin-top: 10px; font-family: monospace; font-size: 10px;">
                ${Array(20).fill('â”').join('')}
            </div>
        </div>
    `;
    
    modal.classList.add('show');
}

function closeReceiptDetail(e) {
    if (!e || e.target.id === 'receiptModal') {
        document.getElementById('receiptModal').classList.remove('show');
    }
}

function selectReceipt(id) {
    AudioSys.keypress();
    const receipt = historyData.find(r => r.id === id);
    if (!receipt) return;
    
    let canSelect = false;
    
    switch(state.mode) {
        case 'void':
            canSelect = receipt.type === 'auth' && !receipt.voided;
            break;
        case 'complete':
            canSelect = receipt.type === 'auth' && !receipt.voided;
            break;
        case 'refund':
            canSelect = (receipt.type === 'sale' || receipt.type === 'complete') && !receipt.refunded;
            break;
        default:
            showReceiptDetail(id);
            return;
    }
    
    if (state.step === 'select_receipt' && !canSelect) {
        AudioSys.error();
        const el = document.getElementById(`receipt-${id}`);
        el.style.animation = 'shake 0.5s';
        setTimeout(() => el.style.animation = '', 500);
        return;
    }
    
    if (state.step !== 'select_receipt') {
        showReceiptDetail(id);
        return;
    }
    
    state.selectedReceipt = receipt;
    state.authCode = receipt.auth || '';
    state.rrn = receipt.rrn || '';
    state.preauthAmount = receipt.amount;
    
    document.querySelectorAll('.receipt-item').forEach(el => el.classList.remove('active'));
    document.getElementById(`receipt-${id}`).classList.add('active');
    
    setTimeout(() => {
        if (state.mode === 'void') {
            showVoidAmountInput();
        } else if (state.mode === 'complete' || state.mode === 'refund') {
            showAmountInput();
        }
    }, 300);
}

function showVoidAmountInput() {
    state.step = 'void_amount';
    state.input = '';
    state.amount = state.preauthAmount;
    state.voidType = 'full';
    
    updateScreen(`
        <div style="margin-bottom: 8px; font-size: 18px; font-weight: bold;">é¢„æˆæƒå–æ¶ˆé‡‘é¢</div>
        <div style="font-size: 12px; color: #666; margin-bottom: 10px;">å¯ä¿®æ”¹é‡‘é¢è¿›è¡Œéƒ¨åˆ†å–æ¶ˆ</div>
        <div class="input-display active" id="inputDisplay">Â¥${state.preauthAmount.toFixed(2)}</div>
        <div class="amount-toggle">
            <button class="toggle-btn active" onclick="setVoidType('full')" id="btnFull">å…¨é¢å–æ¶ˆ</button>
            <button class="toggle-btn partial" onclick="setVoidType('partial')" id="btnPartial">éƒ¨åˆ†å–æ¶ˆ</button>
        </div>
        <div style="font-size: 11px; color: #888; margin-top: 8px;" id="voidHint">
            ç‚¹å‡»ç¡®è®¤è¿›è¡Œå…¨é¢å–æ¶ˆï¼Œæˆ–ä¿®æ”¹é‡‘é¢åç¡®è®¤
        </div>
        <div class="error-text" id="errorText"></div>
    `);
}

function setVoidType(type) {
    AudioSys.keypress();
    state.voidType = type;
    
    document.getElementById('btnFull').classList.toggle('active', type === 'full');
    document.getElementById('btnPartial').classList.toggle('active', type === 'partial');
    
    if (type === 'full') {
        state.input = '';
        state.amount = state.preauthAmount;
        document.getElementById('inputDisplay').textContent = 'Â¥' + state.preauthAmount.toFixed(2);
        document.getElementById('voidHint').textContent = 'å°†é‡Šæ”¾å…¨éƒ¨å†»ç»“é‡‘é¢';
    } else {
        document.getElementById('voidHint').textContent = 'è¯·è¾“å…¥è¦å–æ¶ˆçš„é‡‘é¢ï¼ˆå‰©ä½™å°†ç»§ç»­å†»ç»“ï¼‰';
        document.getElementById('inputDisplay').textContent = 'Â¥0.00';
        state.input = '';
        state.amount = 0;
    }
}

function setScene(mode) {
    AudioSys.init();
    AudioSys.keypress();
    
    document.querySelectorAll('.scene-btn').forEach(b => b.classList.remove('active'));
    event.currentTarget.classList.add('active');
    
    state.mode = mode;
    state.step = 'idle';
    state.input = '';
    state.amount = 0;
    state.preauthAmount = 0;
    state.authCode = '';
    state.rrn = '';
    state.selectedReceipt = null;
    state.errorSim = null;
    state.currentCard = null;
    state.currentCardCvv = null;
    state.voidType = 'full';
    
    document.getElementById('visaCard').classList.remove('active');
    document.getElementById('unionCard').classList.remove('active');
    document.getElementById('icSlot').classList.remove('highlight');
    document.getElementById('magSlot').classList.remove('highlight');
    document.querySelectorAll('.fkey').forEach(k => k.classList.remove('active'));
    
    initReceiptList();
    
    const hint = document.getElementById('flowHint');
    
    switch(mode) {
        case 'auth':
        case 'sale':
            hint.style.display = 'none';
            showAmountInput();
            break;
        case 'complete':
            hint.innerHTML = '<b>é¢„æˆæƒå®Œæˆï¼š</b><br>1. é€‰<span style="color:#27ae60">ç»¿è‰²</span>å•æ®<br>2. è¾“å…¥ç»“ç®—é‡‘é¢ï¼ˆå¯å°äºé¢„æˆæƒï¼‰<br>3. åˆ·åŸå¡+æˆæƒç <br>4. <span style="color:#2196f3">å·®é¢è‡ªåŠ¨è§£å†»</span>';
            hint.style.display = 'block';
            updateScreen(`
                <div style="color: #f0c040; font-weight: bold; margin-bottom: 12px; font-size: 18px;">ğŸ“‹ é€‰æ‹©è¦ç»“ç®—çš„é¢„æˆæƒ</div>
                <div style="font-size: 13px; color: #555;">ç‚¹å‡»ä¸‹æ–¹å°ç¥¨å¯æŸ¥çœ‹è¯¦æƒ…</div>
            `);
            state.step = 'select_receipt';
            AudioSys.alert();
            break;
        case 'void':
            hint.innerHTML = '<b>é¢„æˆæƒå–æ¶ˆï¼š</b><br>1. é€‰<span style="color:#27ae60">ç»¿è‰²</span>å•æ®<br>2. é€‰æ‹©<span style="color:#e74c3c">å…¨é¢</span>æˆ–<span style="color:#ff9800">éƒ¨åˆ†</span>å–æ¶ˆ<br>3. è¾“å…¥é‡‘é¢ï¼ˆå…¨é¢æ—¶é»˜è®¤å¯ç›´æ¥ç¡®è®¤ï¼‰<br>4. åˆ·åŸå¡+æˆæƒç ';
            hint.style.display = 'block';
            updateScreen(`
                <div style="color: #f0c040; font-weight: bold; margin-bottom: 12px; font-size: 18px;">ğŸ“‹ é€‰æ‹©è¦å–æ¶ˆçš„é¢„æˆæƒ</div>
                <div style="font-size: 13px; color: #555;">æ”¯æŒå…¨é¢å–æ¶ˆæˆ–éƒ¨åˆ†é‡‘é¢å–æ¶ˆ</div>
            `);
            state.step = 'select_receipt';
            AudioSys.alert();
            break;
        case 'refund':
            hint.innerHTML = '<b>é€€æ¬¾ï¼š</b><br>1. é€‰<span style="color:#27ae60">ç»¿è‰²</span>å•æ®<br>2. è¾“å…¥é‡‘é¢<br>3. è¾“å…¥å‚è€ƒå·';
            hint.style.display = 'block';
            updateScreen(`
                <div style="color: #f0c040; font-weight: bold; margin-bottom: 12px; font-size: 18px;">ğŸ“‹ é€‰æ‹©è¦é€€æ¬¾çš„äº¤æ˜“</div>
                <div style="font-size: 13px; color: #555;">ç‚¹å‡»ä¸‹æ–¹å°ç¥¨å¯æŸ¥çœ‹è¯¦æƒ…</div>
            `);
            state.step = 'select_receipt';
            AudioSys.alert();
            break;
    }
}

function showAmountInput() {
    state.step = 'amount';
    state.input = '';
    
    let title, hint;
    switch(state.mode) {
        case 'auth': title = 'é¢„æˆæƒé‡‘é¢'; hint = 'å†»ç»“æŠ¼é‡‘'; break;
        case 'sale': title = 'æ¶ˆè´¹é‡‘é¢'; hint = 'ç›´æ¥æ‰£æ¬¾'; break;
        case 'complete': title = 'ç»“ç®—é‡‘é¢'; hint = `æœ€å¤§Â¥${state.preauthAmount.toFixed(2)}ï¼Œå·®é¢å°†è§£å†»`; break;
        case 'refund': title = 'é€€æ¬¾é‡‘é¢'; hint = `æœ€å¤§Â¥${state.selectedReceipt ? state.selectedReceipt.amount.toFixed(2) : '0.00'}`; break;
        default: title = 'é‡‘é¢'; hint = '';
    }
    
    updateScreen(`
        <div style="margin-bottom: 12px; font-size: 18px; font-weight: bold;">${title}</div>
        <div class="input-display active" id="inputDisplay">Â¥0.00</div>
        <div style="font-size: 12px; color: #555; margin-top: 12px; font-weight: bold;">${hint}</div>
        <div class="error-text" id="errorText"></div>
    `);
}

function showCardWait() {
    state.step = 'card';
    document.getElementById('visaCard').classList.add('active');
    document.getElementById('unionCard').classList.add('active');
    document.getElementById('icSlot').classList.add('highlight');
    document.getElementById('magSlot').classList.add('highlight');
    
    let msg = '';
    const isVoid = state.mode === 'void';
    const isPartial = state.voidType === 'partial';
    
    if (isVoid) {
        if (isPartial) {
            msg = `éƒ¨åˆ†å–æ¶ˆ<br><span style="font-size: 14px; color: #ff9800;">å–æ¶ˆÂ¥${state.amount.toFixed(2)}</span><br><span style="font-size: 12px; color: #666;">å‰©ä½™Â¥${(state.preauthAmount - state.amount).toFixed(2)}</span>`;
        } else {
            msg = `å…¨é¢å–æ¶ˆ<br><span style="font-size: 14px; color: #e74c3c;">Â¥${state.amount.toFixed(2)}</span>`;
        }
    } else if (state.amount > 0) {
        msg = `Â¥${state.amount.toFixed(2)}`;
    }
    
    updateScreen(`
        <div style="font-size: 18px; font-weight: bold; margin-bottom: 15px;">è¯·åˆ·å¡/æ’å¡</div>
        <div style="font-size: 20px; color: ${isVoid ? (isPartial ? '#ff9800' : '#e74c3c') : '#2e7d32'}; margin-bottom: 12px; font-weight: bold; line-height: 1.4;">${msg}</div>
        <div style="font-size: 12px; color: #666;">ç‚¹å‡»å·¦ä¾§é“¶è¡Œå¡</div>
    `);
}

function swipeCard() { handleCardAction('ç£æ¡å¡', '4111 2222 3333 4444', '123'); }
function insertCard() { handleCardAction('èŠ¯ç‰‡å¡', '6222 8888 8888 8888', '456'); }

function handleCardAction(cardType, cardNum, cvv) {
    if (state.step !== 'card') {
        AudioSys.error();
        return;
    }
    
    AudioSys.keypress();
    
    state.currentCard = cardNum;
    state.currentCardCvv = cvv;
    
    document.getElementById('visaCard').classList.remove('active');
    document.getElementById('unionCard').classList.remove('active');
    document.getElementById('icSlot').classList.remove('highlight');
    document.getElementById('magSlot').classList.remove('highlight');
    
    if ((state.mode === 'void' || state.mode === 'complete') && state.selectedReceipt) {
        const originalLastFour = state.selectedReceipt.card.slice(-4);
        const currentLastFour = cardNum.slice(-4);
        
        if (currentLastFour !== originalLastFour) {
            AudioSys.error();
            updateScreen(`
                <div style="color: #e74c3c; font-weight: bold; margin-bottom: 12px; font-size: 20px;">ğŸš« å¡ç‰‡ä¸åŒ¹é…</div>
                <div style="font-size: 13px; color: #555;">
                    å½“å‰:${currentLastFour} éœ€è¦:${originalLastFour}<br>
                    <span style="color: #e74c3c;">å¿…é¡»ä½¿ç”¨åŸå¡ï¼</span>
                </div>
            `);
            state.step = 'error';
            return;
        }
    }
    
    if (state.mode === 'void' || state.mode === 'complete' || state.mode === 'refund') {
        showAuthInput();
    } else {
        showPinInput();
    }
}

function showAuthInput() {
    state.step = 'auth';
    state.input = '';
    
    const isRefund = state.mode === 'refund';
    const isPartial = state.mode === 'void' && state.voidType === 'partial';
    
    updateScreen(`
        <div style="margin-bottom: 12px; font-size: 18px; font-weight: bold;">
            ${isRefund ? 'è¾“å…¥12ä½å‚è€ƒå·(RRN)' : 'è¾“å…¥6ä½æˆæƒç '}
        </div>
        <div class="input-display active" id="inputDisplay" style="letter-spacing: ${isRefund ? '5px' : '10px'}; font-size: 22px;">
            ${isRefund ? '_ _ _ _ _ _ _ _ _ _ _ _' : '_ _ _ _ _ _'}
        </div>
        <div style="font-size: 11px; color: #555; margin-top: 12px;">
            ${isRefund ? 'æŸ¥çœ‹å·¦ä¾§å•æ®RRN' : isPartial ? 'éƒ¨åˆ†å–æ¶ˆéœ€éªŒè¯åŸæˆæƒç ' : 'æŸ¥çœ‹å·¦ä¾§å•æ®æˆæƒç '}
        </div>
        <div class="error-text" id="errorText"></div>
    `);
}

function showPinInput() {
    state.step = 'pin';
    state.input = '';
    updateScreen(`
        <div style="margin-bottom: 12px; font-size: 18px; font-weight: bold;">è¾“å…¥CVV2ï¼ˆ3ä½ï¼‰</div>
        <div style="font-size: 11px; color: #666; margin-bottom: 8px;">å¡ç‰‡èƒŒé¢ç­¾åæ å³ä¾§3ä½</div>
        <div class="pin-dots" id="pinDots">
            <div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div>
        </div>
        <div class="error-text" id="errorText"></div>
    `);
}

function pressKey(key) {
    AudioSys.keypress();
    if (key === 'CANCEL') { resetScreen(); return; }
    
    switch(state.step) {
        case 'amount': handleAmountKey(key); break;
        case 'void_amount': handleVoidAmountKey(key); break;
        case 'auth': handleAuthKey(key); break;
        case 'pin': handlePinKey(key); break;
    }
}

function handleVoidAmountKey(key) {
    const display = document.getElementById('inputDisplay');
    const error = document.getElementById('errorText');
    
    if (key === 'CLEAR') { 
        state.input = ''; 
        state.amount = 0;
        display.textContent = 'Â¥0.00';
        error.classList.remove('show'); 
    }
    else if (key === 'BACK') { 
        state.input = state.input.slice(0, -1); 
        if (state.input === '') {
            state.amount = 0;
            display.textContent = 'Â¥0.00';
        } else {
            state.amount = parseFloat(state.input) / 100;
            display.textContent = 'Â¥' + state.amount.toFixed(2);
        }
    }
    else if (key === 'ENTER') {
        if (state.input.length === 0 && state.voidType === 'full') {
            state.amount = state.preauthAmount;
            showCardWait();
            return;
        }
        
        if (state.amount <= 0) {
            AudioSys.error();
            error.textContent = 'é‡‘é¢å¿…é¡»å¤§äº0';
            error.classList.add('show');
            return;
        }
        
        if (state.amount > state.preauthAmount) {
            AudioSys.error();
            error.textContent = `ä¸èƒ½è¶…è¿‡é¢„æˆæƒé‡‘é¢Â¥${state.preauthAmount.toFixed(2)}`;
            error.classList.add('show');
            return;
        }
        
        if (state.amount === state.preauthAmount) {
            state.voidType = 'full';
        } else {
            state.voidType = 'partial';
        }
        
        showCardWait();
        return;
    }
    else if (/\d/.test(key) && state.input.length < 8) { 
        state.input += key; 
        state.amount = parseFloat(state.input) / 100;
        display.textContent = 'Â¥' + state.amount.toFixed(2);
        
        if (state.amount > 0 && state.amount < state.preauthAmount) {
            document.getElementById('btnFull').classList.remove('active');
            document.getElementById('btnPartial').classList.add('active');
        } else if (state.amount === state.preauthAmount) {
            document.getElementById('btnFull').classList.add('active');
            document.getElementById('btnPartial').classList.remove('active');
        }
    }
    else if (key === '00' && state.input.length < 7) { 
        state.input += '00'; 
        state.amount = parseFloat(state.input) / 100;
        display.textContent = 'Â¥' + state.amount.toFixed(2);
    }
}

function handleAmountKey(key) {
    const display = document.getElementById('inputDisplay');
    const error = document.getElementById('errorText');
    
    if (key === 'CLEAR') { state.input = ''; error.classList.remove('show'); }
    else if (key === 'BACK') { state.input = state.input.slice(0, -1); }
    else if (key === 'ENTER') {
        if (state.input.length === 0) return;
        const amt = parseFloat(state.input) / 100;
        
        if (amt <= 0) {
            AudioSys.error();
            error.textContent = 'é‡‘é¢>0';
            error.classList.add('show');
            return;
        }
        
        if (state.mode === 'complete' && amt > state.preauthAmount) {
            AudioSys.error();
            error.textContent = `è¶…é™é¢Â¥${state.preauthAmount.toFixed(2)}`;
            error.classList.add('show');
            return;
        }
        
        state.amount = amt;
        showCardWait();
        return;
    }
    else if (/\d/.test(key) && state.input.length < 8) { state.input += key; }
    else if (key === '00' && state.input.length < 7) { state.input += '00'; }
    
    display.textContent = state.input === '' ? 'Â¥0.00' : 'Â¥' + (parseFloat(state.input) / 100).toFixed(2);
}

function handleAuthKey(key) {
    const display = document.getElementById('inputDisplay');
    const error = document.getElementById('errorText');
    const isRefund = state.mode === 'refund';
    const maxLen = isRefund ? 12 : 6;
    const targetCode = isRefund ? state.rrn : state.authCode;
    
    if (key === 'CLEAR') { state.input = ''; error.classList.remove('show'); }
    else if (key === 'BACK') { state.input = state.input.slice(0, -1); }
    else if (key === 'ENTER') {
        if (state.input.length !== maxLen) {
            AudioSys.error();
            error.textContent = `éœ€${maxLen}ä½`;
            error.classList.add('show');
            return;
        }
        
        if (state.input !== targetCode) {
            AudioSys.error();
            error.textContent = 'é”™è¯¯ï¼';
            error.classList.add('show');
            return;
        }
        
        processTransaction();
        return;
    }
    else if (/\d/.test(key) && state.input.length < maxLen) { state.input += key; }
    
    let str = '';
    for (let i = 0; i < maxLen; i++) {
        str += i < state.input.length ? state.input[i] : '_';
        if (i < maxLen - 1) str += ' ';
    }
    display.textContent = str;
}

function handlePinKey(key) {
    const dots = document.querySelectorAll('.pin-dot');
    const error = document.getElementById('errorText');
    
    if (key === 'CLEAR') { state.input = ''; error.classList.remove('show'); }
    else if (key === 'BACK') { state.input = state.input.slice(0, -1); }
    else if (key === 'ENTER') {
        if (state.input.length !== 3) {
            AudioSys.error();
            error.textContent = 'éœ€3ä½CVV';
            error.classList.add('show');
            return;
        }
        
        if (state.input !== state.currentCardCvv) {
            AudioSys.error();
            error.textContent = 'CVVé”™è¯¯';
            error.classList.add('show');
            state.input = '';
            dots.forEach(dot => dot.classList.remove('filled'));
            return;
        }
        
        processTransaction();
        return;
    }
    else if (/\d/.test(key) && state.input.length < 3) { state.input += key; }
    
    dots.forEach((dot, idx) => {
        dot.classList.toggle('filled', idx < state.input.length);
    });
}

function processTransaction() {
    state.step = 'processing';
    const isVoid = state.mode === 'void' && state.voidType === 'full';
    const isPartial = state.mode === 'void' && state.voidType === 'partial';
    const isComplete = state.mode === 'complete';
    
    updateScreen(`
        <div style="font-weight: bold; margin-bottom: 15px; font-size: 18px; color: ${isVoid ? '#e74c3c' : isPartial ? '#ff9800' : '#1a1f1a'};">
            ${isVoid ? 'å…¨é¢å–æ¶ˆä¸­...' : isPartial ? 'éƒ¨åˆ†å–æ¶ˆä¸­...' : isComplete ? 'ç»“ç®—ä¸­...' : 'å¤„ç†ä¸­...'}
        </div>
        <div style="width: 180px; height: 4px; background: #ddd; border-radius: 2px; overflow: hidden;">
            <div style="height: 100%; background: ${isVoid ? '#e74c3c' : isPartial ? '#ff9800' : isComplete ? '#2196f3' : '#27ae60'}; width: 0%; animation: load 1.5s forwards;"></div>
        </div>
        <style>@keyframes load { to { width: 100%; } }</style>
    `);
    
    setTimeout(() => {
        if (state.mode === 'void' && state.selectedReceipt) {
            if (state.voidType === 'partial') {
                const cancelAmount = state.amount;
                const remainingAmount = state.preauthAmount - cancelAmount;
                
                historyData.unshift({
                    id: Date.now(),
                    type: 'partialVoid',
                    typeName: 'éƒ¨åˆ†é¢„æˆæƒå–æ¶ˆ',
                    card: state.selectedReceipt.card,
                    amount: cancelAmount,
                    remainingAmount: remainingAmount,
                    originalAmount: state.preauthAmount,
                    auth: state.authCode,
                    rrn: Date.now().toString().slice(-12),
                    date: new Date().toLocaleString('zh-CN', {month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit'}),
                    status: 'normal',
                    voided: true,
                    refunded: false,
                    note: `åŸé¢„æˆæƒÂ¥${state.preauthAmount.toFixed(2)}ï¼Œå–æ¶ˆÂ¥${cancelAmount.toFixed(2)}ï¼Œå‰©ä½™Â¥${remainingAmount.toFixed(2)}ç»§ç»­å†»ç»“`
                });
                
                state.selectedReceipt.amount = remainingAmount;
                state.selectedReceipt.note = `å·²éƒ¨åˆ†å–æ¶ˆÂ¥${cancelAmount.toFixed(2)}ï¼Œå‰©ä½™Â¥${remainingAmount.toFixed(2)}`;
                
            } else {
                state.selectedReceipt.voided = true;
                state.selectedReceipt.typeName = 'é¢„æˆæƒå–æ¶ˆ(å…¨é¢)';
            }
            AudioSys.success();
            showSuccess();
        } else if (state.mode === 'complete' && state.selectedReceipt) {
            const newRrn = Date.now().toString().slice(-12);
            historyData.unshift({
                id: Date.now(),
                type: 'complete',
                typeName: 'é¢„æˆæƒå®Œæˆ',
                card: state.currentCard ? (state.currentCard === '4111 2222 3333 4444' ? '4111 22** **** 4444' : '6222 88** **** 8888') : state.selectedReceipt.card,
                amount: state.amount,
                preauthAmount: state.preauthAmount,
                auth: state.authCode,
                rrn: newRrn,
                originalRrn: state.selectedReceipt.rrn,
                date: new Date().toLocaleString('zh-CN', {month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit'}),
                status: 'normal',
                voided: false,
                refunded: false,
                note: `åŸé¢„æˆæƒÂ¥${state.preauthAmount.toFixed(2)}ï¼Œç»“ç®—Â¥${state.amount.toFixed(2)}ï¼Œå·®é¢Â¥${(state.preauthAmount - state.amount).toFixed(2)}å·²è§£å†»`
            });
            
            state.selectedReceipt.completed = true;
            state.selectedReceipt.voided = true;
            
            AudioSys.success();
            showSuccess();
        } else if (state.mode === 'refund' && state.selectedReceipt) {
            state.selectedReceipt.refunded = true;
            AudioSys.success();
            showSuccess();
        } else if (state.mode === 'auth') {
            state.authCode = Math.floor(100000 + Math.random() * 900000).toString();
            historyData.unshift({
                id: Date.now(),
                type: 'auth',
                typeName: 'é¢„æˆæƒ',
                card: '4111 22** **** 4444',
                amount: state.amount,
                auth: state.authCode,
                rrn: Date.now().toString().slice(-12),
                date: new Date().toLocaleString('zh-CN', {month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit'}),
                status: 'normal',
                voided: false,
                refunded: false
            });
            AudioSys.success();
            showSuccess();
        } else if (state.mode === 'sale') {
            state.authCode = Math.floor(100000 + Math.random() * 900000).toString();
            historyData.unshift({
                id: Date.now(),
                type: 'sale',
                typeName: 'é¤é¥®æ¶ˆè´¹',
                card: state.currentCard ? (state.currentCard === '4111 2222 3333 4444' ? '4111 22** **** 4444' : '6222 88** **** 8888') : '4111 22** **** 4444',
                amount: state.amount,
                auth: state.authCode,
                rrn: Date.now().toString().slice(-12),
                date: new Date().toLocaleString('zh-CN', {month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit'}),
                status: 'normal',
                voided: false,
                refunded: false
            });
            AudioSys.success();
            showSuccess();
        }
    }, 1500);
}

function showSuccess() {
    state.step = 'done';
    const titles = {
        auth: 'é¢„æˆæƒ', 
        complete: 'é¢„æˆæƒå®Œæˆ', 
        sale: 'æ¶ˆè´¹', 
        void: 'é¢„æˆæƒå–æ¶ˆ', 
        refund: 'é€€æ¬¾'
    };
    const isVoid = state.mode === 'void' && state.voidType === 'full';
    const isPartial = state.mode === 'void' && state.voidType === 'partial';
    const isComplete = state.mode === 'complete';
    
    let extraInfo = '';
    if (isPartial) {
        extraInfo = `<div style="font-size: 12px; color: #ff9800; margin-top: 8px;">
            å–æ¶ˆÂ¥${state.amount.toFixed(2)}<br>
            å‰©ä½™Â¥${(state.preauthAmount - state.amount).toFixed(2)}ç»§ç»­å†»ç»“
        </div>`;
    } else if (isComplete) {
        extraInfo = `<div style="font-size: 12px; color: #2196f3; margin-top: 8px;">
            ç»“ç®—Â¥${state.amount.toFixed(2)}<br>
            å·®é¢Â¥${(state.preauthAmount - state.amount).toFixed(2)}å·²è§£å†»
        </div>`;
    } else if (isVoid) {
        extraInfo = '<div style="font-size: 12px; color: #27ae60; margin-top: 8px;">âœ“ å…¨éƒ¨èµ„é‡‘å·²é‡Šæ”¾</div>';
    }
    
    const successColor = isVoid ? '#e74c3c' : isPartial ? '#ff9800' : isComplete ? '#2196f3' : '#27ae60';
    const typeName = isPartial ? 'éƒ¨åˆ†å–æ¶ˆ' : (titles[state.mode] || 'äº¤æ˜“');
    
    updateScreen(`
        <div style="font-size: 48px; color: ${successColor}; margin-bottom: 10px;">âœ“</div>
        <div style="font-weight: bold; font-size: 20px; margin-bottom: 8px; color: ${isVoid || isPartial ? '#e74c3c' : '#1a1f1a'};">${typeName}æˆåŠŸ</div>
        ${state.mode === 'auth' ? `<div style="font-size: 14px; color: #d32f2f;"><b>æˆæƒç :${state.authCode}</b></div>` : ''}
        ${(!isVoid && !isPartial) ? (state.amount > 0 ? `<div style="font-size: 14px; color: #555;">Â¥${state.amount.toFixed(2)}</div>` : '') : ''}
        ${isVoid ? `<div style="font-size: 14px; color: #555;">é‡Šæ”¾Â¥${state.amount.toFixed(2)}</div>` : ''}
        ${extraInfo}
    `);
    
    initReceiptList();
    initReceiptArchive();
    printReceipt();
}

function printReceipt() {
    const receipt = document.getElementById('receiptOut');
    const titles = {
        auth: 'é¢„æˆæƒ', 
        complete: 'é¢„æˆæƒå®Œæˆ', 
        sale: 'æ¶ˆè´¹', 
        void: 'é¢„æˆæƒå–æ¶ˆ', 
        refund: 'é€€æ¬¾'
    };
    const isVoid = state.mode === 'void' && state.voidType === 'full';
    const isPartial = state.mode === 'void' && state.voidType === 'partial';
    const isComplete = state.mode === 'complete';
    
    let amountHtml = '';
    if (isVoid) {
        amountHtml = `<div style="margin: 4px 0; font-size: 13px; color: #e74c3c;"><b>å…¨é¢å–æ¶ˆ Â¥${state.amount.toFixed(2)}</b></div>`;
    } else if (isPartial) {
        amountHtml = `
            <div style="margin: 4px 0; font-size: 12px;">åŸé¢„æˆæƒ: Â¥${state.preauthAmount.toFixed(2)}</div>
            <div style="margin: 4px 0; font-size: 13px; color: #ff9800;"><b>éƒ¨åˆ†å–æ¶ˆ: Â¥${state.amount.toFixed(2)}</b></div>
            <div style="margin: 4px 0; font-size: 11px; color: #666;">å‰©ä½™å†»ç»“: Â¥${(state.preauthAmount - state.amount).toFixed(2)}</div>
        `;
    } else if (isComplete) {
        amountHtml = `
            <div style="margin: 4px 0; font-size: 12px;">åŸé¢„æˆæƒ: Â¥${state.preauthAmount.toFixed(2)}</div>
            <div style="margin: 4px 0; font-size: 14px; color: #2196f3;"><b>ç»“ç®—é‡‘é¢: Â¥${state.amount.toFixed(2)}</b></div>
            <div style="margin: 4px 0; font-size: 11px; color: #27ae60;">è§£å†»å·®é¢: Â¥${(state.preauthAmount - state.amount).toFixed(2)}</div>
        `;
    } else {
        amountHtml = state.amount > 0 ? `<div style="margin: 4px 0; font-size: 14px;"><b>Â¥${state.amount.toFixed(2)}</b></div>` : '';
    }
    
    const icon = isVoid ? 'âŒ ' : isPartial ? 'âœ‚ï¸ ' : isComplete ? 'ğŸ’³ ' : '';
    
    receipt.innerHTML = `
        <div style="text-align: center; font-weight: bold; margin-bottom: 10px; border-bottom: 1px dashed #000; padding-bottom: 6px; font-size: 14px;">
            ${icon}ğŸ¨ æ ¼å…°å¾·å¤§é…’åº—
        </div>
        <div style="margin: 4px 0; font-size: 12px;"><b>${isPartial ? 'éƒ¨åˆ†é¢„æˆæƒå–æ¶ˆ' : (titles[state.mode] || 'äº¤æ˜“')}</b></div>
        <div style="margin: 4px 0; font-size: 11px;">${state.currentCard ? state.currentCard.replace(/(\d{4})\d{8}(\d{4})/, '$1 **** $2') : (state.selectedReceipt ? state.selectedReceipt.card : '')}</div>
        ${amountHtml}
        ${state.mode === 'auth' ? `<div style="margin: 4px 0; font-size: 12px; color: #d32f2f;">æˆæƒç :${state.authCode}</div>` : ''}
        <div style="font-size: 10px; color: #666; margin-top: 8px;">${new Date().toLocaleString()}</div>
    `;
    
    receipt.classList.add('show');
    setTimeout(() => receipt.classList.remove('show'), 5000);
}

function resetScreen() {
    state.step = 'idle';
    state.input = '';
    state.amount = 0;
    state.selectedReceipt = null;
    state.currentCard = null;
    state.currentCardCvv = null;
    state.voidType = 'full';
    
    document.getElementById('visaCard').classList.remove('active');
    document.getElementById('unionCard').classList.remove('active');
    document.getElementById('icSlot').classList.remove('highlight');
    document.getElementById('magSlot').classList.remove('highlight');
    document.getElementById('flowHint').style.display = 'none';
    
    updateScreen(`
        <div style="font-size: 18px; font-weight: bold; margin-bottom: 12px;">æ¬¢è¿ä½¿ç”¨</div>
        <div style="color: #555; font-size: 14px;">è¯·é€‰æ‹©äº¤æ˜“ç±»å‹</div>
    `);
}

function selectFunc(func) {
    const btn = event.target;
    document.querySelectorAll('.fkey').forEach(k => k.classList.remove('active'));
    btn.classList.add('active');
    
    const map = {auth: 0, complete: 1, void: 2, refund: 3, sale: 4};
    const sceneBtns = document.querySelectorAll('.scene-btn');
    if (sceneBtns[map[func]]) {
        sceneBtns[map[func]].click();
    }
}

function updateScreen(html) {
    document.getElementById('screenBody').innerHTML = html;
}

document.addEventListener('keydown', (e) => {
    if (e.repeat) return;
    if (e.key >= '0' && e.key <= '9') pressKey(e.key);
    if (e.key === 'Enter') pressKey('ENTER');
    if (e.key === 'Escape') pressKey('CANCEL');
    if (e.key === 'Backspace') pressKey('BACK');
});

// åˆå§‹åŒ– - é»˜è®¤æ¸…ç©ºçŠ¶æ€
initReceiptList();
initReceiptArchive();
</script>

</body>
</html>
