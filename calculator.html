<!DOCTYPE html>
<html lang="zh-CN">

<head>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-XST5BTZTEK');
</script>
    <style>
            body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
        }
        #content {
            padding: 20px;
            background-color: lightblue;
        }
        button {
            margin: 2px;
            padding: 1px 1px;
            font-size: 16px;
        }
      #capture {
            width: 300px;
            height: 200px;
            background-color: lightblue;
            padding: 10px;
            text-align: center;
            line-height: 200px;
            font-size: 24px;
        }
        canvas {
            display: none;
        }
        
        a {
            TEXT-DECORATION: none
        }

        #myChart {
            width: 100px;
            height: 100px;
        }

        .toast {
            visibility: hidden;
            min-width: 250px;
            margin-left: -55px;
            background-color: #6363638e;
            color: #fff;
            text-align: center;
            border-radius: 2px;
            position: fixed;
            z-index: 1;
            left: 50%;
            bottom: 30px;
            font-size: 14px;
        }

        .toast.show {
            visibility: visible;
            -webkit-animation: fadein 0.5s, fadeout 0.5s 2.5s;
            animation: fadein 0.5s, fadeout 0.5s 2.5s;
        }

        @-webkit-keyframes fadein {
            from {
                bottom: 0;
                opacity: 0;
            }

            to {
                bottom: 30px;
                opacity: 1;
            }
        }

        @keyframes fadein {
            from {
                bottom: 0;
                opacity: 0;
            }

            to {
                bottom: 30px;
                opacity: 1;
            }
        }

        @-webkit-keyframes fadeout {
            from {
                bottom: 30px;
                opacity: 1;
            }

            to {
                bottom: 0;
                opacity: 0;
            }
        }

        @keyframes fadeout {
            from {
                bottom: 30px;
                opacity: 1;
            }

            to {
                bottom: 0;
                opacity: 0;
            }
        }
    </style>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>留学/工作出境时长计算器</title>
    <style>
        .delayed-element {
            display: none;
            opacity: 0;
            transition: opacity 1s;
        }

        .show {
            display: block;
            opacity: 1;
        }

        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px;
            margin: 0;
        }

        .container {
            width: 90%;
            max-width: 600px;
            text-align: center;
        }

        .entry-group {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2px;
        }

        .entry-group label {
            width: 15%;
            padding: 1px;
            font-size: 16px;
            padding: 2px;
        }

        .entry-group input {
            width: 35%;
            padding: 10px;
            font-size: 16px;
            padding: 2px;
        }

        .entry-group button {
            width: 10%;
            padding: 10px;
            font-size: 16px;
            padding: 2px;
        }

       

        .results p {
            text-align: left;
            margin: 1px 0; /* 修改这个值来调整行间距 */
            
        }

        .total-duration {
            margin-top: 10px;
            font-size: 18px;
            font-weight: bold;
        }

        @media (max-width: 600px) {
            .entry-group {
                flex-direction: column;
                align-items: flex-start;
            }

            .entry-group label,
            .entry-group input,
            .entry-group button {
                width: 100%;
                margin-bottom: 10px;
            }

            .entry-group button {
                width: auto;
            }

            .results {
                text-align: left;
                font-weight:bold;

            }
        }
    </style>
    <!-- Include Firebase libraries -->
    <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-firestore.js"></script>
    <!-- Include Chart.js library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-XST5BTZTEK"></script>
  
</head>

<body>

    <div class="container">
        <h2 id="title">境外学习时长计算器</h2>
        <hr>
        <div class="total-duration" id="total-duration">您的总出境时长为: 0 天</div>
        <div class="results" id="results"></div>
        <div id="entry-container" class="results"></div>
    </div>
    <button class="results" onclick="addEntry()">+添加出入境记录</button>
    <canvas id="myChart"></canvas>

    <span id="info">适用于出国留学“境外学习时间”的计算。</span>
    <span id="info">例:上海的留学生落户政策，需满足境外学习时长：</span>
    <span id="phd">博士：大于360天</span>
    <span id="master">硕士：大于180天</span>
    <span id="bachelor">学士：大于720天</span>
    <button id="screenshotBtn">截图并保存本页</button>
    <p>如何查询出入境记录？📝<a href="http://gaj.gz.gov.cn/zwfw/ywtd/crjimmigration/crjzx/content/post_8876194.html">点击查看</a></p>
  
       <canvas id="canvas"></canvas>

    <p></p>
    <div class="delayed-element" id="delayedElement"></div>
    <div id="toast" class="toast">这是一个吐司提示</div>

    <script>
        // Firebase configuration
        var firebaseConfig = {
              apiKey: "AIzaSyCGQ1ZAhfD7pky4In-rXcStZPSTxe-fyzE",
  authDomain: "travel-duration-calculat-b511e.firebaseapp.com",
  projectId: "travel-duration-calculat-b511e",
  storageBucket: "travel-duration-calculat-b511e.appspot.com",
  messagingSenderId: "745521797119",
  appId: "1:745521797119:web:4258b69db047193eda79ca"
        };
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        var db = firebase.firestore();

        let entryCount = 0;
        let chart = null;

        function addEntry() {
            const entryContainer = document.getElementById('entry-container');
            const entryGroup = document.createElement('div');
            entryGroup.className = 'entry-group';
            entryGroup.innerHTML = `
                <label for="exit-date-${entryCount}">1.出境日期</label>
                <input type="date" id="exit-date-${entryCount}" placeholder="出境日期" oninput="handleExitDateChange(${entryCount})">
                <label for="entry-date-${entryCount}">2.入境日期</label>
                <input type="date" id="entry-date-${entryCount}" placeholder="入境日期" disabled oninput="calculateDurations()">
                <button onclick="removeEntry(${entryCount})">删除</button>
            `;
            entryContainer.appendChild(entryGroup);
            entryCount++;
            saveEntries();
        }

        function removeEntry(id) {
            const entryGroup = document.getElementById(`exit-date-${id}`).parentElement;
            entryGroup.remove();
            calculateDurations();
            saveEntries();
        }

        function handleExitDateChange(id) {
            const exitDateElem = document.getElementById(`exit-date-${id}`);
            const entryDateElem = document.getElementById(`entry-date-${id}`);
            entryDateElem.min = exitDateElem.value;
            entryDateElem.disabled = false;
            calculateDurations();
            saveEntries();
        }

        function checkOverlappingDates(dates) {
            for (let i = 0; i < dates.length; i++) {
                for (let j = i + 1; j < dates.length; j++) {
                    if (dates[i].end >= dates[j].start && dates[i].start <= dates[j].end) {
                        return true;
                    }
                }
            }
            return false;
        }

        function showToast(message) {
            const toast = document.getElementById("toast");
            toast.textContent = message;
            toast.className = "toast show";
            setTimeout(() => {
                toast.className = toast.className.replace("show", "");
            }, 4000);
        }

        function calculateDurations() {
    const resultsContainer = document.getElementById('results');
    const totalDurationElem = document.getElementById('total-duration');
    resultsContainer.innerHTML = '';
    let totalDays = 0;
    let yearlyDurations = {};
    let dates = [];

    for (let i = 0; i < entryCount; i++) {
        const exitDateElem = document.getElementById(`exit-date-${i}`);
        const entryDateElem = document.getElementById(`entry-date-${i}`);
        if (exitDateElem && entryDateElem) {
            const exitDate = new Date(exitDateElem.value);
            const entryDate = new Date(entryDateElem.value);
            if (!isNaN(exitDate) && !isNaN(entryDate) && entryDate > exitDate) {
                const duration = (entryDate - exitDate) / (1000 * 60 * 60 * 24);
                const exitYear = exitDate.getFullYear();
                const entryYear = entryDate.getFullYear();
                
                for (let year = exitYear; year <= entryYear; year++) {
                    let daysInYear = 0;
                    if (year === exitYear && year === entryYear) {
                        daysInYear = duration;
                    } else if (year === exitYear) {
                        daysInYear = (new Date(`${exitYear}-12-31`) - exitDate) / (1000 * 60 * 60 * 24) + 1;
                    } else if (year === entryYear) {
                        daysInYear = (entryDate - new Date(`${entryYear}-01-01`)) / (1000 * 60 * 60 * 24) + 1;
                    } else {
                        daysInYear = (new Date(`${year}-12-31`) - new Date(`${year}-01-01`)) / (1000 * 60 * 60 * 24) + 1;
                    }

                    if (!yearlyDurations[year]) {
                        yearlyDurations[year] = 0;
                    }
                    yearlyDurations[year] += daysInYear;
                }

                resultsContainer.innerHTML += `<p>从 ${exitDate.toISOString().split('T')[0]} 到 ${entryDate.toISOString().split('T')[0]}：${duration} 天</p>`;
                totalDays += duration;
                dates.push({ start: exitDate, end: entryDate });
            } else if (entryDate <= exitDate) {
                resultsContainer.innerHTML += `<p style="color: red;">入境日期须晚于出境日期</p>`;
                showToast("入境日期须晚于出境日期");
            }
        }
    }

    if (checkOverlappingDates(dates)) {
        resultsContainer.innerHTML += `<p style="color: red;">警告：存在日期重叠！请检查输入的出入境记录。</p>`;
        showToast("警告：存在日期重叠！请检查输入的出入境记录。");
    }

    totalDurationElem.innerHTML = `您的总出境时长：${totalDays} 天`;

    saveEntries();
    if (totalDays > 0 && !checkOverlappingDates(dates)) {
        displayYearlyChart(yearlyDurations);
    }

    return totalDays; // 返回总出境时长
}

        function saveEntries() {
            const entries = [];
            for (let i = 0; i < entryCount; i++) {
                const exitDateElem = document.getElementById(`exit-date-${i}`);
                const entryDateElem = document.getElementById(`entry-date-${i}`);
                if (exitDateElem && entryDateElem) {
                    entries.push({
                        exitDate: exitDateElem.value,
                        entryDate: entryDateElem.value
                    });
                }
            }
            localStorage.setItem('entries', JSON.stringify(entries));
        }

        function loadEntries() {
            const entries = JSON.parse(localStorage.getItem('entries')) || [];
            entries.forEach((entry, index) => {
                const entryContainer = document.getElementById('entry-container');
                const entryGroup = document.createElement('div');
                entryGroup.className = 'entry-group';
                entryGroup.innerHTML = `
                    <label for="exit-date-${index}">1.出境日期</label>
                    <input type="date" id="exit-date-${index}" value="${entry.exitDate}" placeholder="出境日期" oninput="handleExitDateChange(${index})">
                    <label for="entry-date-${index}">2.入境日期</label>
                    <input type="date" id="entry-date-${index}" value="${entry.entryDate}" placeholder="入境日期" oninput="calculateDurations()">
                    <button onclick="removeEntry(${index})">删除</button>
                `;
                entryContainer.appendChild(entryGroup);
                entryCount = entries.length;
            });
            calculateDurations();
        }

function saveToFirestore(totalDays) {
    const entries = JSON.parse(localStorage.getItem('entries')) || [];
    if (entries.every(entry => entry.exitDate && entry.entryDate)) {
        fetch('https://ipapi.co/json/')
            .then(response => response.json())
            .then(data => {
                const city = data.city || 'Unknown';
                const ip = data.ip || 'Unknown';
                const userData = {
                    totalDuration: totalDays,
                    entries: entries,
                    ip: ip,
                    location: city
                };
                db.collection("users").add(userData)
                    .then((docRef) => {
                        console.log("Document written with ID: ", docRef.id);
                        updateCityChart(city);
                    })
                    .catch((error) => {
                        console.error("Error adding document: ", error);
                    });
            })
            .catch(error => console.error('Error fetching IP info:', error));
    }
}
document.getElementById('screenshotBtn').addEventListener('click', function() {
    const totalDays = calculateDurations();
    if (totalDays > 0) {
        saveToFirestore(totalDays); // 在截图前保存到Firestore
    }

    // 添加延迟，确保所有元素都已经渲染完毕
    setTimeout(() => {
        html2canvas(document.body, {
            scrollX: 0,
            scrollY: 0,
            width: document.body.scrollWidth,
            height: document.body.scrollHeight,
            useCORS: true // 使用 CORS 选项
        }).then(function(canvas) {
            var imgData = canvas.toDataURL("image/png");

            var now = new Date();
            var year = now.getFullYear();
            var month = String(now.getMonth() + 1).padStart(2, '0');
            var day = String(now.getDate()).padStart(2, '0');
            var hours = String(now.getHours()).padStart(2, '0');
            var minutes = String(now.getMinutes()).padStart(2, '0');
            var seconds = String(now.getSeconds()).padStart(2, '0');
            var formattedTime = `${year}${month}${day}_${hours}${minutes}${seconds}`;
            var filename = `screenshot_${formattedTime}.png`;

            var link = document.createElement('a');
            link.href = imgData;
            link.download = filename;
            link.click();
        }).catch(function(error) {
            console.error('截图失败:', error);
        });
    }, 1000); // 0.5秒延迟
});




function saveToFirestore(totalDays) {
    const entries = JSON.parse(localStorage.getItem('entries')) || [];
    if (entries.every(entry => entry.exitDate && entry.entryDate)) {
        fetch('https://ipapi.co/json/')
            .then(response => response.json())
            .then(data => {
                const city = data.city || 'Unknown';
                const ip = data.ip || 'Unknown';
                const userData = {
                    totalDuration: totalDays,
                    entries: entries,
                    ip: ip,
                    location: city
                };
                db.collection("users").add(userData)
                    .then((docRef) => {
                        console.log("Document written with ID: ", docRef.id);
                        updateCityChart(city);
                    })
                    .catch((error) => {
                        console.error("Error adding document: ", error);
                    });
            })
            .catch(error => console.error('Error fetching IP info:', error));
    }
}

function displayYearlyChart(yearlyDurations) {
    const ctx = document.getElementById('myChart').getContext('2d');
    document.getElementById('myChart').style.display = 'block'; // 确保 canvas 元素可见
    if (chart) {
        chart.destroy();
    }
    chart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: Object.keys(yearlyDurations),
            datasets: [{
                label: '每年境外时间 (天)',
                data: Object.values(yearlyDurations),
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 1
            }]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

        window.onload = function () {
            loadEntries(); // 加载本地存储的记录
        }
    </script>

</body>

</html>
