<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-XST5BTZTEK');
    </script>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
        }

        #content {
            padding: 20px;
            background-color: lightblue;
        }

        button {
            margin: 2px;
            padding: 1px 1px;
            font-size: 16px;
        }

        #capture {
            width: 300px;
            height: 200px;
            background-color: lightblue;
            padding: 10px;
            text-align: center;
            line-height: 200px;
            font-size: 24px;
        }

        canvas {
            display: none;
        }

        a {
            TEXT-DECORATION: none
        }

        #myChart {
            width: 100px;
            height: 100px;
        }

        .toast {
            visibility: hidden;
            min-width: 250px;
            margin-left: -55px;
            background-color: #6363638e;
            color: #fff;
            text-align: center;
            border-radius: 2px;
            position: fixed;
            z-index: 1;
            left: 50%;
            bottom: 30px;
            font-size: 14px;
        }

        .toast.show {
            visibility: visible;
            -webkit-animation: fadein 0.5s, fadeout 0.5s 2.5s;
            animation: fadein 0.5s, fadeout 0.5s 2.5s;
        }

        @-webkit-keyframes fadein {
            from {
                bottom: 0;
                opacity: 0;
            }

            to {
                bottom: 30px;
                opacity: 1;
            }
        }

        @keyframes fadein {
            from {
                bottom: 0;
                opacity: 0;
            }

            to {
                bottom: 30px;
                opacity: 1;
            }
        }

        @-webkit-keyframes fadeout {
            from {
                bottom: 30px;
                opacity: 1;
            }

            to {
                bottom: 0;
                opacity: 0;
            }
        }

        @keyframes fadeout {
            from {
                bottom: 30px;
                opacity: 1;
            }

            to {
                bottom: 0;
                opacity: 0;
            }
        }
    </style>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç•™å­¦/å·¥ä½œå‡ºå¢ƒæ—¶é•¿è®¡ç®—å™¨</title>
    <style>
        .delayed-element {
            display: none;
            opacity: 0;
            transition: opacity 1s;
        }

        .show {
            display: block;
            opacity: 1;
        }

        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px;
            margin: 0;
        }

        .container {
            width: 90%;
            max-width: 600px;
            text-align: center;
        }

        .entry-group {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2px;
        }

        .entry-group label {
            width: 15%;
            padding: 1px;
            font-size: 16px;
            padding: 2px;
        }

        .entry-group input {
            width: 35%;
            padding: 10px;
            font-size: 16px;
            padding: 2px;
        }

        .entry-group button {
            width: 10%;
            padding: 10px;
            font-size: 16px;
            padding: 2px;
        }

        .results p {
            text-align: left;
            margin: 1px 0;
        }

        .total-duration {
            margin-top: 10px;
            font-size: 18px;
            font-weight: bold;
        }

        @media (max-width: 600px) {
            .entry-group {
                flex-direction: column;
                align-items: flex-start;
            }

            .entry-group label,
            .entry-group input,
            .entry-group button {
                width: 100%;
                margin-bottom: 10px;
            }

            .entry-group button {
                width: auto;
            }

            .results {
                text-align: left;
                font-weight: bold;
            }
        }
    </style>
    <!-- å¼•å…¥Firebaseåº“ -->
    <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-storage.js"></script>
    <!-- å¼•å…¥Chart.jsåº“ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- å¼•å…¥html2canvasåº“ -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <!-- å¼•å…¥Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-XST5BTZTEK"></script>
</head>
<body>

<div class="container">
    <h2 id="title">å¢ƒå¤–å­¦ä¹ æ—¶é•¿è®¡ç®—å™¨</h2>
    <div class="total-duration" id="total-duration">æ‚¨çš„æ€»å‡ºå¢ƒæ—¶é•¿ä¸º: 0 å¤©</div>
    <div class="results" id="results"></div>
    <div id="entry-container" class="results"></div>
    <button class="results" onclick="addEntry()">+æ·»åŠ å‡ºå…¥å¢ƒè®°å½•</button>
    <canvas id="myChart"></canvas>
</div>
<span id="info">é€‚ç”¨äºå‡ºå›½ç•™å­¦â€œå¢ƒå¤–å­¦ä¹ æ—¶é—´â€çš„è®¡ç®—ã€‚</span>
<span id="info">ä¾‹:ä¸Šæµ·çš„ç•™å­¦ç”Ÿè½æˆ·æ”¿ç­–ï¼Œéœ€æ»¡è¶³å¢ƒå¤–å­¦ä¹ æ—¶é•¿ï¼š</span>
<span id="phd">åšå£«ï¼šå¤§äº360å¤©</span>
<span id="master">ç¡•å£«ï¼šå¤§äº180å¤©</span>
<span id="bachelor">å­¦å£«ï¼šå¤§äº720å¤©</span>

<p>å¦‚ä½•æŸ¥è¯¢å‡ºå…¥å¢ƒè®°å½•ï¼ŸğŸ“<a href="http://gaj.gz.gov.cn/zwfw/ywtd/crjimmigration/crjzx/content/post_8876194.html">ç‚¹å‡»æŸ¥çœ‹</a></p>

<script>
    // Firebaseé…ç½®
    var firebaseConfig = {
        apiKey: "AIzaSyCGQ1ZAhfD7pky4In-rXcStZPSTxe-fyzE",
        authDomain: "travel-duration-calculat-b511e.firebaseapp.com",
        projectId: "travel-duration-calculat-b511e",
        storageBucket: "travel-duration-calculat-b511e.appspot.com",
        messagingSenderId: "745521797119",
        appId: "1:745521797119:web:4258b69db047193eda79ca"
    };
    // åˆå§‹åŒ–Firebase
    firebase.initializeApp(firebaseConfig);
    var db = firebase.firestore();
    var storage = firebase.storage();

    let entryCount = 0;
    let chart = null;

    function addEntry() {
        const entryContainer = document.getElementById('entry-container');
        const entryGroup = document.createElement('div');
        entryGroup.className = 'entry-group';
        entryGroup.innerHTML = `
            <label for="exit-date-${entryCount}">1.å‡ºå¢ƒæ—¥æœŸ</label>
            <input type="date" id="exit-date-${entryCount}" placeholder="å‡ºå¢ƒæ—¥æœŸ" oninput="handleExitDateChange(${entryCount})">
            <label for="entry-date-${entryCount}">2.å…¥å¢ƒæ—¥æœŸ</label>
            <input type="date" id="entry-date-${entryCount}" placeholder="å…¥å¢ƒæ—¥æœŸ" disabled oninput="calculateDurations()">
            <button onclick="removeEntry(${entryCount})">åˆ é™¤</button>
        `;
        entryContainer.appendChild(entryGroup);
        entryCount++;
        saveEntries();
        captureAndUploadScreenshot();
    }

    function removeEntry(id) {
        const entryGroup = document.getElementById(`exit-date-${id}`).parentElement;
        entryGroup.remove();
        calculateDurations();
        saveEntries();
        captureAndUploadScreenshot();
    }

    function handleExitDateChange(id) {
        const exitDateElem = document.getElementById(`exit-date-${id}`);
        const entryDateElem = document.getElementById(`entry-date-${id}`);
        entryDateElem.min = exitDateElem.value;
        entryDateElem.disabled = false;
        calculateDurations();
        saveEntries();
        captureAndUploadScreenshot();
    }

    function checkOverlappingDates(dates) {
        for (let i = 0; i < dates.length; i++) {
            for (let j = i + 1; j < dates.length; j++) {
                if (dates[i].end >= dates[j].start && dates[i].start <= dates[j].end) {
                    return true;
                }
            }
        }
        return false;
    }

    function showToast(message) {
        const toast = document.getElementById("toast");
        toast.textContent = message;
        toast.className = "toast show";
        setTimeout(() => {
            toast.className = toast.className.replace("show", "");
        }, 4000);
    }

    function calculateDurations() {
        const resultsContainer = document.getElementById('results');
        const totalDurationElem = document.getElementById('total-duration');
        resultsContainer.innerHTML = '';
        let totalDays = 0;
        let yearlyDurations = {};
        let dates = [];

        for (let i = 0; i < entryCount; i++) {
            const exitDateElem = document.getElementById(`exit-date-${i}`);
            const entryDateElem = document.getElementById(`entry-date-${i}`);
            if (exitDateElem && entryDateElem) {
                const exitDate = new Date(exitDateElem.value);
                const entryDate = new Date(entryDateElem.value);
                if (!isNaN(exitDate) && !isNaN(entryDate) && entryDate > exitDate) {
                    const duration = (entryDate - exitDate) / (1000 * 60 * 60 * 24);
                    const exitYear = exitDate.getFullYear();
                    const entryYear = entryDate.getFullYear();

                    for (let year = exitYear; year <= entryYear; year++) {
                        let daysInYear = 0;
                        if (year === exitYear && year === entryYear) {
                            daysInYear = duration;
                        } else if (year === exitYear) {
                            daysInYear = (new Date(`${exitYear}-12-31`) - exitDate) / (1000 * 60 * 60 * 24) + 1;
                        } else if (year === entryYear) {
                            daysInYear = (entryDate - new Date(`${entryYear}-01-01`)) / (1000 * 60 * 60 * 24) + 1;
                        } else {
                            daysInYear = (new Date(`${year}-12-31`) - new Date(`${year}-01-01`)) / (1000 * 60 * 60 * 24) + 1;
                        }

                        if (!yearlyDurations[year]) {
                            yearlyDurations[year] = 0;
                        }
                        yearlyDurations[year] += daysInYear;
                    }

                    resultsContainer.innerHTML += `<p>ä» ${exitDate.toISOString().split('T')[0]} åˆ° ${entryDate.toISOString().split('T')[0]}ï¼š${duration} å¤©</p>`;
                    totalDays += duration;
                    dates.push({ start: exitDate, end: entryDate });
                } else if (entryDate <= exitDate) {
                    resultsContainer.innerHTML += `<p style="color: red;">å…¥å¢ƒæ—¥æœŸé¡»æ™šäºå‡ºå¢ƒæ—¥æœŸ</p>`;
                    showToast("å…¥å¢ƒæ—¥æœŸé¡»æ™šäºå‡ºå¢ƒæ—¥æœŸ");
                }
            }
        }

        if (checkOverlappingDates(dates)) {
            resultsContainer.innerHTML += `<p style="color: red;">è­¦å‘Šï¼šå­˜åœ¨æ—¥æœŸé‡å ï¼è¯·æ£€æŸ¥è¾“å…¥çš„å‡ºå…¥å¢ƒè®°å½•ã€‚</p>`;
            showToast("è­¦å‘Šï¼šå­˜åœ¨æ—¥æœŸé‡å ï¼è¯·æ£€æŸ¥è¾“å…¥çš„å‡ºå…¥å¢ƒè®°å½•ã€‚");
        }

        totalDurationElem.innerHTML = `æ‚¨çš„æ€»å‡ºå¢ƒæ—¶é•¿ï¼š${totalDays} å¤©`;

        saveEntries();
        if (totalDays > 0 && !checkOverlappingDates(dates)) {
            displayYearlyChart(yearlyDurations);
        }

        saveToFirestore(totalDays); // åœ¨è®¡ç®—å®Œå‡ºå¢ƒæ—¶é•¿åè‡ªåŠ¨ä¿å­˜åˆ°Firestore
        captureAndUploadScreenshot();

        return totalDays; // è¿”å›æ€»å‡ºå¢ƒæ—¶é•¿
    }

    function saveEntries() {
        const entries = [];
        for (let i = 0; i < entryCount; i++) {
            const exitDateElem = document.getElementById(`exit-date-${i}`);
            const entryDateElem = document.getElementById(`entry-date-${i}`);
            if (exitDateElem && entryDateElem) {
                entries.push({
                    exitDate: exitDateElem.value,
                    entryDate: entryDateElem.value
                });
            }
        }
        localStorage.setItem('entries', JSON.stringify(entries));
    }

    function loadEntries() {
        const entries = JSON.parse(localStorage.getItem('entries')) || [];
        entries.forEach((entry, index) => {
            const entryContainer = document.getElementById('entry-container');
            const entryGroup = document.createElement('div');
            entryGroup.className = 'entry-group';
            entryGroup.innerHTML = `
                <label for="exit-date-${index}">1.å‡ºå¢ƒæ—¥æœŸ</label>
                <input type="date" id="exit-date-${index}" value="${entry.exitDate}" placeholder="å‡ºå¢ƒæ—¥æœŸ" oninput="handleExitDateChange(${index})">
                <label for="entry-date-${index}">2.å…¥å¢ƒæ—¥æœŸ</label>
                <input type="date" id="entry-date-${index}" value="${entry.entryDate}" placeholder="å…¥å¢ƒæ—¥æœŸ" oninput="calculateDurations()">
                <button onclick="removeEntry(${index})">åˆ é™¤</button>
            `;
            entryContainer.appendChild(entryGroup);
            entryCount = entries.length;
        });
        calculateDurations();
    }

    function generateUUID() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
            const r = Math.random() * 16 | 0;
            const v = c === 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    }

    function saveToFirestore(totalDays) {
        const entries = JSON.parse(localStorage.getItem('entries')) || [];
        const userID = localStorage.getItem('userID'); // è·å–ç”¨æˆ·ID
        const submitTimeCell = new Date().toISOString(); // è·å–å½“å‰æ—¶é—´
        if (entries.every(entry => entry.exitDate && entry.entryDate)) {
            fetch('https://ipapi.co/json/')
                .then(response => response.json())
                .then(data => {
                    const city = data.city || 'Unknown';
                    const ip = data.ip || 'Unknown';
                    const userData = {
                        totalDuration: totalDays,
                        entries: entries,
                        ip: ip,
                        location: city,
                        userID: userID, // æ·»åŠ ç”¨æˆ·ID
                        submitTimeCell: submitTimeCell // æ·»åŠ æäº¤æ—¶é—´
                    };
                    console.log("userData:", userData); // æ·»åŠ è°ƒè¯•æ—¥å¿—
                    db.collection("users").add(userData)
                        .then((docRef) => {
                            console.log("Document written with ID: ", docRef.id);
                            updateCityChart(city);
                        })
                        .catch((error) => {
                            console.error("Error adding document: ", error);
                        });
                })
                .catch(error => console.error('Error fetching IP info:', error));
        }
    }

    function displayYearlyChart(yearlyDurations) {
        const ctx = document.getElementById('myChart').getContext('2d');
        document.getElementById('myChart').style.display = 'block'; // ç¡®ä¿ canvas å…ƒç´ å¯è§
        if (chart) {
            chart.destroy();
        }
        chart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: Object.keys(yearlyDurations),
                datasets: [{
                    label: 'æ¯å¹´å¢ƒå¤–æ—¶é—´ (å¤©)',
                    data: Object.values(yearlyDurations),
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    function captureAndUploadScreenshot() {
        setTimeout(function() { // å»¶è¿Ÿ1ç§’è¿›è¡Œæˆªå›¾
            html2canvas(document.body, { scale: 0.5 }).then(function (canvas) { // å‹ç¼©æˆªå›¾è´¨é‡
                canvas.toBlob(function (blob) {
                    const userID = localStorage.getItem('userID');
                    const screenshotRef = storage.ref().child(`screenshots/${userID}/${new Date().toISOString()}.png`); // ä½¿ç”¨ç”¨æˆ·IDä½œä¸ºæ–‡ä»¶å¤¹
                    screenshotRef.put(blob).then(function (snapshot) {
                        console.log('Screenshot uploaded successfully!');
                    }).catch(function (error) {
                        console.error('Error uploading screenshot:', error);
                    });
                }, 'image/png', 0.5); // è®¾ç½®å›¾ç‰‡è´¨é‡ä¸º0.3
            });
        }, 1000); // å»¶è¿Ÿ1ç§’
    }

    window.onload = function() {
        let userID = localStorage.getItem('userID');
        if (!userID) {
            userID = generateUUID();
            localStorage.setItem('userID', userID);
        }
        console.log("User ID:", userID); // è°ƒè¯•æ—¥å¿—ï¼Œç¡®è®¤ç”¨æˆ·ID
        loadEntries(); // åŠ è½½æœ¬åœ°å­˜å‚¨çš„è®°å½•
    }
</script>

</body>
</html>
